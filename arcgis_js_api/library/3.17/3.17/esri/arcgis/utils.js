// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.17/esri/copyright.txt for details.
//>>built
define("esri/arcgis/utils","require dojo/_base/lang dojo/_base/array dojo/_base/connect dojo/_base/Deferred dojo/_base/json dojo/_base/url dojo/on dojo/DeferredList dojo/dom-construct dojo/sniff ../kernel ../config ../lang ../request ../SpatialReference ../map ../urlUtils ../geometry/ScreenPoint ../geometry/Extent ../geometry/webMercatorUtils ../symbols/jsonUtils ../renderers/jsonUtils ../dijit/PopupTemplate ../dijit/Popup ../tasks/query ../tasks/GeometryService ../layers/ArcGISTiledMapServiceLayer ../layers/FeatureLayer dojo/i18n!../nls/jsapi".split(" "),
function(I,n,k,t,q,J,xb,ia,C,yb,Ea,G,K,l,z,B,zb,Fa,Ga,D,Ab,E,H,Ha,Bb,Cb,Db,Eb,u,ja){function F(a){return z({url:r.arcgisUrl+"/"+a.itemId+"/data",content:{f:"json"},callbackParamName:"callback"},{disableIdentityLookup:!0,_preLookup:!0})}function ka(a,e){var d={f:"json"};e&&(d.token=e);return z({url:a,content:d,callbackParamName:"callback"},{disableIdentityLookup:!0})}function la(a){if(a.layerDefinition&&(!a.layerDefinition.drawingInfo||!a.layerDefinition.drawingInfo.labelingInfo))a.showLabels=!1;a.itemProperties.layerDefinition&&
(a.layerDefinition?(a.layerDefinition.drawingInfo||(a.layerDefinition.drawingInfo=a.itemProperties.layerDefinition.drawingInfo),l.isDefined(a.layerDefinition.definitionExpression)||(a.layerDefinition.definitionExpression=a.itemProperties.layerDefinition.definitionExpression),l.isDefined(a.layerDefinition.minScale)||(a.layerDefinition.minScale=a.itemProperties.layerDefinition.minScale),l.isDefined(a.layerDefinition.maxScale)||(a.layerDefinition.maxScale=a.itemProperties.layerDefinition.maxScale)):
a.layerDefinition=a.itemProperties.layerDefinition);a.itemProperties.popupInfo&&(!a.popupInfo&&!a.disablePopup)&&(a.popupInfo=a.itemProperties.popupInfo);l.isDefined(a.itemProperties.showLabels)&&!l.isDefined(a.showLabels)&&(a.showLabels=a.itemProperties.showLabels);l.isDefined(a.itemProperties.showLegend)&&!l.isDefined(a.showLegend)&&(a.showLegend=a.itemProperties.showLegend);l.isDefined(a.itemProperties.refreshInterval)&&!l.isDefined(a.refreshInterval)&&(a.refreshInterval=a.itemProperties.refreshInterval)}
function Ia(a){la(a);a.itemProperties.layerDefinition&&a.layerDefinition&&(!l.isDefined(a.layerDefinition.maximumTrackPoints)&&l.isDefined(a.itemProperties.layerDefinition.maximumTrackPoints)&&(a.layerDefinition.maximumTrackPoints=a.itemProperties.layerDefinition.maximumTrackPoints),!a.layerDefinition.definitionGeometry&&a.itemProperties.layerDefinition.definitionGeometry&&(a.layerDefinition.definitionGeometry=a.itemProperties.layerDefinition.definitionGeometry));a.itemProperties.purgeOptions&&!a.purgeOptions&&
(a.purgeOptions=a.itemProperties.purgeOptions)}function L(a,e){var d=new q,c=a.itemData,b=[],g=[];k.forEach(c.operationalLayers,function(a){if(a.itemId&&!a.type){var f=a.url.toLowerCase();-1<f.indexOf("/featureserver")||-1<f.indexOf("/mapserver/")?(g.push(a),b.push(F(a))):-1<f.indexOf("/mapserver")&&-1===f.indexOf("/mapserver/")&&(!a.layers||!l.isDefined(a.minScale)&&!l.isDefined(a.maxScale))?(g.push(a),b.push(F(a))):-1<f.indexOf("/imageserver")&&!l.isDefined(a.minScale)&&!l.isDefined(a.maxScale)?
(g.push(a),b.push(F(a))):-1<f.indexOf("/streamserver")&&(g.push(a),b.push(F(a)))}});c.baseMap&&c.baseMap.baseMapLayers&&k.forEach(c.baseMap.baseMapLayers,function(a){a.itemId&&"VectorTileLayer"!==a.layerType&&(g.push(a),b.push(F(a)))});if(0<b.length){var f={};(new C(b)).addCallback(function(c){k.forEach(g,function(a,d){var b=c[d][1];if(b&&!(b instanceof Error)&&(f[a.itemId]=b,!a.type)){var g=a.url.toLowerCase();if((-1<g.indexOf("/featureserver")||-1<g.indexOf("/mapserver/"))&&b.layers)k.forEach(b.layers,
function(b){if(g.match("/featureserver/"+b.id+"$")=="/featureserver/"+b.id||g.match("/mapserver/"+b.id+"$")=="/mapserver/"+b.id)a.itemProperties=b,la(a)});else if(-1<g.indexOf("/streamserver"))a.itemProperties=b,Ia(a);else if(-1<g.indexOf("/mapserver"))b.layers&&!a.layers&&(a.layers=b.layers),l.isDefined(b.minScale)&&!l.isDefined(a.minScale)&&(a.minScale=b.minScale),l.isDefined(b.maxScale)&&!l.isDefined(a.maxScale)&&(a.maxScale=b.maxScale),l.isDefined(b.refreshInterval)&&!l.isDefined(a.refreshInterval)&&
(a.refreshInterval=b.refreshInterval),b.visibleLayers&&!a.visibleLayers&&(a.visibleLayers=b.visibleLayers);else if(-1<g.indexOf("/imageserver")&&(l.isDefined(b.minScale)&&!l.isDefined(a.minScale)&&(a.minScale=b.minScale),l.isDefined(b.maxScale)&&!l.isDefined(a.maxScale)&&(a.maxScale=b.maxScale),l.isDefined(b.refreshInterval)&&!l.isDefined(a.refreshInterval)&&(a.refreshInterval=b.refreshInterval),b.popupInfo&&(!a.popupInfo&&!a.disablePopup)&&(a.popupInfo=b.popupInfo),b.renderingRule&&!a.renderingRule&&
(a.renderingRule=b.renderingRule,b.renderingRule.functionName&&(a.renderingRule.rasterFunction=b.renderingRule.functionName)),b.bandIds&&!a.bandIds&&(a.bandIds=b.bandIds),b.mosaicRule&&!a.mosaicRule&&(a.mosaicRule=b.mosaicRule),b.format&&!a.format&&(a.format=b.format),l.isDefined(b.compressionQuality)&&!l.isDefined(a.compressionQuality)&&(a.compressionQuality=b.compressionQuality),b.layerDefinition&&b.layerDefinition.definitionExpression&&(!l.isDefined(a.layerDefinition)||!l.isDefined(a.layerDefinition.definitionExpression))))a.layerDefinition=
a.layerDefinition||{},a.layerDefinition.definitionExpression=b.layerDefinition.definitionExpression}});a.relatedItemsData=f;d.callback(a)})}else d.callback(a);return d}function Fb(a,e){var d=new q,c=a.itemData,b=c.baseMap.baseMapLayers[0];if("BingMapsAerial"===b.type||"BingMapsRoad"===b.type||"BingMapsHybrid"===b.type)if(b.portalUrl&&G.id)delete e.bingMapsKey,G.id.checkSignInStatus(Fa.urlToObject(r.arcgisUrl).path).then(n.hitch(null,function(a,c,d,g,e){ka(b.portalUrl,e.token).then(n.hitch(null,ma,
a,c,d,g),n.hitch(null,M,a,c,d,g))},a,e,c,d),n.hitch(null,function(a,c,d,g,e){ka(b.portalUrl).then(n.hitch(null,ma,a,c,d,g),n.hitch(null,M,a,c,d,g))},a,e,c,d));else if(e.bingMapsKey){var g=new w({bingMapsKey:e.bingMapsKey,mapStyle:w.MAP_STYLE_AERIAL});t.connect(g,"onLoad",n.hitch(this,function(){d.callback([a,e])}));t.connect(g,"onError",function(f){delete e.bingMapsKey;a.itemData=N(c);b=a.itemData.baseMap.baseMapLayers[0];b.errors=[];b.errors.push({message:"The owner of the application has not provided a valid Bing Key for the Bing Map it includes. Switching to Esri layers."});
d.callback([a,e])})}else a.itemData=N(c),b=a.itemData.baseMap.baseMapLayers[0],b.errors=[],b.errors.push({message:"The owner of the application has not provided a Bing Key for the Bing Map it includes. Switching to Esri layers."}),d.callback([a,e]);else d.callback([a,e]);return d}function Gb(a){var e=new q,d,c;a=a.itemData;var b=a.baseMap&&a.baseMap.baseMapLayers;if(Ea("ie")||na&&!na.supported())for(a=0;a<b.length;a++){var g=b[a];if(!g.isReference){"VectorTileLayer"===g.layerType&&(d=g.itemId,c=a);
break}}d?oa(d,!1).addBoth(function(a){var d=/^https?:\/\/basemaps(dev)?\.arcgis\.com\/arcgis\/rest\/services\/World_Basemap\/VectorTileServer/i;a&&(a.item&&d.test(a.item.url))&&(b[c]={id:"FB_"+g.id,layerType:"ArcGISTiledMapServiceLayer",opacity:"opacity"in g?g.opacity:1,visibility:"visibility"in g?g.visibility:!0,url:"http://services.arcgisonline.com/arcgis/rest/services/World_Street_Map/MapServer"});e.resolve()}):e.resolve();return e}function ma(a,e,d,c,b){b.bingKey?(e.bingMapsKey=b.bingKey,b=new w({bingMapsKey:e.bingMapsKey,
mapStyle:w.MAP_STYLE_AERIAL}),t.connect(b,"onLoad",n.hitch(this,function(){c.callback([a,e])})),t.connect(b,"onError",function(b){delete e.bingMapsKey;a.itemData=N(d);b=a.itemData.baseMap.baseMapLayers[0];b.errors=[];b.errors.push({message:"The owner of the map has not provided a valid Bing Key for the Bing Map it includes. Switching to Esri layers."});c.callback([a,e])})):M(a,e,d,c)}function M(a,e,d,c){delete e.bingMapsKey;a.itemData=N(d);d=a.itemData.baseMap.baseMapLayers[0];d.errors=[];d.errors.push({message:"The owner of the map has not provided a Bing Key for the Bing Map it includes. Switching to Esri layers."});
c.callback([a,e])}function N(a){a.baseMap="BingMapsAerial"===a.baseMap.baseMapLayers[0].type?{title:"Imagery",baseMapLayers:[{id:"World_Imagery_2017",visibility:!0,opacity:1,url:"http://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer"}]}:"BingMapsRoad"===a.baseMap.baseMapLayers[0].type?{title:"Streets",baseMapLayers:[{id:"World_Street_Map_8421",opacity:1,visibility:!0,url:"http://services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer"}]}:{title:"Imagery with Labels",
baseMapLayers:[{id:"World_Imagery_6611",opacity:1,visibility:!0,url:"http://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer"},{id:"World_Boundaries_and_Places_1145",isReference:!0,opacity:1,visibility:!0,url:"http://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer"}]};return a}function pa(a,e,d,c){var b=a.dynamicLayerInfos||a.layerInfos,g=e.layers;if(g&&b)if(c.usePopupManager){var f;k.forEach(b,function(a){var b=a.id;if(!a.subLayerIds)for(a=
0;a<g.length;a++){var c=g[a];if(c.id===b&&c.popupInfo){f||(f={});f[b]={infoTemplate:new d(c.popupInfo),layerUrl:c.layerUrl};break}}});f&&a.setInfoTemplates(f)}else{var h=[],m=[],v=[],p=[],s=[],Ja=[];k.forEach(b,function(b){var c=b.id;if(!b.subLayerIds&&-1!==k.indexOf(a.visibleLayers,c))for(b=0;b<g.length;b++){var d=g[b];if(d.id===c){m.push(c);h.push(d.popupInfo);v.push(d.layerUrl||"");d.layerDefinition&&d.layerDefinition.definitionExpression?p.push(d.layerDefinition.definitionExpression):p.push("");
s.push(l.isDefined(d.minScale)?d.minScale:null);Ja.push(l.isDefined(d.maxScale)?d.maxScale:null);break}}});h.length&&(a.__popups=h,a.__popupIds=m,a.__popupUrls=v,a.__popupWhereClauses=p,a.__popupMinScales=s,a.__popupMaxScales=Ja,a.__resourceInfo=e.resourceInfo)}}function Ka(a){if(!a)return!1;var e=(new xb(r.arcgisUrl)).authority;return-1!==a.indexOf(".arcgis.com/")||-1!==a.indexOf(e)}function La(a){return!a?!1:-1!==a.indexOf("/services.arcgisonline.com/")||-1!==a.indexOf("/server.arcgisonline.com/")}
function A(a){if("https:"===location.protocol&&(Ka(a)||La(a)))a=a.replace("http:","https:");return a}function qa(a,e,d){var c=[],b;a.displayLevels||(c=k.map(a.resourceInfo.tileInfo.lods,function(a){return a.level}));a.exclusionAreas&&(b=n.clone(a.exclusionAreas),b=k.map(b,function(a){a.geometry=new D(a.geometry);return a}));c=new Eb(A(a.url),{resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,displayLevels:a.displayLevels||c,id:a.id,minScale:a.minScale,maxScale:a.maxScale,refreshInterval:a.refreshInterval,
exclusionAreas:b});d.ignorePopups||pa(c,a,e,d);return c}function ra(a,e){if(!a||!e||0===e.length)return[];var d=","+e+",",c=[],b,g=",";for(b=0;b<a.length;b++)if(null!==a[b].subLayerIds){if(-1===d.indexOf(","+a[b].id+",")||-1<g.indexOf(","+a[b].id+","))g+=a[b].subLayerIds.toString()+","}else-1<d.indexOf(","+a[b].id+",")&&-1===g.indexOf(","+a[b].id+",")&&c.push(a[b].id);return c}function Ma(a,e,d){var c=new Na;c.format="png24";a.resourceInfo&&(a.resourceInfo.supportedImageFormatTypes&&-1<a.resourceInfo.supportedImageFormatTypes.indexOf("PNG32"))&&
(c.format="png32");var c=new Oa(A(a.url),{resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,id:a.id,imageParameters:c,minScale:a.minScale,maxScale:a.maxScale,refreshInterval:a.refreshInterval}),b=a.visibleLayers;if(!a.visibleLayers){var g="";k.forEach(c.layerInfos,function(a){a.defaultVisibility&&(g+=(0<g.length?",":"")+a.id)});b=g}if(a.layers&&0<a.layers.length){var f=[],h=[],m,v=[],p,s;k.forEach(a.layers,function(b){b.layerDefinition&&b.layerDefinition.definitionExpression&&(f[b.id]=
b.layerDefinition.definitionExpression);if(b.layerDefinition&&b.layerDefinition.source){m=null;s=b.layerDefinition.source;if("mapLayer"===s.type){var d=k.filter(a.resourceInfo.layers,function(a){return a.id===s.mapLayerId});d.length&&(m=n.mixin(d[0],b))}else m=n.mixin({},b);m&&(m.source=s,delete m.popupInfo,m=new Pa(m),a.visibleLayers&&(d="string"==typeof a.visibleLayers?a.visibleLayers.split(","):a.visibleLayers,-1<k.indexOf(d,b.id)?m.defaultVisibility=!0:m.defaultVisibility=!1),h.push(m))}b.layerDefinition&&
(b.layerDefinition.source&&b.layerDefinition.drawingInfo)&&(p=new Qa(b.layerDefinition.drawingInfo),v[b.id]=p)},this);0<f.length&&c.setLayerDefinitions(f);0<h.length?(c.setDynamicLayerInfos(h,!0),0<v.length&&c.setLayerDrawingOptions(v,!0)):(b=ra(c.layerInfos,b),c.setVisibleLayers(b))}else b=ra(c.layerInfos,b),c.setVisibleLayers(b);d.ignorePopups||pa(c,a,e,d);return c}function Hb(a,e,d){var c=new Ra;c.bandIds=a.bandIds;null!=a.format&&(c.format=a.format,null!=a.compressionQuality&&(c.compressionQuality=
a.compressionQuality));if(a.renderingRule&&a.renderingRule.rasterFunction){var b=new Sa(a.renderingRule);c.renderingRule=b}a.mosaicRule&&(b=new Ta(a.mosaicRule),c.mosaicRule=b);l.isDefined(a.noData)&&(c.noData=a.noData);l.isDefined(a.noDataInterpretation)&&(c.noDataInterpretation=a.noDataInterpretation);l.isDefined(a.interpolation)&&(c.interpolation=a.interpolation);b=a.layerType?"ArcGISImageServiceVectorLayer"===a.layerType:!1;l.isDefined(a.layerType)||(b=a.resourceInfo.hasMultidimensions&&("esriImageServiceDataTypeVector-UV"===
a.resourceInfo.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===a.resourceInfo.serviceDataType));c={resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,id:a.id,imageServiceParameters:c,minScale:a.minScale,maxScale:a.maxScale,refreshInterval:a.refreshInterval};c=b?new Ua(A(a.url),c):new Va(A(a.url),c);a.layerDefinition&&(a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.renderer&&(b=H.fromJson(a.layerDefinition.drawingInfo.renderer),c.setRenderer(b)),a.layerDefinition.definitionExpression&&
c.setDefinitionExpression(a.layerDefinition.definitionExpression,!0));!d.ignorePopups&&a.popupInfo&&c.setInfoTemplate(new e(a.popupInfo));return c}function sa(a,e,d){var c=[102113,102100,3857],b=d||new B(e[0].layerObject.fullExtent.spatialReference),g=new B(a.resourceInfo.fullExtent.spatialReference);return b.wkt==g.wkt&&(b.wkid==g.wkid||l.isDefined(b.latestWkid)&&b.latestWkid==g.wkid||l.isDefined(g.latestWkid)&&b.wkid==g.latestWkid||l.isDefined(b.latestWkid)&&b.latestWkid==g.latestWkid)||b.wkid&&
g.wkid&&k.some(c,function(a){return a===g.wkid})&&k.some(c,function(a){return a===b.wkid})?!0:!1}function ta(a,e,d){if(!e[0].layerObject.tileInfo)return!1;a=a.resourceInfo.tileInfo;e=e[0].layerObject.tileInfo;d=d.width>d.height?d.width:d.height;for(var c=!1,b=!1,g=0;g<a.lods.length;g++){for(var f=a.lods[g].scale/a.dpi,h=0;h<e.lods.length;h++){var m=e.lods[h].scale/e.dpi;if(Math.abs(m-f)/m<1/d)if(c){b=!0;break}else c=!0}if(b)break}return b||c&&(1===a.lods.length||1===e.lods.length)?!0:!1}function Wa(a,
e,d,c,b,g){var f,h,m=d._clazz;if("OpenStreetMap"===a.type)f=new Xa({id:a.id,opacity:a.opacity,visible:null!==a.visibility&&void 0!==a.visibility?a.visibility:!0});else if("WFS"===a.type)c={geometryType:a.layerDefinition.geometryType,id:a.id,labelingInfo:a.layerDefinition.drawingInfo.labelingInfo,maxFeatures:a.wfsInfo.maxFeatures,mode:a.mode,name:a.wfsInfo.name,showLabels:!0,swapXY:a.wfsInfo.swapXY,title:a.title,url:a.url,version:a.wfsInfo.version,visible:a.visibility,wkid:a.layerDefinition.spatialReference.wkid},
f=new Ya,f.fromJson(c,function(){l.isDefined(a.opacity)&&f.setOpacity(a.opacity);l.isDefined(a.visibility)&&f.setVisibility(a.visibility);(a.minScale||a.maxScale)&&f.setScaleRange(a.minScale,a.maxScale);f.renderer=H.fromJson(a.layerDefinition.drawingInfo.renderer);!d.ignorePopups&&a.popupInfo&&f.setInfoTemplate(new m(a.popupInfo));f.emit("fromJsonComplete")});else if("WMS"===a.type){var v=[],p=[];k.forEach(a.layers,function(a){p.push(new Za({name:a.name,title:a.title,legendURL:a.legendURL,queryable:a.queryable,
showPopup:a.showPopup}));v.push(a.name)},this);a.visibleLayers&&(v=a.visibleLayers);c={extent:new D(a.extent[0][0],a.extent[0][1],a.extent[1][0],a.extent[1][1],new B({wkid:4326})),layerInfos:p,version:a.version,maxWidth:a.maxWidth,maxHeight:a.maxHeight,featureInfoFormat:a.featureInfoFormat,getFeatureInfoURL:a.featureInfoUrl,getMapURL:a.mapUrl,spatialReferences:a.spatialReferences,title:a.title,copyright:a.copyright,minScale:a.minScale||0,maxScale:a.maxScale||0,format:a.format};f=new $a(a.url,{id:a.id,
visibleLayers:v,format:"png",transparent:a.firstLayer?!1:!0,opacity:a.opacity,visible:null!==a.visibility?a.visibility:!0,resourceInfo:c,refreshInterval:a.refreshInterval});f.spatialReference.wkid=c.spatialReferences[0]}else if("KML"===a.type){h=a.url;if(G.id){var s=G.id.findCredential(Fa.urlToObject(r.arcgisUrl).path);s&&(e=r.arcgisUrl.substring(r.arcgisUrl.indexOf("//")+2,r.arcgisUrl.indexOf("/",r.arcgisUrl.indexOf("//")+3)),b=e.split("."),b=b[b.length-2]+"."+b[b.length-1],g=h.indexOf(b),-1<g&&
(h="https://"+e+h.substring(g+b.length),h+="?token\x3d"+s.token))}f=new ab(h,{id:a.id,visible:null!==a.visibility?a.visibility:!0,outSR:c,refreshInterval:a.refreshInterval});t.connect(f,"onLoad",function(){(a.opacity||0===a.opacity)&&f.setOpacity(a.opacity);l.isDefined(a.minScale)&&l.isDefined(a.maxScale)&&f.setScaleRange(a.minScale,a.maxScale);a.visibleFolders&&k.forEach(f.folders,function(b){-1<k.indexOf(a.visibleFolders,b.id)?f.setFolderVisibility(b,!0):f.setFolderVisibility(b,!1)},this)})}else"WebTiledLayer"===
a.type?(f=new bb(a.templateUrl,{id:a.id,visible:null!==a.visibility?a.visibility:!0,opacity:a.opacity,copyright:a.copyright,fullExtent:a.fullExtent&&new D(a.fullExtent),initialExtent:a.fullExtent&&new D(a.fullExtent),subDomains:a.subDomains,tileInfo:a.tileInfo?new cb(a.tileInfo):null,refreshInterval:a.refreshInterval}),t.connect(f,"onLoad",function(){(l.isDefined(a.minScale)||l.isDefined(a.maxScale))&&f.setScaleRange(a.minScale,a.maxScale)})):"GeoRSS"===a.type?(f=new db(a.url,{id:a.id,opacity:a.opacity,
outSpatialReference:c,refreshInterval:a.refreshInterval}),t.connect(f,"onLoad",function(){!1===a.visibility&&f.hide();l.isDefined(a.minScale)&&l.isDefined(a.maxScale)&&f.setScaleRange(a.minScale,a.maxScale);var b=f.getFeatureLayers();k.forEach(b,function(d){a.pointSymbol&&"esriGeometryPoint"===d.geometryType?(d.renderer.symbol=E.fromJson(a.pointSymbol),1===b.length&&(f.pointSymbol=E.fromJson(a.pointSymbol))):a.lineSymbol&&"esriGeometryPolyline"===d.geometryType?(d.renderer.symbol=E.fromJson(a.lineSymbol),
1===b.length&&(f.polylineSymbol=E.fromJson(a.lineSymbol))):a.polygonSymbol&&"esriGeometryPolygon"===d.geometryType&&(d.renderer.symbol=E.fromJson(a.polygonSymbol),1===b.length&&(f.polygonSymbol=E.fromJson(a.polygonSymbol)))})})):"CSV"==a.type&&a.url?(c={layerDefinition:a.layerDefinition,columnDelimiter:a.columnDelimiter,id:a.id?a.id:null,visible:null!==a.visibility?a.visibility:!0,opacity:a.opacity,refreshInterval:a.refreshInterval},a.locationInfo&&(c.latitudeFieldName=a.locationInfo.latitudeFieldName,
c.longitudeFieldName=a.locationInfo.longitudeFieldName),d.ignorePopups||(c.infoTemplate=new Ha(a.popupInfo?a.popupInfo:eb.generateDefaultPopupInfo(a))),f=new fb(a.url,c)):"VectorTileLayer"===a.layerType&&a.styleUrl?f=new gb(a.styleUrl,{id:a.id,minScale:a.minScale,maxScale:a.maxScale,opacity:a.opacity,visible:a.visibility}):a.layerDefinition&&!a.url?(c=J.fromJson(J.toJson(a)),delete c.id,delete c.opacity,delete c.visibility,f=new u(c,{id:a.id,opacity:a.opacity,visible:a.visibility,outFields:["*"],
autoGeneralize:!0}),!d.ignorePopups&&c.popupInfo&&f.setInfoTemplate(new m(c.popupInfo)),hb(f)):"BingMapsAerial"===a.type||"BingMapsRoad"===a.type||"BingMapsHybrid"===a.type?d.bingMapsKey?(c=w.MAP_STYLE_AERIAL_WITH_LABELS,"BingMapsAerial"===a.type?c=w.MAP_STYLE_AERIAL:"BingMapsRoad"===a.type&&(c=w.MAP_STYLE_ROAD),f=new w({bingMapsKey:d.bingMapsKey,mapStyle:c,opacity:a.opacity,id:a.id}),t.connect(f,"onError",n.hitch(this,function(a){a.errors=a.errors||[];a.errors.push({message:"This application does not have a valid Bing Key for the Bing layer that is included in this map. [type:"+
a.type+"]"})},a))):(a.errors=a.errors||[],a.errors.push({message:"This application does not provide a Bing Key for the Bing layer that is included in this map. [type:"+a.type+"]"})):a.resourceInfo&&a.resourceInfo.mapName?f=!0===a.resourceInfo.singleFusedMapCache&&(a.baseMapLayer||sa(a,e,c)&&ta(a,b,g))?qa(a,m,d):Ma(a,m,d):a.resourceInfo&&a.resourceInfo.pixelSizeX?f=!0===a.resourceInfo.singleFusedMapCache&&(a.baseMapLayer||sa(a,e,c)&&ta(a,b,g))?qa(a,m,d):Hb(a,m,d):a.resourceInfo&&"Feature Layer"===
a.resourceInfo.type?(a.capabilities&&(a.resourceInfo.capabilities=a.capabilities),f=new u(A(a.url),{resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,id:a.id,mode:a.mode===u.MODE_SELECTION?u.MODE_SELECTION:u.MODE_AUTO,editable:!1===d.editable?!1:void 0,outFields:["*"],autoGeneralize:!0,refreshInterval:a.refreshInterval}),!d.ignorePopups&&a.popupInfo&&f.setInfoTemplate(new m(a.popupInfo)),a.layerDefinition&&(a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.renderer&&(c=
H.fromJson(a.layerDefinition.drawingInfo.renderer),c.isMaxInclusive=!0,f.setRenderer(c)),a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.labelingInfo&&(c=k.map(a.layerDefinition.drawingInfo.labelingInfo,function(a){return new ib(a)}),f.setLabelingInfo(c)),a.layerDefinition.definitionExpression&&f.setDefinitionExpression(a.layerDefinition.definitionExpression),l.isDefined(a.layerDefinition.minScale)&&f.setMinScale(a.layerDefinition.minScale),l.isDefined(a.layerDefinition.maxScale)&&f.setMaxScale(a.layerDefinition.maxScale)),
hb(f)):a.resourceInfo&&a.resourceInfo.streamUrls&&(c={resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,id:a.id},a.layerDefinition&&(s=a.layerDefinition.drawingInfo,a.layerDefinition.definitionGeometry&&(h=h||{},h.geometry=a.layerDefinition.definitionGeometry),l.isDefined(a.layerDefinition.definitionExpression)&&(h=h||{},h.where=a.layerDefinition.definitionExpression),l.isDefined(a.layerDefinition.maximumTrackPoints)&&(c.maximumTrackPoints=a.layerDefinition.maximumTrackPoints)),h&&
(c.filter=h),a.purgeOptions&&(c.purgeOptions=a.purgeOptions),f=new jb(A(a.url),c),s&&s.renderer&&(c=s.renderer,f.setRenderer(H.fromJson(c))),!d.ignorePopups&&a.popupInfo&&f.setInfoTemplate(new m(a.popupInfo)),a.layerDefinition&&(l.isDefined(a.layerDefinition.minScale)&&f.setMinScale(a.layerDefinition.minScale),l.isDefined(a.layerDefinition.maxScale)&&f.setMaxScale(a.layerDefinition.maxScale)),ia.once(f,"error",function(b){a.errors.push({message:"Error loading stream layer. Check websocket url"})}));
f&&(f.arcgisProps={title:a.title},a.baseMapLayer&&(a.isReference?(f.attr("data-reference",!0),f._basemapGalleryLayerType="reference"):f._basemapGalleryLayerType="basemap"));return f}function ua(a,e,d,c,b){k.forEach(a,function(f){f.layerObject=Wa(f,a,e,d,c,b)});var g=k.filter(a,function(a){return!a.isReference}),f=k.filter(a,function(a){return!!a.isReference});return a=g.concat(f)}function va(a){var e=null;a=a[0];a.url&&!a.type?a.resourceInfo.spatialReference&&(e=new B,a.resourceInfo.spatialReference.wkid&&
(e.wkid=a.resourceInfo.spatialReference.wkid),a.resourceInfo.spatialReference.wkt&&(e.wkt=a.resourceInfo.spatialReference.wkt)):a.type&&(-1<a.type.indexOf("BingMaps")||"OpenStreetMap"==a.type?e=new B({wkid:102100}):"WMS"==a.type&&(e=new B({wkid:a.spatialReferences[0]})));return e}function kb(a,e,d,c,b,g,f,h){k.forEach(e,function(b){b.url&&!b.type&&(b.resourceInfo=a[b.deferredsPos][1],delete b.deferredsPos)});g=g||va(e);e=ua(e,d,g,f,h);b.callback(e);return b}function hb(a){!window.CanvasRenderingContext2D&&
(a.renderer&&"esri.renderer.HeatmapRenderer"===a.renderer.declaredClass)&&a.setRenderer(H.fromJson({type:"simple",symbol:{color:[77,77,77,255],size:6,angle:0,xoffset:0,yoffset:0,type:"esriSMS",style:"esriSMSCircle",outline:{color:[255,255,255,255],width:0.75,type:"esriSLS",style:"esriSLSSolid"}}}))}function lb(a,e){var d=A(a);return z({url:d,content:{f:"json"},callbackParamName:"callback",error:function(a,b){a.message=a.message?a.message+(" [url:"+d+"]"):"[url:"+d+"]";e.push(a);K.defaults.io.errorHandler(a,
b)}})}function mb(a){var e=r.arcgisUrl+"/"+a.itemId+"/data";return z({url:e,content:{f:"json"},callbackParamName:"callback",error:function(d,c){d.message=d.message?d.message+(" [url:"+e+"]"):"[url:"+e+"]";a.errors=a.errors||[];a.errors.push(d);K.defaults.io.errorHandler(d,c)}})}function nb(a,e,d){var c=new q;if((!d.featureCollection||!d.featureCollection.layers)&&!d.layers)return console.log("Invalid Feature Collection item data [item id: "+a.itemId+"]: ",d),a.errors=a.errors||[],a.errors.push({message:"Invalid Feature Collection item data. [item id: "+
a.itemId+"]"}),c.errback(),c;d.layers&&(d.featureCollection={layers:d.layers},delete d.layers,l.isDefined(d.showLegend)&&(d.featureCollection.showLegend=d.showLegend,delete d.showLegend));ob(a,d.featureCollection,e).then(function(b){d.featureCollection=b;a.featureCollection&&a.featureCollection.layers?k.forEach(d.featureCollection.layers,function(b,d){var c=a.featureCollection.layers[d];if(!c.popupInfo&&!c.layerDefinition)c.popupInfo=b.popupInfo,c.layerDefinition=b.layerDefinition;else if(c.layerDefinition){if(l.isDefined(c.layerDefinition.minScale)&&
l.isDefined(c.layerDefinition.maxScale)&&(c.layerDefinition.minScale!==b.layerDefinition.minScale||c.layerDefinition.maxScale!==b.layerDefinition.maxScale))delete b.layerDefinition.minscale,delete b.layerDefinition.maxScale;c.layerDefinition.drawingInfo&&J.toJson(c.layerDefinition.drawingInfo)!==J.toJson(b.layerDefinition.drawingInfo)&&delete b.layerDefinition.drawingInfo;c.layerDefinition.showLegend!==b.layerDefinition.showLegend&&delete b.layerDefinition.showLegend;c.layerDefinition=n.mixin(c.layerDefinition,
b.layerDefinition)}else c.layerDefinition=b.layerDefinition;c.featureSet=b.featureSet;c.nextObjectId=b.nextObjectId}):(a.featureCollection=a.featureCollection||{},a.featureCollection=n.mixin(a.featureCollection,d.featureCollection));c.callback(a)});return c}function ob(a,e,d){var c=new q;I(["./csv"],function(b){var g=[];k.forEach(e.layers,function(a){a.featureSet&&(a.featureSet.features&&a.featureSet.features.length&&a.featureSet.features[0].geometry&&a.featureSet.features[0].geometry.spatialReference)&&
(a.deferredsPos=g.length,g.push(b.projectFeatureCollection(a,d,a.featureSet.features[0].geometry.spatialReference)))});(new C(g)).addCallback(function(){k.forEach(e.layers,function(b){l.isDefined(b.deferredsPos)&&(g[b.deferredsPos].results&&g[b.deferredsPos].results.length?b=g[b.deferredsPos].results[0]:(console.log("Errors projecting feature collection. ["+a.title+" - "+b.layerDefinition.name+"]"),b.errors=b.errors||[],b.errors.push({message:"Errors projecting feature collection. ["+a.title+" - "+
b.layerDefinition.name+"]"})),delete b.deferredsPos)});c.callback(e)})});return c}function O(a,e,d,c,b){var g=new q,f=new q,h=[],m;k.forEach(a.operationalLayers,function(a){a.itemId&&"Feature Collection"==a.type&&h.push(mb(a).then(n.hitch(null,nb,a,d)))});0===h.length?pb(a,e,d,c,f,b):(m=new C(h),m.addCallback(function(g){pb(a,e,d,c,f,b)}));f.then(function(a){h=[];k.forEach(a,function(a){var b;a=a.layerObject;a instanceof u&&!a.loaded&&!a.loadError?(b=new q,ia.once(a,"load, error",function(){b.callback(a)}),
h.push(b)):a&&("esri.layers.WFSLayer"===a.declaredClass&&!a.loadError)&&(b=new q,ia.once(a,"fromJsonComplete, error",function(d){b.callback(a)}),h.push(b))});if(h.length){var b=new q;m=new C(h);m.addCallback(function(){b.callback(a)});return b.promise}return a}).then(function(a){var b=[];k.forEach(a,function(a){var d=a.layerObject;d instanceof u?d.loaded&&(d.labelingInfo&&(a.showLabels||d._collection))&&b.push(d):d&&"esri.layers.WFSLayer"===d.declaredClass&&d.loaded&&d.labelingInfo&&b.push(d)});b.length?
I(["../layers/LabelLayer"],function(d){var c=new d;k.forEach(b,function(a){c.addFeatureLayer(a)});a.push({layerObject:c});g.callback(a)}):g.callback(a)});return g}function pb(a,e,d,c,b,g){var f=[],h=[],m=[];k.forEach(a.operationalLayers,function(a,b){if(a.featureCollection&&a.featureCollection.layers){var d=a.featureCollection.layers.length;k.forEach(a.featureCollection.layers,function(c,f){var e=!0;a.visibleLayers&&-1==k.indexOf(a.visibleLayers,f)&&(e=!1);c.visibility=a.visibility&&e;c.opacity=a.opacity;
c.id=(a.id||"operational"+b)+"_"+f;a.title&&(c.title=1===d||!c.layerDefinition.name||a.title===c.layerDefinition.name?a.title:a.title+" - "+c.layerDefinition.name);m.push(c)},this)}else m.push(a)});k.forEach(a.baseMap.baseMapLayers,function(a,b){a.baseMapLayer=!0;a.id=a.id||"base"+b;f.push(a)});k.forEach(m,function(a,b){a.id=a.id||"operational"+b;f.push(a)});k.forEach(f,function(a){a.url&&!a.type&&(a.deferredsPos=h.length,a.errors=a.errors||[],h.push(lb(a.url,a.errors)))});0===h.length?(d=d||va(f),
f=ua(f,e,d,c,g),b.callback(f)):(new C(h)).addCallback(function(a){kb(a,f,e,h,b,d,c,g)});return b}function P(a,e,d,c){var b=a.minScale,g=a.maxScale;if(10.1>=d.version&&e)for(a=e.length-1;0<=a;a--){if(e[a].id==c)if(0==b&&0<e[a].minScale?b=e[a].minScale:0<b&&0==e[a].minScale?b=d.minScale:0<b&&0<e[a].minScale&&(b=Math.min(b,e[a].minScale)),g=Math.max(d.maxScale||0,e[a].maxScale||0),d.setScaleRange(b,g),-1<e[a].parentLayerId)c=e[a].parentLayerId;else break}else 10.1<d.version&&(k.forEach(a.layerInfos,
function(a){a.id==c&&(0==b&&0<a.minScale?b=a.minScale:0<b&&0==a.minScale||0<b&&0<a.minScale&&(b=Math.min(b,a.minScale)),g=Math.max(g||0,a.maxScale||0))}),d.setScaleRange(b,g))}function Q(a,e,d,c){var b=a.url,g=a.__popupIds,f=a.__popupUrls,h=a.__popupWhereClauses,m=a.__popupMinScales,v=a.__popupMaxScales,p=a.__resourceInfo,s=[];k.forEach(a.__popups,function(c,n){if(c){var x,r=[];k.forEach(c.fieldInfos,function(a){"shape"!==a.fieldName.toLowerCase()&&r.push(a.fieldName)});if(a.dynamicLayerInfos&&0<
a.dynamicLayerInfos.length){var q=k.filter(a.dynamicLayerInfos,function(a){return g[n]==a.id})[0].source;x=new u(b+"/dynamicLayer",{id:a.id+"_"+g[n],source:q,outFields:r,mode:u.MODE_SELECTION,infoTemplate:c&&new d(c),drawMode:!1,visible:a.visible,autoGeneralize:!0});var w=function(b,d){0<h[b].length&&d.setDefinitionExpression(h[b]);if(!l.isDefined(m[b])&&!l.isDefined(v[b]))P(a,e||p.layers,d,g[b]);else if(l.isDefined(a.minScale)||l.isDefined(a.maxScale)){var c=a.minScale,f=a.maxScale;0==c&&0<m[b]?
c=m[b]:0<c&&0==m[b]||0<c&&0<m[b]&&(c=Math.min(c,m[b]));f=Math.max(f||0,v[b]||0);d.setScaleRange(c,f)}else d.setScaleRange(m[b],v[b])};x.loaded?w(n,x):t.connect(x,"onLoad",function(a){w(n,x)})}else{var y=null,z=b+"/"+g[n];if(f[n].length)z=f[n];else if(e)for(q=0;q<e.length;q++)if(e[q].id===g[n]){y=e[q];break}x=new u(A(z),{id:a.id+"_"+g[n],outFields:r,mode:u.MODE_SELECTION,infoTemplate:c&&new d(c),drawMode:!1,visible:a.visible,resourceInfo:y,autoGeneralize:!0});x.loaded?(0<h[n].length&&x.setDefinitionExpression(h[n]),
P(a,e||p.layers,x,g[n])):t.connect(x,"onLoad",function(b){0<h[n].length&&x.setDefinitionExpression(h[n]);P(a,e||p.layers,b,g[n])})}s.push(x)}});0<s.length&&(t.connect(a,"onVisibilityChange",n.hitch(this,function(a,b){k.forEach(a,function(a){b?a.show():a.hide()})},s)),t.connect(c,"onLayerRemove",n.hitch(this,function(a,b,d){a.id===d.id&&k.forEach(b,function(a){c.removeLayer(a)})},a,s)));delete a.__popups;delete a.__popupIds;delete a.__popupUrls;delete a.__popupWhereClauses;delete a.__popupMinScales;
delete a.__popupMaxScales;delete a.__resourceInfo;return s}function qb(a){return z({url:A(a.url+"/layers"),content:{f:"json"},callbackParamName:"callback",error:function(){}})}function rb(a,e,d){var c=[];k.forEach(a,function(a){var b=a.__popups;b&&(1<b.length&&10<=a.version)&&(a.__deferredsPos=c.length,c.push(qb(a)))});var b=[];0<c.length?(new C(c)).addCallback(function(c){k.forEach(a,function(a){a.__popups&&0<a.__popups.length&&(a.__deferredsPos||0===a.__deferredsPos?(b=b.concat(Q(a,c[a.__deferredsPos][1].layers,
d,e)),delete a.__deferredsPos):b=b.concat(Q(a,null,d,e)))});e.addLayers(b)}):(k.forEach(a,function(a){a.__popups&&0<a.__popups.length&&(b=b.concat(Q(a,null,d,e)))}),e.addLayers(b))}function sb(a){k.forEach(a,function(a){var d=a.layer;d.toJson&&(a=d.toJson(),a.featureSet&&(d.name&&-1<d.name.indexOf("Text"))&&k.forEach(a.featureSet.features,function(a,b){if(a.attributes.TEXT){var e=d.graphics[b];e.symbol.setText(a.attributes.TEXT);a.symbol.horizontalAlignment&&(e.symbol.align=a.symbol.horizontalAlignment);
e.setSymbol(e.symbol);e.setAttributes(a.attributes)}},this))})}function tb(a){var e=6;k.forEach(a,function(a){if(a=a.renderer)"esri.renderer.SimpleRenderer"===a.declaredClass?((a=a.symbol)&&a.xoffset&&(e=Math.max(e,Math.abs(a.xoffset))),a&&a.yoffset&&(e=Math.max(e,Math.abs(a.yoffset)))):("esri.renderer.UniqueValueRenderer"===a.declaredClass||"esri.renderer.ClassBreaksRenderer"===a.declaredClass)&&k.forEach(a.infos,function(a){(a=a.symbol)&&a.xoffset&&(e=Math.max(e,Math.abs(a.xoffset)));a&&a.yoffset&&
(e=Math.max(e,Math.abs(a.yoffset)))})});return e}function wa(a){var e=this,d=e.infoWindow,c=a.graphic;if(e.loaded){d.hide();d.clearFeatures();var b=[];k.forEach(e.graphicsLayerIds,function(a){if((a=e.getLayer(a))&&a instanceof u&&a.loaded&&a.visible)a.clearSelection(),a.infoTemplate&&!a.suspended&&b.push(a)});k.forEach(e.layerIds,function(a){(a=e.getLayer(a))&&(-1!==a.declaredClass.indexOf("ArcGISImageServiceLayer")&&a.loaded&&a.visible&&a.infoTemplate)&&b.push(a)});c=c&&c.getInfoTemplate()?c:null;
if(b.length||c){var g=tb(b),f=a.screenPoint,h=e.toMap(new Ga(f.x-g,f.y+g)),g=e.toMap(new Ga(f.x+g,f.y-g)),h=new D(h.x,h.y,g.x,g.y,e.spatialReference),m=new Cb;m.geometry=h;m.timeExtent=e.timeExtent;var l=!0,h=k.map(b,function(b){var c;-1!==b.declaredClass.indexOf("ArcGISImageServiceLayer")?(m.geometry=a.mapPoint,l=!1,c=b.queryVisibleRasters(m,{rasterAttributeTableFieldPrefix:"Raster.",returnDomainValues:!0}),c.addCallback(function(){return b.getVisibleRasters()})):(c=b.selectFeatures(m),c.addCallback(function(){return b.getSelectedFeatures()}));
return c});c&&(g=new q,g.callback([c]),h.splice(0,0,g));if(!k.some(h,function(a){return-1===a.fired})){var p=c?1:0;k.forEach(b,function(a){p=-1!==a.declaredClass.indexOf("ArcGISImageServiceLayer")?p+a.getVisibleRasters().length:p+a.getSelectedFeatures().length});if(!p)return}d.setFeatures(h);d.show(a.mapPoint,{closestFirst:l})}}}function Ib(a,e){var d=e.mapOptions||{},c;d.infoWindow||(c=new Bb({visibleWhenEmpty:!1},yb.create("div")),d.infoWindow=c);!l.isDefined(d.showInfoWindowOnClick)&&!e.usePopupManager&&
(d.showInfoWindowOnClick=!1);d=new zb(a,d);t.connect(d,"onLayersAddResult",sb);return d}function y(a,e,d,c,b,g){var f,h,m,l;c.map?(f=c.map,h=c.clickEventHandle,m=c.clickEventListener,l=c.errors):(f=Ib(c,b),!b.ignorePopups&&(!b.disableClickBehavior&&!b.usePopupManager)&&(h=t.connect(f,"onClick",wa),m=wa));f.addLayers(a);!b.ignorePopups&&!b.usePopupManager&&rb(a,f,b._clazz);var p=l||[];k.forEach(e,function(a){a.errors&&(p=p.concat(a.errors))},this);f.loaded?g.callback({map:f,itemInfo:d,errors:p,clickEventHandle:h,
clickEventListener:m}):t.connect(f,"onLoad",function(){g.callback({map:f,itemInfo:d,errors:p,clickEventHandle:h,clickEventListener:m})})}function R(a,e,d,c,b){var g=[];k.forEach(b,function(a){n.isArray(a.layerObject)?k.forEach(a.layerObject,function(a){g.push(a)}):g.push(a.layerObject)});if("BingMapsAerial"===b[0].type||"BingMapsRoad"===b[0].type||"BingMapsHybrid"===b[0].type)var f=setInterval(function(){if(b[0].layerObject&&b[0].layerObject.loaded)clearInterval(f),ub(a,e,d,c,b,g);else if(b[0].errors){clearInterval(f);
var h="";b[0].errors&&b[0].errors.length&&(h=" ("+b[0].errors[0].message+")");c.errback(Error(ja.arcgis.utils.baseLayerError+h))}},10);else if(!g[0]&&b[0].baseMapLayer){var h="";b[0].errors&&b[0].errors.length&&(h=" ("+b[0].errors[0].message+")");c.errback(Error(ja.arcgis.utils.baseLayerError+h))}else ub(a,e,d,c,b,g)}function ub(a,e,d,c,b,g){try{var f=d.mapOptions||{};d.mapOptions=f;var h=a.item;g=k.filter(g,l.isDefined);if(h)if(h.extent&&h.extent.length)if(f.extent)y(g,b,a,e,d,c);else{var m=new D(h.extent[0][0],
h.extent[0][1],h.extent[1][0],h.extent[1][1],new B({wkid:4326})),n=g[0].spatialReference;4326===n.wkid?(f.extent=m,y(g,b,a,e,d,c)):102100===n.wkid||102113===n.wkid||3857===n.wkid?(m.xmin=Math.max(m.xmin,-180),m.xmax=Math.min(m.xmax,180),m.ymin=Math.max(m.ymin,-89.99),m.ymax=Math.min(m.ymax,89.99),f.extent=Ab.geographicToWebMercator(m),y(g,b,a,e,d,c)):d.geometryServiceURL||K.defaults.geometryService?(d.geometryServiceURL?new Db(d.geometryServiceURL):K.defaults.geometryService).project([m],n,function(h){h=
h[0];f.extent=f.extent||h;y(g,b,a,e,d,c)},function(){y(g,b,a,e,d,c)}):c.errback(Error(ja.arcgis.utils.geometryServiceError))}else y(g,b,a,e,d,c);else y(g,b,a,e,d,c)}catch(p){c.errback(p)}}function Jb(a){var e=[];k.forEach(a.operationalLayers,function(a){a.featureCollection?e.push({featureCollection:a.featureCollection,visibility:a.visibility,title:a.title}):a.layerObject&&e.push({layer:a.layerObject,visibility:a.visibility,title:a.title})});return e}function vb(a){var e=[];a=a.baseMap.baseMapLayers.concat(a.operationalLayers);
k.forEach(a,function(a){var c={};if(a.featureCollection&&"CSV"!==a.type)!0===a.featureCollection.showLegend&&k.forEach(a.featureCollection.layers,function(b){if(!1!==b.showLegend){var g=b.layerObject.renderer;c={layer:b.layerObject,title:a.title,defaultSymbol:g&&g.defaultSymbol&&g.defaultLabel?!0:!1};1<a.featureCollection.layers.length&&(c.title+=" - "+b.layerDefinition.name);e.push(c)}});else if(a.baseMapLayer&&!0===a.showLegend&&a.layerObject||!a.baseMapLayer&&!1!==a.showLegend&&a.layerObject&&
!(a.layerObject instanceof u&&a.layerObject.mode===u.MODE_SELECTION)){var b=a.layerObject.renderer,g=a.layerObject.declaredClass,b=!b||b&&b.defaultSymbol&&b.defaultLabel?!0:!1;if(10.1>a.layerObject.version&&("esri.layers.ArcGISDynamicMapServiceLayer"===g||"esri.layers.ArcGISTiledMapServiceLayer"===g)||"esri.layers.ArcGISImageServiceLayer"===g)b=!0;c={layer:a.layerObject,title:a.title,defaultSymbol:b};a.layers&&(g=k.map(k.filter(a.layers,function(a){return!1===a.showLegend}),function(a){return a.id}),
g.length&&(c.hideLayers=g));e.push(c)}});return e}function Kb(a,e){function d(a,b){k.forEach(a,function(a,c){switch(a){case S:Oa=b[c];break;case T:Va=b[c];break;case U:Ua=b[c];break;case xa:eb=b[c];break;case V:fb=b[c];break;case ya:Pa=b[c];break;case W:db=b[c];break;case za:Na=b[c];break;case X:Ra=b[c];break;case Y:ab=b[c];break;case Z:ib=b[c];break;case Aa:Qa=b[c];break;case $:Ta=b[c];break;case aa:Xa=b[c];break;case ba:Sa=b[c];break;case ca:jb=b[c];break;case Ba:cb=b[c];break;case Ca:na=b[c];break;
case da:gb=b[c];break;case ea:w=b[c];break;case fa:bb=b[c];break;case ga:Ya=b[c];break;case ha:$a=b[c];break;case Da:Za=b[c]}})}var c=new q,b=a.itemData,g=[];b.baseMap&&b.baseMap.baseMapLayers&&(g=g.concat(b.baseMap.baseMapLayers));b.operationalLayers&&(g=g.concat(b.operationalLayers));for(var b=k.map(g,function(a){return a&&a.layerType}),f=[],h=[],g=!1,m=0;m<b.length;m++){switch(b[m]){case "ArcGISFeatureLayer":-1===k.indexOf(f,Z)&&f.push(Z);break;case "ArcGISImageServiceLayer":case "ArcGISTiledImageServiceLayer":-1===
k.indexOf(f,T)&&(f.push(T),h.push(X),h.push($),h.push(ba));break;case "ArcGISImageServiceVectorLayer":-1===k.indexOf(f,U)&&(f.push(U),h.push(X),h.push($),h.push(ba));break;case "ArcGISMapServiceLayer":case "ArcGISTiledMapServiceLayer":-1===k.indexOf(f,S)&&(f.push(S),h.push(ya),h.push(za),h.push(Aa));break;case "ArcGISStreamLayer":-1===k.indexOf(f,ca)&&f.push(ca);break;case "BingMapsAerial":case "BingMapsHybrid":case "BingMapsRoad":-1===k.indexOf(f,ea)&&f.push(ea);break;case "CSV":-1===k.indexOf(f,
V)&&(f.push(V),h.push(xa));break;case "GeoRSS":-1===k.indexOf(f,W)&&f.push(W);break;case "KML":-1===k.indexOf(f,Y)&&f.push(Y);break;case "OpenStreetMap":-1===k.indexOf(f,aa)&&f.push(aa);break;case "VectorTileLayer":-1===k.indexOf(f,da)&&(f.push(da),Ea("ie")||h.push(Ca));break;case "WebTiledLayer":-1===k.indexOf(f,fa)&&(f.push(fa),h.push(Ba));break;case "WFS":-1===k.indexOf(f,ga)&&f.push(ga);break;case "WMS":-1===k.indexOf(f,ha)&&(f.push(ha),h.push(Da));break;default:g=!0}if(g)break}g&&(f=Lb,h=Mb);
f.length?I(f,function(){d(f,arguments);h.length?I(h,function(){d(h,arguments);c.resolve()}):c.resolve()}):c.resolve();return c}function wb(a,e,d,c){var b=c.itemData;b.baseMap&&(b.baseMap.baseMapLayers&&b.baseMap.baseMapLayers.length)&&(b.baseMap.baseMapLayers[0].firstLayer=!0);var g=e.layerMixins,f=g&&g.length;if(f){var h=function(a){for(var b=0;b<f;b++){var c=g[b];if(c.mixin)if(c.hasOwnProperty("id")){if(a.id===c.id){n.mixin(a,c.mixin);break}}else if(a.url===c.url){n.mixin(a,c.mixin);break}}};k.forEach(b.baseMap&&
b.baseMap.baseMapLayers,h);k.forEach(b.operationalLayers,h)}Kb(c,e).then(function(){return Gb(c,e)}).then(function(){return Fb(c,e)}).then(function(b){var c=b[0],e=b[1];if(!c.itemData.operationalLayers||0===c.itemData.operationalLayers.length)L(c,e).addCallback(function(b){O(b.itemData,e).addCallback(n.hitch(null,R,b,a,e,d))});else{var f=new q,g=c.itemData.baseMap.baseMapLayers.slice(),h=k.filter(c.itemData.baseMap.baseMapLayers,function(a){return!a.isReference});b={item:c.item,itemData:{baseMap:{baseMapLayers:h}}};
c.itemData.baseMap.baseMapLayers=k.filter(c.itemData.baseMap.baseMapLayers,function(a){return a.isReference});L(b,e).addCallback(function(b){O(b.itemData,e).addCallback(n.hitch(null,R,b,a,e,f))});f.then(function(a){L(c,e).addCallback(function(b){O(b.itemData,e,a.map.spatialReference,h,a.map).addCallback(function(c){b.itemData.baseMap.baseMapLayers=g;R(b,a,e,d,c)})})},n.hitch(d,d.errback))}})}function oa(a,e){"undefined"===typeof e&&(e=!0);r._arcgisUrl&&0<r._arcgisUrl.length&&(r.arcgisUrl=r._arcgisUrl);
var d=r.arcgisUrl+"/"+a,c={},b=new q;z({url:d,content:{f:"json"},callbackParamName:"callback",load:function(a){c.item=a;e?z({url:d+"/data",content:{f:"json"},callbackParamName:"callback",load:function(a){c.itemData=a;b.callback(c)},error:function(a){b.errback(a)}}):b.callback(c)},error:function(a){b.errback(a)}});return b}var r,Oa,Va,Ua,eb,fb,Pa,db,Na,Ra,ab,ib,Qa,Ta,Xa,Sa,jb,cb,na,gb,w,bb,Ya,$a,Za,S="../layers/ArcGISDynamicMapServiceLayer",T="../layers/ArcGISImageServiceLayer",U="../layers/ArcGISImageServiceVectorLayer",
xa="./csv",V="../layers/CSVLayer",ya="../layers/DynamicLayerInfo",W="../layers/GeoRSSLayer",za="../layers/ImageParameters",X="../layers/ImageServiceParameters",Y="../layers/KMLLayer",Z="../layers/LabelClass",Aa="../layers/LayerDrawingOptions",$="../layers/MosaicRule",aa="../layers/OpenStreetMapLayer",ba="../layers/RasterFunction",ca="../layers/StreamLayer",Ba="../layers/TileInfo",Ca="../layers/vector-tile",da="../layers/VectorTileLayer",ea="../virtualearth/VETiledLayer",fa="../layers/WebTiledLayer",
ga="../layers/WFSLayer",ha="../layers/WMSLayer",Da="../layers/WMSLayerInfo",Lb=[S,T,U,V,W,Y,Z,aa,ca,da,ea,fa,ga,ha],Mb=[xa,ya,za,X,Aa,$,ba,Ba,Ca,Da];r={arcgisUrl:location.protocol+"//www.arcgis.com/sharing/rest/content/items",getItem:oa,createMap:function(a,e,d){var c=new q;d=d||{};var b=d.infoTemplateClass;d._clazz=b&&(n.isObject(b)?b:n.getObject(b))||Ha;n.isString(a)?oa(a).addCallback(n.hitch(null,wb,e,d,c)).addErrback(n.hitch(c,c.errback)):wb(e,d,c,a);return c},getLayerList:function(a){return a&&
a.itemInfo&&a.itemInfo.itemData?Jb(a.itemInfo.itemData):[]},getLegendLayers:function(a){return a&&a.itemInfo&&a.itemInfo.itemData?vb(a.itemInfo.itemData):[]},_arcgisUrl:null,_getItemProps:L,_getItemData:F,_getBingKey:ka,_portalUrlResponse:ma,_portalUrlFailure:M,_processFSItemProperties:la,_processSSItemProperties:Ia,_getLayers:O,_preBuildLayerObjects:kb,_buildLayerObjects:ua,_preCreateMap:R,_getMapSR:va,_createMap:y,_addSelectionLayers:rb,_createSelectionFeatureLayers:Q,_getServiceInfo:lb,_getFeatureCollectionItem:mb,
_mergeFeatureCollectionItem:nb,_projectFeatureCollection:ob,_getLayersInfo:qb,_initLayer:Wa,_loadAsCached:qa,_loadAsDynamic:Ma,_processPopups:pa,_onLayersAddResult:sb,_sameSpatialReferenceAsBasemap:sa,_sameTilingSchemeAsBasemap:ta,_showPopup:wa,_calculateClickTolerance:tb,_getVisibleFeatureLayers:ra,_updateLayerScaleInfo:P,_checkUrl:A,_isHostedService:Ka,_isAgolService:La,_getLegendLayers:vb};n.setObject("arcgis.utils",r,G);return r});