// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.17/esri/copyright.txt for details.
//>>built
require({cache:{"dojo/debounce":function(){define([],function(){return function(p,x){var l;return function(){l&&clearTimeout(l);var d=this,h=arguments;l=setTimeout(function(){p.apply(d,h)},x)}}})},"esri/numberUtils":function(){define(["dojo/has","dojo/number","dojo/i18n!dojo/cldr/nls/number","./kernel"],function(p,x,l,d){var h=function(d,f){return d-f},y={_reNumber:/^-?(\d+)(\.(\d+))?$/i,getDigits:function(d){var f=String(d),k=f.match(y._reNumber);d={integer:0,fractional:0};k&&k[1]?(d.integer=k[1].split("").length,
d.fractional=k[3]?k[3].split("").length:0):-1<f.toLowerCase().indexOf("e")&&(k=f.split("e"),f=k[0],k=k[1],f&&k&&(f=Number(f),k=Number(k),(d=0<k)||(k=Math.abs(k)),f=y.getDigits(f),d?(f.integer+=k,f.fractional=k>f.fractional?0:f.fractional-k):(f.fractional+=k,f.integer=k>f.integer?1:f.integer-k),d=f));return d},getFixedNumbers:function(d,f){var k,l;k=Number(d.toFixed(f));k<d?l=k+1/Math.pow(10,f):(l=k,k-=1/Math.pow(10,f));k=Number(k.toFixed(f));l=Number(l.toFixed(f));return[k,l]},getPctChange:function(d,
f,k,l){var h={prev:null,next:null},q;null!=k&&(q=d-k,k=f-k-q,h.prev=Math.floor(Math.abs(100*k/q)));null!=l&&(q=l-d,k=l-f-q,h.next=Math.floor(Math.abs(100*k/q)));return h},round:function(d,f){var k=d.slice(0),l,p,q,u,b,r,x,D,B,n=!f||null==f.tolerance?2:f.tolerance,z=f&&f.indexes,N=!f||null==f.strictBounds?!1:f.strictBounds;if(z)z.sort(h);else{z=[];for(r=0;r<k.length;r++)z.push(r)}for(r=0;r<z.length;r++)if(B=z[r],l=k[B],p=0===B?null:k[B-1],q=B===k.length-1?null:k[B+1],u=y.getDigits(l),u=u.fractional){x=
0;for(D=!1;x<=u&&!D;)b=y.getFixedNumbers(l,x),b=N&&0===r?b[1]:b[0],D=y.hasMinimalChange(l,b,p,q,n),x++;D&&(k[B]=b)}return k},hasMinimalChange:function(d,l,k,h,p){d=y.getPctChange(d,l,k,h);l=null==d.prev||d.prev<=p;k=null==d.next||d.next<=p;return l&&k||d.prev+d.next<=2*p},_reAllZeros:RegExp("\\"+l.decimal+"0+$","g"),_reSomeZeros:RegExp("(\\d)0*$","g"),format:function(d,l){l=l||{places:20,round:-1};var k=x.format(d,l);k&&(k=k.replace(y._reSomeZeros,"$1").replace(y._reAllZeros,""));return k}};p("extend-esri")&&
(d.numberUtils=y);return y})},"esri/renderers/utils":function(){define("dojo/_base/lang dojo/_base/array dojo/has dojo/date/locale ../kernel ../numberUtils ../Color dojo/i18n!../nls/jsapi dojo/i18n!dojo/cldr/nls/gregorian".split(" "),function(p,x,l,d,h,y,A,f,k){function P(b){return b&&x.map(b,function(b){return new A(b)})}function J(b,n,d){var k="";0===n?k=u.lt+" ":n===d&&(k=u.gt+" ");return k+b}var q={},u={lte:"\x3c\x3d",gte:"\x3e\x3d",lt:"\x3c",gt:"\x3e",pct:"%"},b={millisecond:0,second:1,minute:2,
hour:3,day:4,month:5,year:6},r={millisecond:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"medium"}},second:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"medium"}},minute:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"short"}},hour:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"short"}},day:{selector:"date",dateOptions:{formatLength:"long"}},month:{selector:"date",dateOptions:{formatLength:"long"}},year:{selector:"date",dateOptions:{selector:"year"}}},
Q={formatLength:"short",fullYear:!0},D={formatLength:"short"};p.mixin(q,{timelineDateFormatOptions:{selector:"date",dateOptions:{formatLength:"short",fullYear:!0}},formatDate:function(b,n){var l,f=[];null!=b&&!(b instanceof Date)&&(b=new Date(b));n=n||{};n=p.mixin({},n);var h=n.selector?n.selector.toLowerCase():null;l=!h||-1<h.indexOf("time");h=!h||-1<h.indexOf("date");l&&(n.timeOptions=n.timeOptions||D,n.timeOptions&&(n.timeOptions=p.mixin({},n.timeOptions),n.timeOptions.selector=n.timeOptions.selector||
"time",f.push(n.timeOptions)));h&&(n.dateOptions=n.dateOptions||Q,n.dateOptions&&(n.dateOptions=p.mixin({},n.dateOptions),n.dateOptions.selector=n.dateOptions.selector||"date",f.push(n.dateOptions)));f&&f.length?(f=x.map(f,function(n){return d.format(b,n)}),l=1==f.length?f[0]:k["dateTimeFormat-medium"].replace(/\'/g,"").replace(/\{(\d+)\}/g,function(b,n){return f[n]})):l=d.format(b);return l},createColorStops:function(b){var n=b.values,d=b.colors,k=b.labelIndexes,l=b.isDate,f=b.dateFormatOptions;
b=[];return b=x.map(n,function(b,B){var h=null;if(!k||-1<x.indexOf(k,B)){var r;(r=l?q.formatDate(b,f):y.format(b))&&(h=J(r,B,n.length-1))}return{value:b,color:d[B],label:h}})},updateColorStops:function(b){var n=b.stops,d=b.changes,k=b.isDate,l=b.dateFormatOptions,f=[],h,r=x.map(n,function(b){return b.value});x.forEach(d,function(b){f.push(b.index);r[b.index]=b.value});h=y.round(r,{indexes:f});x.forEach(n,function(b,d){b.value=r[d];if(null!=b.label){var B,f=null;(B=k?q.formatDate(h[d],l):y.format(h[d]))&&
(f=J(B,d,n.length-1));b.label=f}})},createClassBreakLabel:function(b){var n=b.minValue,d=b.maxValue,k=b.isFirstBreak?"":u.gt+" ";b="percent-of-total"===b.normalizationType?u.pct:"";n=null==n?"":y.format(n);d=null==d?"":y.format(d);return k+n+b+" "+f.smartMapping.minToMax+" "+d+b},setLabelsForClassBreaks:function(b){var d=b.classBreaks,k=b.classificationMethod,l=b.normalizationType,f=[];d&&d.length&&("standard-deviation"===k?console.log("setLabelsForClassBreaks: cannot set labels for class breaks generated using 'standard-deviation' method."):
b.round?(f.push(d[0].minValue),x.forEach(d,function(b){f.push(b.maxValue)}),f=y.round(f),x.forEach(d,function(b,d){b.label=q.createClassBreakLabel({minValue:0===d?f[0]:f[d],maxValue:f[d+1],isFirstBreak:0===d,normalizationType:l})})):x.forEach(d,function(b,d){b.label=q.createClassBreakLabel({minValue:b.minValue,maxValue:b.maxValue,isFirstBreak:0===d,normalizationType:l})}))},updateClassBreak:function(b){var d=b.classBreaks,k=b.normalizationType,l=b.change,f=l.index,l=l.value,h=-1,r=-1,p=d.length;"standard-deviation"===
b.classificationMethod?console.log("updateClassBreak: cannot update labels for class breaks generated using 'standard-deviation' method."):(0===f?h=f:f===p?r=f-1:(r=f-1,h=f),-1<h&&h<p&&(b=d[h],b.minValue=l,b.label=q.createClassBreakLabel({minValue:b.minValue,maxValue:b.maxValue,isFirstBreak:0===h,normalizationType:k})),-1<r&&r<p&&(b=d[r],b.maxValue=l,b.label=q.createClassBreakLabel({minValue:b.minValue,maxValue:b.maxValue,isFirstBreak:0===r,normalizationType:k})))},calculateDateFormatInterval:function(d){var n,
k,l=d.length,f,h,r,p,u,q,y=Infinity,A;d=x.map(d,function(b){return new Date(b)});for(n=0;n<l-1;n++){f=d[n];r=[];u=Infinity;q="";for(k=n+1;k<l;k++)h=d[k],h=f.getFullYear()!==h.getFullYear()&&"year"||f.getMonth()!==h.getMonth()&&"month"||f.getDate()!==h.getDate()&&"day"||f.getHours()!==h.getHours()&&"hour"||f.getMinutes()!==h.getMinutes()&&"minute"||f.getSeconds()!==h.getSeconds()&&"second"||"millisecond",p=b[h],p<u&&(u=p,q=h),r.push(h);u<y&&(y=u,A=q)}return A},createUniqueValueLabel:function(b){var d=
b.value,k=b.fieldInfo,f=b.domain;b=b.dateFormatInterval;var l=String(d);(f=f&&f.codedValues?f.getName(d):null)?l=f:"number"===typeof d&&(l=k&&"esriFieldTypeDate"===k.type?q.formatDate(d,b&&r[b]):y.format(d));return l},cloneColorInfo:function(b){var d;b&&(d=p.mixin({},b),d.colors=P(d.colors),d.stops=d.stops&&x.map(d.stops,function(b){b=p.mixin({},b);b.color&&(b.color=new A(b.color));return b}),d.legendOptions&&(d.legendOptions=p.mixin({},d.legendOptions)));return d},cloneOpacityInfo:function(b){var d;
if(b){d=p.mixin({},b);if(b=d.opacityValues)d.opacityValues=b.slice(0);if(b=d.stops)d.stops=x.map(b,function(b){return p.mixin({},b)});if(b=d.legendOptions)d.legendOptions=p.mixin({},b)}return d},cloneSizeInfo:function(b){var d;if(b){d=p.mixin({},b);d.stops&&(d.stops=x.map(d.stops,function(b){return p.mixin({},b)}));if((b=d.minSize)&&"object"===typeof b)d.minSize=q.cloneSizeInfo(b);if((b=d.maxSize)&&"object"===typeof b)d.maxSize=q.cloneSizeInfo(b);if(b=d.legendOptions)if(d.legendOptions=p.mixin({},
b),b=b.customValues)d.legendOptions.customValues=b.slice(0)}return d}});l("extend-esri")&&p.setObject("renderer.utils",q,h);return q})},"*noref":1}});
define("esri/dijit/Legend","dojo/_base/kernel dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/connect dojo/_base/json dojo/_base/Color dojo/debounce dojo/has dojo/sniff dojo/DeferredList dojo/json dojo/dom dojo/dom-construct dojo/dom-style dojo/dom-class dijit/_Widget dojox/gfx dojox/gfx/matrix dojox/html/entities ../kernel ../config ../request ../lang ../numberUtils ../renderers/utils ../renderers/SimpleRenderer ../renderers/UniqueValueRenderer ../renderers/ClassBreaksRenderer ../renderers/ScaleDependentRenderer ../renderers/DotDensityRenderer ../renderers/TemporalRenderer ../renderers/VectorFieldRenderer ../renderers/HeatmapRenderer ../symbols/PictureFillSymbol ../symbols/SimpleLineSymbol ../symbols/jsonUtils ./_EventedWidget dojo/i18n!../nls/jsapi".split(" "),function(p,
x,l,d,h,y,A,f,k,P,J,q,u,b,r,Q,D,B,n,z,N,R,S,G,E,K,H,L,I,V,W,X,O,Y,Z,$,M,aa,T){var F=x([aa,D],{declaredClass:"esri.dijit.Legend",widgetsInTemplate:!1,layers:null,alignRight:!1,hoverLabelShowing:!1,dotDensitySwatchSize:26,dotCoverage:75,gradientHeight:30,transparencyRampColor:new A([64,64,64]),defaultText:"Aa",sizeRampLightColor:new A([255,255,255]),sizeRampDarkColor:new A([128,128,128]),layerConnects:[],gradientWidth:34,colorRampBorder:"1px solid",_specialChars:{lt:"\x3c",gt:"\x3e"},_ieTimer:100,_isRightToLeft:!1,
_align:null,_legendAlign:null,constructor:function(a,c){l.mixin(this,T.widgets.legend);this._i18n=T.widgets.legend;a=a||{};a.map?c?(this.map=a.map,this.layerInfos=a.layerInfos,this._respectCurrentMapScale=!1===a.respectCurrentMapScale?!1:!0,this._respectVisibility=!1===a.respectVisibility?!1:!0,this.arrangement=a.arrangement===F.ALIGN_RIGHT?F.ALIGN_RIGHT:F.ALIGN_LEFT,this.arrangement===F.ALIGN_RIGHT&&(this.alignRight=!0),this.autoUpdate=!1===a.autoUpdate?!1:!0,this._surfaceItems=[],this.hideLayersInLegend=
{},this.refresh=f(this.refresh,0)):console.error("esri.dijit.Legend: must specify a container for the legend"):console.error("esri.dijit.Legend: unable to find the 'map' property in parameters")},postMixInProperties:function(){this.inherited(arguments);var a=["ar","he"],c,g;for(c=0;c<a.length;c+=1)g=a[c],p.locale&&-1!==p.locale.indexOf(g)&&(-1!==p.locale.indexOf("-")?-1!==p.locale.indexOf(g+"-")&&(this._isRightToLeft=!0):this._isRightToLeft=!0);this._isRightToLeft?(this._align=this.alignRight?"left":
"right",this._legendAlign=this.alignRight?"esriLegendLeft":"esriLegendRight"):(this._align=this.alignRight?"right":"left",this._legendAlign=this.alignRight?"esriLegendRight":"esriLegendLeft")},startup:function(){this.inherited(arguments);this._initialize();9>k("ie")&&(this._repaintItems=l.hitch(this,this._repaintItems),setTimeout(this._repaintItems,this._ieTimer))},destroy:function(){this._deactivate();this._removeHoverHandlers();this.inherited(arguments)},refresh:function(a){if(this.domNode){a?(this.layerInfos=
a,this.layers=[],d.forEach(this.layerInfos,function(a){this._isSupportedLayerType(a.layer)&&(a.title&&(a.layer._titleForLegend=a.title),a.layer._hideDefaultSymbol=!1===a.defaultSymbol?!0:!1,a.hideLayers?(this.hideLayersInLegend[a.layer.id]=a.hideLayers,this._addSubLayersToHide(a)):this.hideLayersInLegend[a.layer.id]=[],a.hoverLabel&&(a.layer._hoverLabel=a.hoverLabel),a.hoverLabels&&(a.layer._hoverLabels=a.hoverLabels),this.layers.push(a.layer))},this)):this.useAllMapLayers&&(this.layers=this.layerInfos=
null);for(a=this.domNode.children.length-1;0<=a;a--)b.destroy(this.domNode.children[a]);this._removeHoverHandlers();this.startup()}},_legendUrl:"http://utility.arcgis.com/sharing/tools/legend",_initialize:function(){this.layerInfos&&(this.layers=[],d.forEach(this.layerInfos,function(a){this._isSupportedLayerType(a.layer)&&(a.title&&(a.layer._titleForLegend=a.title),a.layer._hideDefaultSymbol=!1===a.defaultSymbol?!0:!1,a.hideLayers?(this.hideLayersInLegend[a.layer.id]=a.hideLayers,this._addSubLayersToHide(a)):
this.hideLayersInLegend[a.layer.id]=[],a.hoverLabel&&(a.layer._hoverLabel=a.hoverLabel),a.hoverLabels&&(a.layer._hoverLabels=a.hoverLabels),this.layers.push(a.layer))},this));this.useAllMapLayers=!1;if(!this.layers){this.useAllMapLayers=!0;this.layers=[];var a=[],c=[];d.forEach(this.map.layerIds,function(g){g=this.map.getLayer(g);var b;this._isSupportedLayerType(g)&&(g.arcgisProps&&g.arcgisProps.title&&(g._titleForLegend=g.arcgisProps.title),this.layers.push(g));"esri.layers.KMLLayer"==g.declaredClass&&
(b=g.getLayers(),d.forEach(b,function(c){a.push(c.id)},this));"esri.layers.GeoRSSLayer"==g.declaredClass&&(b=g.getFeatureLayers(),d.forEach(b,function(a){c.push(a.id)},this))},this);d.forEach(this.map.graphicsLayerIds,function(g){var b=this.map.getLayer(g);-1==d.indexOf(a,g)&&-1==d.indexOf(c,g)&&(this._isSupportedLayerType(b)&&b._params&&b._params.drawMode)&&(b.arcgisProps&&b.arcgisProps.title&&(b._titleForLegend=b.arcgisProps.title),this.layers.push(b))},this)}this._createLegend()},_activate:function(){this._deactivate();
this.autoUpdate&&(this._respectCurrentMapScale&&(this._ozeConnect=h.connect(this.map,"onZoomEnd",this,"_refreshLayers")),this.useAllMapLayers&&(this._olaConnect=h.connect(this.map,"onLayerAdd",this,"_updateAllMapLayers"),this._olrConnect=h.connect(this.map,"onLayerRemove",this,"_updateAllMapLayers"),this._olroConnect=h.connect(this.map,"onLayersReordered",this,"_updateAllMapLayers")),d.forEach(this.layers,function(a){var c={};c.ovcConnect=h.connect(a,"onVisibilityChange",this,"_refreshLayers");c.oocConnect=
h.connect(a,"onOpacityChange",this,"_refreshLayers");c.oscConnect=h.connect(a,"onScaleRangeChange",this,"_refreshLayers");"esri.layers.ArcGISDynamicMapServiceLayer"===a.declaredClass&&a.supportsDynamicLayers&&(c.odcConnect=h.connect(a,"_onDynamicLayersChange",l.hitch(this,"_updateDynamicLayers",a)));"esri.layers.ArcGISImageServiceLayer"===a.declaredClass&&(c.oirConnect=h.connect(a,"onRenderingChange",l.partial(this._updateImageServiceLayers,this,a)));"esri.layers.ArcGISImageServiceVectorLayer"===
a.declaredClass&&(c.oivrConnect=h.connect(a,"onRendererChange",l.hitch(this,"_refreshLayers")));this.layerConnects[a.id]=c},this))},_deactivate:function(){this._ozeConnect&&h.disconnect(this._ozeConnect);this._olaConnect&&h.disconnect(this._olaConnect);this._olroConnect&&h.disconnect(this._olroConnect);this._olrConnect&&h.disconnect(this._olrConnect);d.forEach(this.layers,function(a){a=this.layerConnects[a.id]||{};a.ovcConnect&&h.disconnect(a.ovcConnect);a.oocConnect&&h.disconnect(a.oocConnect);a.oscConnect&&
h.disconnect(a.oscConnect);a.odcConnect&&h.disconnect(a.odcConnect);a.oirConnect&&h.disconnect(a.oirConnect);a.oivrConnect&&h.disconnect(a.oivrConnect)},this);this.layerConnects=[]},_updateDynamicLayers:function(a){delete a.legendResponse;this._refreshLayers()},_updateImageServiceLayers:function(a,c){delete c.legendResponse;a._refreshLayers()},_refreshLayers:function(){this.refresh()},_updateAllMapLayers:function(){this.layers=[];d.forEach(this.map.layerIds,function(a){a=this.map.getLayer(a);this._isSupportedLayerType(a)&&
this.layers.push(a)},this);d.forEach(this.map.graphicsLayerIds,function(a){a=this.map.getLayer(a);this._isSupportedLayerType(a)&&(a._params&&a._params.drawMode)&&this.layers.push(a)},this);this.refresh()},_createLegend:function(){var a=!1,c=!1;r.set(this.domNode,"position","relative");b.create("div",{id:this.id+"_msg",className:"esriLegendMsg",innerHTML:this.NLS_creatingLegend+"..."},this.domNode);var g=[];d.forEach(this.layers,function(e){if("esri.layers.KMLLayer"==e.declaredClass||"esri.layers.GeoRSSLayer"==
e.declaredClass){var t;e.loaded?("esri.layers.KMLLayer"==e.declaredClass?t=e.getLayers():"esri.layers.GeoRSSLayer"==e.declaredClass&&(t=e.getFeatureLayers(),this.hideLayersInLegend[e.id]&&(t=d.filter(t,function(a){return-1==d.indexOf(this.hideLayersInLegend[e.id],a.id)},this))),d.forEach(t,function(a){"esri.layers.FeatureLayer"==a.declaredClass&&e._titleForLegend&&(a._titleForLegend=e._titleForLegend+" - ","esriGeometryPoint"==a.geometryType?a._titleForLegend+=this.NLS_points:"esriGeometryPolyline"==
a.geometryType?a._titleForLegend+=this.NLS_lines:"esriGeometryPolygon"==a.geometryType&&(a._titleForLegend+=this.NLS_polygons),g.push(a))},this)):h.connect(e,"onLoad",l.hitch(this,function(){this.refresh(this.layerInfos)}))}else if("esri.layers.WMSLayer"===e.declaredClass)if(e.loaded){if((!this._respectVisibility||this._respectVisibility&&e.visible)&&0<e.layerInfos.length&&d.some(e.layerInfos,function(a){return a.legendURL})){var v=!1;d.forEach(e.layerInfos,function(c){c.legendURL&&-1<d.indexOf(e.visibleLayers,
c.name)&&(v||(b.create("div",{innerHTML:"\x3cspan class\x3d'esriLegendServiceLabel'\x3e"+(e._titleForLegend||e.name||e.id)+"\x3c/span\x3e"},this.domNode),v=!0),b.create("div",{innerHTML:"\x3cimg src\x3d'"+c.legendURL+"'/\x3e"},this.domNode),a=!0)},this)}}else h.connect(e,"onLoad",l.hitch(this,function(){this.refresh(this.layerInfos)}));else"esri.layers.WFSLayer"===e.declaredClass&&!e.renderer?(t=b.create("div",{id:this.id+"_"+e.id,"class":"esriLegendService"}),b.create("span",{innerHTML:this._getServiceTitle(e),
"class":"esriLegendServiceLabel"},b.create("td",{align:this._align},b.create("tr",{},b.create("tbody",{},b.create("table",{width:"95%"},t))))),b.place(t,this.id,"first"),tableNode=b.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},t),tableBody=b.create("tbody",{},tableNode),"esriGeometryComplex"===e.geometryType?(this._buildRow_Renderer(e,e._pointSymbol,null,this.NLS_points,null,tableBody),this._buildRow_Renderer(e,e._lineSymbol,null,this.NLS_lines,null,tableBody),
this._buildRow_Renderer(e,e._polygonSymbol,null,this.NLS_areas,null,tableBody)):"esriGeometryPoint"===e.geometryType?this._buildRow_Renderer(e,e._pointSymbol,null,"",null,tableBody):"esriGeometryPolyline"===e.geometryType?this._buildRow_Renderer(e,e._lineSymbol,null,"",null,tableBody):"esriGeometryPolygon"===e.geometryType&&this._buildRow_Renderer(e,e._polygonSymbol,null,"",null,tableBody),c=!0):g.push(e)},this);var t=[];d.forEach(g,function(a){if(a.loaded){if((!this._respectVisibility||this._respectVisibility&&
a.visible)&&(a.layerInfos||a.renderer||"esri.layers.ArcGISImageServiceLayer"==a.declaredClass)){var c=b.create("div",{id:this.id+"_"+a.id,style:{display:"none"},"class":"esriLegendService"});b.create("span",{innerHTML:this._getServiceTitle(a),"class":"esriLegendServiceLabel"},b.create("td",{align:this._align},b.create("tr",{},b.create("tbody",{},b.create("table",{width:"95%"},c)))));b.place(c,this.id,"first");a.legendResponse||a.renderer?this._createLegendForLayer(a):t.push(this._legendRequest(a))}}else var g=
h.connect(a,"onLoad",this,function(a){h.disconnect(g);g=null;this.refresh()})},this);0===t.length&&!a&&!c?(u.byId(this.id+"_msg").innerHTML=this.NLS_noLegend,this._activate()):(new J(t)).addCallback(l.hitch(this,function(g){!a&&!c?u.byId(this.id+"_msg").innerHTML=this.NLS_noLegend:u.byId(this.id+"_msg").innerHTML="";this._activate()}))},_createLegendForLayer:function(a){if(a.legendResponse||a.renderer){var c=!1;if(a.legendResponse){var g=a.dynamicLayerInfos||a.layerInfos;g&&g.length?d.forEach(g,function(g,
b){if(!this.hideLayersInLegend[a.id]||-1==d.indexOf(this.hideLayersInLegend[a.id],g.id)){var w=this._buildLegendItems(a,g,b);c=c||w}},this):"esri.layers.ArcGISImageServiceLayer"==a.declaredClass&&(c=this._buildLegendItems(a,{id:0,name:null,title:a.name,subLayerIds:null,parentLayerId:-1},0))}else a.renderer&&(g=a.url?a.url.substring(a.url.lastIndexOf("/")+1,a.url.length):"fc_"+a.id,c=this._buildLegendItems(a,{id:g,name:null,subLayerIds:null,parentLayerId:-1},0));c&&(r.set(u.byId(this.id+"_"+a.id),
"display","block"),r.set(u.byId(this.id+"_msg"),"display","none"))}},_legendRequest:function(a){if(a.loaded)return 10.01<=a.version?this._legendRequestServer(a):this._legendRequestTools(a);h.connect(a,"onLoad",l.hitch(this,"_legendRequest"))},_legendRequestServer:function(a){var c=a.url,g=c.indexOf("?"),c=-1<g?c.substring(0,g)+"/legend"+c.substring(g):c+"/legend";(g=a._getToken())&&(c+="?token\x3d"+g);var b=l.hitch(this,"_processLegendResponse"),e={f:"json"};a._params.dynamicLayers&&(e.dynamicLayers=
q.stringify(this._createDynamicLayers(a)),"[{}]"===e.dynamicLayers&&(e.dynamicLayers="[]"));a._params.bandIds&&(e.bandIds=a._params.bandIds);a._params.renderingRule?e.renderingRule=a._params.renderingRule:a.rasterFunctionInfos&&0<a.rasterFunctionInfos.length&&d.forEach(a.rasterFunctionInfos,function(a){a&&(a.name&&"none"===a.name.toLowerCase())&&(e.renderingRule=q.stringify({rasterFunction:a.name}))});return S({url:c,content:e,callbackParamName:"callback",load:function(c,g){b(a,c,g)},error:R.defaults.io.errorHandler})},
_legendRequestTools:function(a){var c=a.url.toLowerCase().indexOf("/rest/"),c=a.url.substring(0,c)+a.url.substring(c+5,a.url.length),c=this._legendUrl+"?soapUrl\x3d"+window.escape(c);if(!k("ie")||8<k("ie"))c+="\x26returnbytes\x3dtrue";var g=l.hitch(this,"_processLegendResponse");return S({url:c,content:{f:"json"},callbackParamName:"callback",load:function(c,b){g(a,c,b)},error:R.defaults.io.errorHandler})},_processLegendResponse:function(a,c){c&&c.layers?(a.legendResponse=c,u.byId(this.id+"_"+a.id)&&
b.empty(u.byId(this.id+"_"+a.id)),b.create("span",{innerHTML:this._getServiceTitle(a),"class":"esriLegendServiceLabel"},b.create("td",{align:this._align},b.create("tr",{},b.create("tbody",{},b.create("table",{width:"95%"},u.byId(this.id+"_"+a.id)))))),this._createLegendForLayer(a)):console.log("Legend could not get generated for "+a.url+": "+y.toJson(c))},_buildLegendItems:function(a,c,g){var t=!1,e=u.byId(this.id+"_"+a.id),d=c.parentLayerId;if(c.subLayerIds)a=b.create("div",{id:this.id+"_"+a.id+
"_"+c.id+"_group",style:{display:"none"},"class":-1==d?0<g?"esriLegendGroupLayer":"":this._legendAlign},-1==d?e:u.byId(this.id+"_"+a.id+"_"+d+"_group")),b.create("td",{innerHTML:z.encode(c.name),align:this._align},b.create("tr",{},b.create("tbody",{},b.create("table",{width:"95%","class":"esriLegendLayerLabel"},a))));else{if(this._respectVisibility&&a.visibleLayers&&-1==(","+a.visibleLayers+",").indexOf(","+c.id+","))return t;g=b.create("div",{id:this.id+"_"+a.id+"_"+c.id,style:{display:"none"},"class":-1<
d?this._legendAlign:""},-1==d?e:u.byId(this.id+"_"+a.id+"_"+d+"_group"));b.create("td",{innerHTML:z.encode(c.name)||"",align:this._align},b.create("tr",{},b.create("tbody",{},b.create("table",{width:"95%","class":"esriLegendLayerLabel"},g))));a.legendResponse?t=t||this._buildLegendItems_Tools(a,c,g):a.renderer&&(t=t||this._buildLegendItems_Renderer(a,c,g))}return t},_buildLegendItems_Tools:function(a,c,g){var t=c.parentLayerId,e=this.map.getScale(),w=!1,v=function(a,c){var g,b;for(g=0;g<a.length;g++)if(c.dynamicLayerInfos)for(b=
0;b<c.dynamicLayerInfos[b].length;b++){if(c.dynamicLayerInfos[b].mapLayerId==a[g].layerId)return a[g]}else if(c.id==a[g].layerId)return a[g];return{}};if(!this._respectCurrentMapScale||this._respectCurrentMapScale&&this._isLayerInScale(a,c,e)){var U=!0;if(this._respectCurrentMapScale&&("esri.layers.ArcGISDynamicMapServiceLayer"===a.declaredClass||"esri.layers.ArcGISMapServiceLayer"===a.declaredClass)){var k=this._getEffectiveScale(a,c);if(k.minScale&&k.minScale<e||k.maxScale&&k.maxScale>e)U=!1}if(U){var e=
v(a.legendResponse.layers,c),f=e.legendType,m=e.layerType,l=e.legend;if(l){"esri.layers.ArcGISImageServiceLayer"!==a.declaredClass&&this._sanitizeLegendResponse(a,e,c);g=b.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},g);var h=b.create("tbody",{},g);(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(g,a,c);d.forEach(l,function(g){if(!(10.1<=a.version&&!g.values&&1<l.length&&(a._hideDefaultSymbol||"\x3call other values\x3e"===g.label||!g.label&&!("esri.layers.ArcGISImageServiceLayer"===
a.declaredClass&&10.3<=a.version||"Raster Layer"===m))))if(g.url&&0===g.url.indexOf("http")||g.imageData&&0<g.imageData.length)w=!0,this._buildRow_Tools(g,h,a,c.id,f)},this)}}}w&&(r.set(u.byId(this.id+"_"+a.id+"_"+c.id),"display","block"),-1<t&&(r.set(u.byId(this.id+"_"+a.id+"_"+t+"_group"),"display","block"),this._findParentGroup(a.id,a,t)));return w},_sanitizeLegendResponse:function(a,c,g){var b=c.legend;if(10.1<=a.version&&1<b.length&&!c._sanitized){a=l.getObject("layerDefinition.drawingInfo.renderer",
!1,g);var e,w;a||(a=l.getObject("drawingInfo.renderer",!1,g));d.some(b,function(a){if(a.values)return!0})&&d.some(b,function(a,c){a.values||(w=c,e=a);return!!e});a?"uniqueValue"===a.type?e&&(b.splice(w,1),b.push(e)):"classBreaks"===a.type&&(e&&b.splice(w,1),b.reverse(),e&&b.push(e)):e&&(b.splice(w,1),b.push(e));c._sanitized=!0}},_buildRow_Tools:function(a,c,g,t,e){var d=b.create("tr",{},c),v;this.alignRight?(c=b.create("td",{align:this._isRightToLeft?"left":"right"},d),v=b.create("td",{align:this._isRightToLeft?
"left":"right",width:35},d)):(v=b.create("td",{width:35,align:"center"},d),c=b.create("td",{},d));d=a.url;(!k("ie")||9<=k("ie")||9>k("ie")&&"esri.layers.ArcGISImageServiceLayer"===g.declaredClass)&&a.imageData&&0<a.imageData.length?d="data:image/png;base64,"+a.imageData:0!==a.url.indexOf("http")&&(d=g.url+"/"+t+"/images/"+a.url,(t=g._getToken())&&(d+="?token\x3d"+t));t=b.create("img",{src:d,border:0,style:"opacity:"+g.opacity},v);a=b.create("td",{innerHTML:z.encode(a.label),align:this._align},b.create("tr",
{},b.create("tbody",{},b.create("table",{width:"95%",dir:"ltr"},c))));e&&("Stretched"===e&&10.3<=g.version&&"esri.layers.ArcGISImageServiceLayer"===g.declaredClass)&&(a.style.verticalAlign="top",a.style.lineHeight="1",t.style.marginBottom="-1px",t.style.display="block",c.style.verticalAlign="top");9>k("ie")&&(t.style.filter="alpha(opacity\x3d"+100*g.opacity+")")},_getVariable:function(a,c,g){var b;a&&(b=(a=a.getVisualVariablesForType(c,g))&&a[0]);return b},_getVariables:function(a,c,g){a=[this._getVariable(a,
"colorInfo",!1),this._getVariable(a,"opacityInfo",!1),this._getVariable(a,"sizeInfo",!1)];return c?d.filter(a,function(a){return!(!a||!(a.field===c&&a.normalizationField==g))}):a},_getFieldAlias:function(a,c){var g=c.infoTemplate,g=g&&g.getFieldInfo&&g.getFieldInfo(a),b=l.isFunction(a)?null:c.getField(a),e=g||b,d="";e&&(d=g&&g.label||b&&b.alias||e.name||e.fieldName);return d},_getRampTitle:function(a,c){var g,b=a.field,e=a.normalizationField,d=!1,v=!1,k=!1,f,b=l.isFunction(b)?null:b,e=l.isFunction(e)?
null:e;if(a.legendOptions&&a.legendOptions.title)g=a.legendOptions.title;else{if(c.renderer.authoringInfo&&c.renderer.authoringInfo.visualVariables){var s=c.renderer.authoringInfo.visualVariables;for(f=0;f<s.length;f++){var m=s[f];if("colorInfo"===m.type&&"ratio"===m.style){d=!0;break}else if("colorInfo"===m.type&&"percent"===m.style){v=!0;break}else if("colorInfo"===m.type&&"percentTotal"===m.style){k=!0;break}}}(d=k&&"showRatioPercentTotal"||v&&"showRatioPercent"||d&&"showRatio"||e&&"showNormField"||
b&&"showField"||null)&&(g=G.substitute({field:b&&this._getFieldAlias(b,c),normField:e&&this._getFieldAlias(e,c)},this._i18n[d]))}return g},_getRendererTitle:function(a,c){var g;if(a){var b,e,d;a instanceof I&&(b=a.attributeField,e=a.normalizationField,d="percent-of-total"===a.normalizationType);b=l.isFunction(b)?null:b;(d=(e=l.isFunction(e)?null:e)&&"showNormField"||(d?"showNormPct":null)||b&&"showField"||null)&&(g=G.substitute({field:b&&this._getFieldAlias(b,c),normField:e&&this._getFieldAlias(e,
c)},this._i18n[d]))}return g},_buildLegendItems_Renderer:function(a,c,g){var t=c.parentLayerId,e=this.map,w=e.getScale(),v,k=!1;if(!this._respectCurrentMapScale||this._isLayerInScale(a,c,w)){var f,s,m="esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass?a.renderer.renderer:a.renderer,h,n,p,q,x;if(m instanceof V&&(m=(m="zoom"===m.rangeType?m.getRendererInfoByZoom(e.getZoom()):m.getRendererInfoByScale(w))&&m.renderer,!m))return!1;var C=this._getVariables(m),y=d.filter(C,function(a){return!!a}).length,
w=C[0],e=C[1],C=C[2],B,A;w&&(h=this._getMedianColor(m,w),w.field&&(p=l.isFunction(w.field)?null:a.getField(w.field)));e&&e.field&&(x=l.isFunction(e.field)?null:a.getField(e.field));C&&C.field&&(q=l.isFunction(C.field)?null:a.getField(C.field));if(m instanceof Y)v=k=!0,this._showHeatRamp(a,c,m,g);else if(m instanceof W)v=k=!0,this._showDotDensityLegend(a,c,m,g);else if(m instanceof X)v=k=!0,s=b.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},g),f=b.create("tbody",
{},s),(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(s,a,c),m.latestObservationRenderer&&m.latestObservationRenderer instanceof H&&this._buildRow_Renderer(a,m.latestObservationRenderer.symbol,h,z.encode(m.latestObservationRenderer.label)||this.NLS_currentObservations,null,f),m.observationRenderer&&m.observationRenderer instanceof H&&this._buildRow_Renderer(a,m.observationRenderer.symbol,h,z.encode(m.observationRenderer.label)||this.NLS_previousObservations,null,f);else if(m instanceof L){if(m.infos&&
0<m.infos.length){v=k=!0;s=b.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},g);f=b.create("tbody",{},s);(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(s,a,c);m.attributeField&&C&&this._addSubHeader(f,this._getFieldAlias(m.attributeField,a));var E=[];d.forEach(m.infos,function(c){var g=null;a._editable&&a.types&&(g=this._getTemplateFromTypes(a.types,c.value));var b=c.label;null==b&&(b=c.value);-1===d.indexOf(E,b)&&(E.push(b),this._buildRow_Renderer(a,c.symbol,
h,z.encode(b),g,f))},this)}A=this._displayDefaultSymbol(a,m,g)}else if(m instanceof I){if(m.infos&&0<m.infos.length||"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass){v=k=!0;B=this._isUnclassedRenderer(m);!w&&1===m.infos.length&&(n=(n=m.infos[0])&&n.symbol);B||(s=b.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},g),f=b.create("tbody",{},s),y=this._getRendererTitle(m,a),this._buildRow_Renderer(a,null,h,z.encode(y),null,f));s=b.create("table",{cellpadding:0,
cellspacing:0,width:"95%","class":"esriLegendLayer"},g);f=b.create("tbody",{},s);(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(s,a,c);if(!B||!C)y=m.infos.slice(0).reverse(),d.forEach(y,function(c){var g=c.label;null==g&&!B&&(g=c.minValue+" - "+c.maxValue);this._buildRow_Renderer(a,c.symbol,h,z.encode(g),null,f)},this);if("esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass&&(a.renderer.style===O.STYLE_SCALAR||a.renderer.style===O.STYLE_SINGLE_ARROW))this._buildRow_Renderer(a,m.defaultSymbol,
null,"",null,f),a._hideDefaultSymbol=!0}B||(A=this._displayDefaultSymbol(a,m,g))}else m instanceof H&&(v=k=!0,s=b.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},g),f=b.create("tbody",{},s),(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(s,a,c),n=null,a._editable&&(a.templates&&0<a.templates.length)&&(n=a.templates[0]),s=1<y?null:p||x||q,this._buildRow_Renderer(a,m.symbol,h,z.encode(s?this._getRampTitle(1<y?null:w||e||C,a):m.label),n,f),n=w?null:m.symbol,
s&&(p=x=q=null));if(v){if(w&&(w.field||w.valueExpression))this._showGradientRamp(a,c,m,null,g,w,p,null,C?!0:!1);if(C&&(C.field||C.valueExpression))v=w||m instanceof L?!1:!0,this._showSizeLegend(a,c,m,C,h,g,q,null,v);if(e&&(e.field||e.valueExpression))q=n&&!n.url&&n.color?n.color:this.transparencyRampColor,this._showGradientRamp(a,c,m,q,g,e,x,null,!1)}A||(A=this._displayDefaultSymbol(a,m,g));k=k||A}k&&(r.set(u.byId(this.id+"_"+a.id+"_"+c.id),"display","block"),-1<t&&(r.set(u.byId(this.id+"_"+a.id+
"_"+t+"_group"),"display","block"),this._findParentGroup(a.id,t)));return k},_isUnclassedRenderer:function(a,c){var g;if(a instanceof I&&a.infos&&1===a.infos.length){g=a.attributeField;var b=a.normalizationField;g=c?g===c:!!this._getVariables(a,g,b).length}return g},_displayDefaultSymbol:function(a,c,g){var d;!a._hideDefaultSymbol&&c.defaultSymbol&&(d=!0,g=b.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},g),g=b.create("tbody",{},g),this._buildRow_Renderer(a,c.defaultSymbol,
null,z.encode(c.defaultLabel)||"others",null,g));return d},_showGradientRamp:function(a,c,g,d,e,w,k,f,h){h=b.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"+(!h?" esriLegendSubFragment":"")},e);e=b.create("tbody",{},h);(a._hoverLabel||a._hoverLabels||f)&&this._createHoverAction(h,a,c,f);(k||w.valueExpression)&&this._addSubHeader(e,this._getRampTitle(w,a));c=w.field;var s;c&&(s=l.isFunction(c)?null:a.getField(c));(w=this._getRampStops(g,w,d,s&&"esriFieldTypeDate"===
s.type))&&w.length&&this._drawGradientRamp(e,w,!0,a,this._getRampBorderColor(g),!!d)},_getMedianColor:function(a,c){var g,b;c.colors?(g=c.minDataValue,b=c.maxDataValue):c.stops&&(g=c.stops[0].value,b=c.stops[c.stops.length-1].value);return a.getColor(g+(b-g)/2,{colorInfo:c})},_getRampStops:function(a,c,b,t){var e,w,f,k,l=!1;c.colors||c.opacityValues?(w=c.maxDataValue-c.minDataValue,e=d.map([0,0.25,0.5,0.75,1],function(a){f=c.minDataValue+a*w;return Number(f.toFixed(6))}),this._checkPrecision(0,4,
e)):c.stops&&(e=d.map(c.stops,function(a){return a.value}),(l=d.some(c.stops,function(a){return!!a.label}))&&(k=d.map(c.stops,function(a){return a.label})));var h=e[0],m,n;w=e[e.length-1]-h;return d.map(e,function(d,f){b?(m=new A(b.toRgba()),n=a.getOpacity(d,{opacityInfo:c}),null!=n&&(m.a=n)):m=a.getColor(d,{colorInfo:c});var v="";if(l)v=k[f];else{var v=t?K.formatDate(d,K.timelineDateFormatOptions):E.format(d),r="";0===f?r=this._specialChars.lt+" ":f===e.length-1&&(r=this._specialChars.gt+" ");v=
r+v}return{value:d,color:m,offset:1-(d-h)/w,label:v}},this).reverse()},_checkPrecision:function(a,c,b){var d=a+(c-a)/2,e=b[a],f=b[d],k=b[c],l=Math.floor(e),h=Math.floor(f),s=Math.floor(k);l===e&&(s===k&&h!==f&&l!==h&&s!==h)&&(b[d]=h);a+1!==d&&this._checkPrecision(a,d,b);d+1!==c&&this._checkPrecision(d,c,b)},_getRampBorderColor:function(a){var c;if(a instanceof H)c=a.symbol;else if(a instanceof L||a instanceof I)c=a.infos[0].symbol;return(a=c&&-1===c.type.indexOf("linesymbol")?c.getStroke():null)&&
a.color},_drawGradientRamp:function(a,c,g,t,e,f){var v=b.create("tr",{},a),l,h,s,m,n,p=c.length-1,q;m=0;this.alignRight?(a=b.create("td",{align:this._isRightToLeft?"left":"right"},v),l=b.create("td",{align:this._isRightToLeft?"left":"right",width:this.gradientWidth},v)):(l=b.create("td",{width:this.gradientWidth,align:"center"},v),a=b.create("td",{},v));v=e&&0<e.a&&!(240<=e.r&&240<=e.g&&240<=e.b);h=b.create("div",{"class":v?"":"esriLegendBorderLessColorRamp",style:"position: relative; width:"+this.gradientWidth+
"px;"},l);l=b.create("div",{"class":"esriLegendColorRamp"+(f?" esriLegendTransparencyRamp":"")},h);f=r.get(l,"width");v&&(e=9>k("ie")?e.toHex():"rgba("+e.toRgba().join(",")+")",r.set(l,"border",this.colorRampBorder+" "+e));g?(e=this.gradientHeight*p,r.set(l,"height",e+"px")):e=r.get(l,"height");r.set(h,"height",e+"px");v=B.createSurface(l,f,e);9>k("ie")&&(m=v.getEventSource(),r.set(m,"position","relative"),r.set(m.parentNode,"position","relative"),m=1);try{g&&d.forEach(c,function(a,c){a.offset=c/
p}),n=v.createRect({x:-m,y:-m,width:f+m,height:e+m}),n.setFill({type:"linear",x1:0,y1:0,x2:0,y2:e,colors:c}).setStroke(null),v.createRect({width:f,height:e}).setFill(new A([255,255,255,1-t.opacity])).setStroke(null),this._surfaceItems.push(v)}catch(u){v.clear(),v.destroy()}d.forEach(c,function(a,g){if(a.label){q="top:"+100*a.offset+"%;";var e="";0===g&&(e+=" esriLegendColorRampTickFirst");g===c.length-1&&(e+=" esriLegendColorRampTickLast");b.create("div",{"class":"esriLegendColorRampTick"+e,innerHTML:"\x26nbsp;",
style:q},h)}});s=b.create("div",{"class":"esriLegendColorRampLabels",style:{height:e+this.gradientHeight+"px"}},a);g?d.forEach(c,function(a){b.create("div",{"class":"esriLegendColorRampLabel",innerHTML:z.encode(a.label)||"\x26nbsp;"},s)}):(b.create("div",{"class":"esriLegendColorRampLabel",innerHTML:this._i18n.high},s),b.create("div",{"class":"esriLegendColorRampLabel",innerHTML:this._i18n.low,style:"top: "+(e+this.gradientHeight-2*this.gradientHeight)+"px;"},s))},_showHeatRamp:function(a,c,g,d,e){var f,
k=g.field;f=b.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},d);d=b.create("tbody",{},f);(a._hoverLabel||a._hoverLabels||e)&&this._createHoverAction(f,a,c,e);(k=k&&a.getField(k))&&this._addSubHeader(d,this._getFieldAlias(k.name,a));c=this._getHeatmapStops(g);c.length&&this._drawGradientRamp(d,c,!1,a)},_getHeatmapStops:function(a){var c=a.colorStops;a=a.colors;var b,t,e,f;if(c&&c[0])if(b=c.length-1,a=c[0]&&null!=c[0].ratio){if((a=c[b])&&1!==a.ratio)c=c.slice(0),
c.push({ratio:1,color:a.color}),b++}else t=c[0].value,e=c[b].value-t,c=d.map(c,function(a){return{color:a.color,ratio:(a.value-t)/e}});else a&&a[0]&&(b=a.length-1,f=1/(a.length-1),c=d.map(a,function(a,c){return{color:a,ratio:c*f}}));c=d.map(c,function(a,c){var e="";0===c?e="Low":c===b&&(e="High");return{color:a.color,label:e,offset:1-a.ratio}});return c.reverse()},_showDotDensityLegend:function(a,c,g,t){var e=g.legendOptions,f,k,h,n,s,m,r,p=this.dotDensitySwatchSize,q=Math.round(p/2);e&&(k=e.backgroundColor,
h=e.outline,n=e.valueUnit,s=e.dotCoverage);s=(s||this.dotCoverage)/100;r=Math.round(p*p/Math.pow(g.dotSize,2)*s);t=b.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},t);m=b.create("tbody",{},t);(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(t,a,c);this._addSubHeader(m,G.substitute({value:g.dotValue,unit:n||""},this.NLS_dotValue));d.forEach(g.fields,function(c){c=l.mixin({},c);c.numPoints=r;f=new Z(g._generateImageSrc(p,p,[c],{x:0,y:0},{x:p,y:p},k),h||g.outline,
p,p);c=a.getField(c.name)||c;this._buildRow_Renderer(a,f,null,z.encode(this._getFieldAlias(c.name,a)),null,m,{type:"path",path:"M "+-q+","+-q+" L "+q+","+-q+" L "+q+","+q+" L "+-q+","+q+" L "+-q+","+-q+" E"})},this)},_showSizeLegend:function(a,c,g,d,e,f,k,h,n){var s=d.legendOptions,s=s&&s.customValues;e=this._getSizeSymbol(g,e);if(!(d.valueUnit&&"unknown"!==d.valueUnit||!e||!s&&(null==d.minSize||null==d.maxSize))){n=b.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"+
(!n?" esriLegendSubFragment":"")},f);f=b.create("tbody",{},n);(a._hoverLabel||a._hoverLabels||h)&&this._createHoverAction(n,a,c,h);(k||d.valueExpression)&&this._addSubHeader(f,this._getRampTitle(d,a));c=d.field;var m;c&&(m=l.isFunction(c)?null:a.getField(c));m=m&&"esriFieldTypeDate"===m.type;s=s||this._getDataValues(g,e,d,m);for(c=n=s.length-1;0<=c;c--)k=s[c],e=M.fromJson(e.toJson()),this._applySize(e,g,d,k),k=m?K.formatDate(k,K.timelineDateFormatOptions):E.format(k),h="",c===n?h=this._specialChars.gt+
" ":0===c&&(h=this._specialChars.lt+" "),h="\x3cspan class\x3d'esriLegendSizeRampLabel'\x3e"+z.encode(h+k)+"\x3c/span\x3e",this._buildRow_Renderer(a,e,null,h,null,f)}},_getSizeSymbol:function(a,c){var b,d;if(a instanceof H)b=a.symbol;else if(a instanceof O)b=a.defaultSymbol;else if(a instanceof L||a instanceof I)b=a.infos[0].symbol,d=1<a.infos.length;if(b=b&&-1!==b.type.indexOf("fillsymbol")?null:b)if(b=M.fromJson(b.toJson()),c||d)-1!==b.type.indexOf("linesymbol")?b.setColor(new A(this.sizeRampDarkColor)):
(b.setColor(new A(this.sizeRampLightColor)),b.setOutline&&(d=new $,d.setColor(new A(this.sizeRampDarkColor)),d.setWidth(1.5),b.setOutline(d)));return b},_getDataValues:function(a,c,b,f,e,k){e=null==e?5:e;k=null==k?20:k;var h=a.getSizeRangeAtScale(b,this.map.getScale());e=this._interpolateSizeRange(h,e);var l=d.map(e,function(a){return this._getDataValueFromSize(a,b,h)},this);if(!f){var n,l=E.round(l);for(f=1;f<l.length-1;f++)if(n=this._roundDataValue(a,c,b,l[f],l[f-1],k))l[f]=n[0],e[f]=n[1]}return l},
_interpolateSizeRange:function(a,c){var b=a.minSize,d=(a.maxSize-b)/(c-1),e,f=[];for(e=0;e<c;e++)f.push(b+d*e);return f},_getDataValueFromSize:function(a,c,b){var d=b.minSize;b=b.maxSize;var e=c.minDataValue;c=c.maxDataValue;return a=a<=d?e:a>=b?c:(a-d)/(b-d)*(c-e)+e},_roundDataValue:function(a,c,b,d,e,f){var k=this._getSize(c,a,b,d);e=this._getSize(c,a,b,e);var h,l=E.getDigits(d),n=l.integer,l=l.fractional,m,r,p,q,u,x,y,B,z,A,D;0<d&&1>d&&(h=Math.pow(10,l),d*=h,n=E.getDigits(d).integer);for(n-=1;0<=
n&&!(m=Math.pow(10,n),l=Math.floor(d/m)*m,m*=Math.ceil(d/m),null!=h&&(l/=h,m/=h),r=(l+m)/2,r=E.round([l,r,m],{indexes:[1]})[1],p=this._getSize(c,a,b,l),q=this._getSize(c,a,b,m),u=this._getSize(c,a,b,r),x=E.getPctChange(k,p,e,null),y=E.getPctChange(k,q,e,null),B=E.getPctChange(k,u,e,null),z=x.prev<=f,A=y.prev<=f,z&&A&&(x.prev<=y.prev?(z=!0,A=!1):(A=!0,z=!1)),z?D=[l,p]:A?D=[m,q]:B.prev<=f&&(D=[r,u]),D);n--);return D},_applySize:function(a,c,b,d){var e=a.type;c=this._getSize(a,c,b,d);switch(e){case "simplemarkersymbol":a.setSize(c);
break;case "picturemarkersymbol":e=a.width;b=a.height;a.setHeight(c);a.setWidth(c*(e/b));break;case "simplelinesymbol":case "cartographiclinesymbol":a.setWidth(c);break;case "textsymbol":a.font&&a.font.setSize(c)}},_getSize:function(a,c,b,d){return c.getSize(d,{sizeInfo:b,scale:this.map.getScale(),shape:-1!==a.type.indexOf("markersymbol")?a.style:null})},_buildRow_Renderer:function(a,c,d,f,e,k,l){var h=b.create("tr",{},k),n;this.alignRight?(k=b.create("td",{align:this._isRightToLeft?"left":"right"},
h),c&&(n=b.create("td",{align:this._isRightToLeft?"left":"right",width:35},h))):(c&&(n=b.create("td",{width:35,align:"center"},h)),k=b.create("td",{},h));var s=h=30,m;if(c){if("simplemarkersymbol"==c.type)h=Math.min(Math.max(h,c.size+12),125),s=Math.min(Math.max(s,c.size+12),125);else if("picturemarkersymbol"==c.type)h=Math.min(Math.max(h,c.width),125),s=Math.min(c.height||s,125);else if("textsymbol"==c.type){var r,p;c.text||(r=c.text,p=!0,c.setText(this.defaultText));h=Math.min(Math.max(h,c.getWidth()+
12),125);s=Math.min(Math.max(s,c.getHeight()+12),125);p&&c.setText(r)}m=b.create("div",{style:"width:"+h+"px;height:"+s+"px;"},n)}G.isDefined(f)&&"number"===typeof f&&(f=""+f);b.create("td",{innerHTML:f||"",align:this._align},b.create("tr",{},b.create("tbody",{},b.create("table",{width:"95%"},k))));c&&(a=this._drawSymbol(m,c,d,h,s,e,a,l),this._surfaceItems.push(a))},_addSubHeader:function(a,c){var d=b.create("tr",{},a),d=b.create("td",{align:this._align,colspan:2},d);b.create("td",{innerHTML:z.encode(c)||
"",align:this._align},b.create("tr",{},b.create("tbody",{},b.create("table",{width:"95%"},d))))},_drawSymbol:function(a,c,b,d,e,f,h,p){c=M.fromJson(c.toJson());var q=h.opacity;b&&c.setColor(new A(b.toRgba()));if("simplelinesymbol"===c.type||"cartographiclinesymbol"===c.type||"textsymbol"===c.type){if(!c.color)return;b=c.color.toRgba();b[3]*=q;c.color.setColor(b)}else"simplemarkersymbol"===c.type||"simplefillsymbol"===c.type?(c.color&&(b=c.color.toRgba(),b[3]*=q,c.color.setColor(b)),c.outline&&c.outline.color&&
(b=c.outline.color.toRgba(),b[3]*=q,c.outline.color.setColor(b))):"picturemarkersymbol"===c.type&&(a.style.opacity=q,a.style.filter="alpha(opacity\x3d("+100*q+"))");a=B.createSurface(a,d,e);9>k("ie")&&(b=a.getEventSource(),r.set(b,"position","relative"),r.set(b.parentNode,"position","relative"));f=this._getDrawingToolShape(c,f)||M.getShapeDescriptors(c);var s,q=(b=f.defaultShape)&&"text"===b.type;try{q&&!b.text&&(b.text=this.defaultText),s=a.createShape(p||b).setFill(f.fill).setStroke(f.stroke),q&&
s.setFont(f.font)}catch(m){a.clear();a.destroy();return}var u=s.getBoundingBox();p=u.width;f=u.height;var q=-(u.x+p/2),x=-(u.y+f/2);b=a.getDimensions();q={dx:q+b.width/2,dy:x+b.height/2};if("simplemarkersymbol"===c.type&&"path"===c.style)d=h._getScaleMatrix(u,c.size),s.applyTransform(n.scaleAt(d.xx,d.yy,{x:b.width/2,y:b.height/2}));else if(p>d||f>e)h=p/d>f/e,d=((h?d:e)-5)/(h?p:f),l.mixin(q,{xx:d,yy:d});s.applyTransform(q);return a},_getDrawingToolShape:function(a,b){var d;switch(b?b.drawingTool||
null:null){case "esriFeatureEditToolArrow":d={type:"path",path:"M 10,1 L 3,8 L 3,5 L -15,5 L -15,-2 L 3,-2 L 3,-5 L 10,1 E"};break;case "esriFeatureEditToolTriangle":d={type:"path",path:"M -10,14 L 2,-10 L 14,14 L -10,14 E"};break;case "esriFeatureEditToolRectangle":d={type:"path",path:"M -10,-10 L 10,-10 L 10,10 L -10,10 L -10,-10 E"};break;case "esriFeatureEditToolCircle":d={type:"circle",cx:0,cy:0,r:10};break;case "esriFeatureEditToolEllipse":d={type:"ellipse",cx:0,cy:0,rx:10,ry:5};break;default:return null}return{defaultShape:d,
fill:a.getFill(),stroke:a.getStroke()}},_repaintItems:function(){d.forEach(this._surfaceItems,function(a){this._repaint(a)},this)},_repaint:function(a){if(a){a.getStroke&&a.setStroke&&a.setStroke(a.getStroke());try{a.getFill&&a.setFill&&a.setFill(a.getFill())}catch(b){}a.children&&l.isArray(a.children)&&d.forEach(a.children,this._repaint,this)}},_createHoverAction:function(a,c,d,f){if(f=c._hoverLabel||c._hoverLabels&&c._hoverLabels[d.id]||f)f=z.encode(f),c.mouseMoveHandler=c.mouseMoveHandler||{},
c.mouseMoveHandler[d.id]=h.connect(a,"onmousemove",l.hitch(this,function(a,c){this.mouseX=c.clientX;this.mouseY=c.clientY;this.hoverLabelShowing&&(this.hoverLabelShowing=!1,r.set(u.byId(this.id+"_hoverLabel"),"display","none"));setTimeout(l.hitch(this,function(a,c,d){if(a==this.mouseX&&c==this.mouseY&&!this.hoverLabelShowing)if(this.hoverLabelShowing=!0,u.byId(this.id+"_hoverLabel")){var e=u.byId(this.id+"_hoverLabel");e.innerHTML="\x3cspan\x3e"+d+"\x3c/span\x3e";r.set(e,"top",c+"px");r.set(e,"left",
a+15+"px");r.set(e,"display","")}else b.create("div",{innerHTML:"\x3cspan\x3e"+d+"\x3c/span\x3e",id:this.id+"_hoverLabel","class":"esriLegendHoverLabel",style:{top:c+"px",left:a+15+"px"}},document.body)},c.clientX,c.clientY,a),500)},f)),c.mouseOutHandler=c.mouseOutHandler||{},c.mouseOutHandler[d.id]=h.connect(a,"onmouseout",l.hitch(this,function(a){this.mouseY=this.mouseX=-1;this.hoverLabelShowing&&(this.hoverLabelShowing=!1,r.set(u.byId(this.id+"_hoverLabel"),"display","none"))}))},_removeHoverHandlers:function(){var a;
d.forEach(this.layers,function(b){if(b.mouseMoveHandler)for(a in b.mouseMoveHandler)h.disconnect(b.mouseMoveHandler[a]);if(b.mouseOutHandler)for(a in b.mouseOutHandler)h.disconnect(b.mouseOutHandler[a])})},_createDynamicLayers:function(a){var b=[],g;d.forEach(a.dynamicLayerInfos||a.layerInfos,function(d){g={id:d.id};g.source=d.source&&d.source.toJson();var e;a.layerDefinitions&&a.layerDefinitions[d.id]&&(e=a.layerDefinitions[d.id]);e&&(g.definitionExpression=e);var f;a.layerDrawingOptions&&a.layerDrawingOptions[d.id]&&
(f=a.layerDrawingOptions[d.id]);f&&(g.drawingInfo=f.toJson());g.minScale=d.minScale||0;g.maxScale=d.maxScale||0;b.push(g)});return b},_getTemplateFromTypes:function(a,b){var d;for(d=0;d<a.length;d++)if(a[d].id==b&&a[d].templates&&0<a[d].templates.length)return a[d].templates[0];return null},_findParentGroup:function(a,b,d){var f,e=b.dynamicLayerInfos||b.layerInfos;for(f=0;f<e.length;f++)if(d==e[f].id){-1<e[f].parentLayerId&&(r.set(u.byId(this.id+"_"+a+"_"+e[f].parentLayerId+"_group"),"display","block"),
this._findParentGroup(a,b,e[f].parentLayerId));break}},_addSubLayersToHide:function(a){function b(f,k){var e=a.layer.dynamicLayerInfos||a.layer.layerInfos,h,l;for(h=0;h<e.length;h++)if(e[h].id===f&&e[h].subLayerIds)for(l=0;l<e[h].subLayerIds.length;l++){var n=e[h].subLayerIds[l];-1===d.indexOf(k,n)&&(k.push(n),b(n,k))}}a.layer.layerInfos&&d.forEach(this.hideLayersInLegend[a.layer.id],function(d){b(d,this.hideLayersInLegend[a.layer.id])},this)},_isLayerInScale:function(a,b,d){var f,e=!0;if(a.legendResponse&&
a.legendResponse.layers)for(f=0;f<a.legendResponse.layers.length;f++){var k=a.legendResponse.layers[f];if(b.id==k.layerId){var h,l;!a.minScale&&0!==a.minScale||!a.maxScale&&0!==a.maxScale?(0==k.minScale&&a.tileInfo&&(h=a.tileInfo.lods[0].scale),0==k.maxScale&&a.tileInfo&&(l=a.tileInfo.lods[a.tileInfo.lods.length-1].scale)):(h=Math.min(a.minScale,k.minScale)||a.minScale||k.minScale,l=Math.max(a.maxScale,k.maxScale));if(0<h&&h<d||l>d)e=!1;break}}else if(a.minScale||a.maxScale)if(a.minScale&&a.minScale<
d||a.maxScale&&a.maxScale>d)e=!1;return e},_getServiceTitle:function(a){var b=a._titleForLegend;b||((b=a.url)?-1<a.url.indexOf("/MapServer")?(b=a.url.substring(0,a.url.indexOf("/MapServer")),b=b.substring(b.lastIndexOf("/")+1,b.length)):-1<a.url.indexOf("/ImageServer")?(b=a.url.substring(0,a.url.indexOf("/ImageServer")),b=b.substring(b.lastIndexOf("/")+1,b.length)):-1<a.url.indexOf("/FeatureServer")&&(b=a.url.substring(0,a.url.indexOf("/FeatureServer")),b=b.substring(b.lastIndexOf("/")+1,b.length)):
b="",a.name&&(b=0<b.length?b+(" - "+a.name):a.name));"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass&&a.vectorFieldPixelFilter&&(a=a.vectorFieldPixelFilter.outputUnit?this["NLS_"+a.vectorFieldPixelFilter.outputUnit]:this["NLS_"+a.vectorFieldPixelFilter.inputUnit],G.isDefined(a)&&(b+=" ("+a+")"));return z.encode(b)},_getEffectiveScale:function(a,b){var d=b.minScale,f=b.maxScale;if(G.isDefined(b.parentLayerId)){var e=a.layerInfos,k=b.parentLayerId,h;for(h=e.length-1;0<=h;h--)if(e[h].id==
k)if(0==d&&0<e[h].minScale?d=e[h].minScale:0<d&&0==e[h].minScale||0<d&&0<e[h].minScale&&(d=Math.min(d,e[h].minScale)),f=Math.max(f||0,e[h].maxScale||0),-1<e[h].parentLayerId)k=e[h].parentLayerId;else break}return{minScale:d,maxScale:f}},_isSupportedLayerType:function(a){return a&&("esri.layers.ArcGISDynamicMapServiceLayer"===a.declaredClass||"esri.layers.ArcGISImageServiceLayer"===a.declaredClass&&10.2<=a.version||"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass||"esri.layers.ArcGISTiledMapServiceLayer"===
a.declaredClass||"esri.layers.FeatureLayer"===a.declaredClass||"esri.layers.StreamLayer"===a.declaredClass||"esri.layers.KMLLayer"===a.declaredClass||"esri.layers.GeoRSSLayer"===a.declaredClass||"esri.layers.WMSLayer"===a.declaredClass||"esri.layers.WFSLayer"===a.declaredClass||"esri.layers.CSVLayer"===a.declaredClass)?!0:!1}});l.mixin(F,{ALIGN_LEFT:0,ALIGN_RIGHT:1});k("extend-esri")&&l.setObject("dijit.Legend",F,N);return F});