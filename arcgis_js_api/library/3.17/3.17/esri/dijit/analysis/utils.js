// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.17/esri/copyright.txt for details.
//>>built
define("esri/dijit/analysis/utils","dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/connect dojo/_base/event dojo/_base/json dojo/dom-attr dojo/has dojo/i18n dojo/io-query dojo/i18n!../../nls/jsapi dojo/json dojo/string dojo/query dojo/date/locale dojo/dom-style dojo/dom-class dojo/dom-construct dojo/Deferred dojo/number dojo/_base/window dojo/when dojo/dom dojo/data/ItemFileWriteStore dojo/topic dijit/registry dijit/Dialog dijit/form/CheckBox ../../kernel ../../lang ../../request ./HelpWindow ../../tasks/query ../../dijit/BrowseItems ../../layers/FeatureLayer ./PluginAnalysisLayers ../../tasks/Geoprocessor ../../dijit/SingleFilter ./FeatureRecordSetLayer ./PluginLayers ../../layers/ArcGISImageServiceLayer".split(" "),
function(x,g,p,H,I,J,A,K,aa,L,r,M,k,s,B,t,N,q,C,y,O,D,ba,P,Q,R,S,E,T,h,F,U,V,W,X,ca,Y,da,Z,ea,$){x={};g.mixin(x,{_helpDialog:null,i18n:null,initHelpLinks:function(a,b,c){this._helpDialog||(this._helpDialog=new U);if(a){var d=R.byNode(a),e=d?d.get("helpFileName"):c&&c.helpFileName?c.helpFileName:null,f=d?d.get("isSingleTenant"):c&&c.isSingleTenant?c.isSingleTenant:!1;d&&(d.showGeoAnalyticsParams||d.showBigData)||c&&c.analysisMode&&"bigdata"===c.analysisMode?e+="_bd":c&&(c.analysisMode&&"raster"===
c.analysisMode)&&(e+="_ro");s("[esriHelpTopic]",a).forEach(function(d,m,l){d&&(t.set(d,"display",!h.isDefined(b)||!0===b?"":"none"),H.connect(d,"onclick",g.hitch(this,function(b){I.stop(b);this._helpDialog.show(b,{helpId:A.get(d,"esriHelpTopic"),helpFileName:e,analysisGpServer:c&&c.analysisGpServer?c.analysisGpServer:null,helpParentNode:a,isPortal:f})})))},this)}},constructAnalysisFeatColl:function(a){var b={},c;b.featureCollection=a.layerDefinition;for(c in b.featureCollection)b.featureCollection.hasOwnProperty(c)&&
"objectIdField"===c&&(b.featureCollection.objectIdFieldName=g.clone(b.featureCollection.objectIdField),delete b.featureCollection.objectIdField);b.featureCollection.features=a.featureSet.features;return b},constructAnalysisInputLyrObj:function(a,b){var c={},d,e=a.getMap()||a._map,f;if(a.url&&!a._collection){c={url:a.url};d=this.isHostedService(a.url);f=10.2<=a.version&&a._useStandardizedQueries;a.getDefinitionExpression&&a.getDefinitionExpression()?c.filter=a.getDefinitionExpression():h.isDefined(a.definitionExpression)&&
""!==a.definitionExpression&&(c.filter=a.definitionExpression);if(a.useMapTime&&a.timeInfo&&e&&e.timeExtent&&(f||d||10.2<=a.version))f="",a.timeInfo.startTimeField&&!a.timeInfo.endTimeField?(e.timeExtent.startTime&&(f=a.timeInfo.startTimeField+" \x3e "+(d?"":"timestamp ")+"'"+this.formatDate(e.timeExtent.startTime)+"'"),e.timeExtent.endTime&&(e.timeExtent.startTime&&(f+=" AND "),f+=a.timeInfo.startTimeField+" \x3c "+(d?"":"timestamp ")+"'"+this.formatDate(e.timeExtent.endTime)+"'")):!a.timeInfo.startTimeField&&
a.timeInfo.endTimeField?(e.timeExtent.startTime&&(f=a.timeInfo.endTimeField+" \x3e "+(d?"":"timestamp ")+"'"+this.formatDate(e.timeExtent.startTime)+"'"),e.timeExtent.endTime&&(e.timeExtent.startTime&&(f+=" AND "),f+=a.timeInfo.endTimeField+" \x3c "+(d?"":"timestamp ")+"'"+this.formatDate(e.timeExtent.endTime)+"'")):a.timeInfo.startTimeField&&a.timeInfo.endTimeField&&(e.timeExtent.startTime&&(f=a.timeInfo.startTimeField+" \x3e "+(d?"":"timestamp ")+"'"+this.formatDate(e.timeExtent.startTime)+"'"),
e.timeExtent.endTime&&(e.timeExtent.startTime&&(f+=" AND "),f+=a.timeInfo.endTimeField+" \x3c "+(d?"":"timestamp ")+"'"+this.formatDate(e.timeExtent.endTime)+"'")),c.filter=c.filter?c.filter+(" AND "+f):f;a.credential&&(c.serviceToken=a.credential.token);-1!==c.url.indexOf("?")&&(d=c.url.substring(c.url.indexOf("?")+1,c.url.length),d=L.queryToObject(d),g.mixin(c,d),c.url=c.url.substring(0,c.url.indexOf("?")))}else if(!a.url||a._collection)try{c=a.toJson()}catch(v){a._json=M.parse(a._json),c=a.toJson()}b&&
(c=new Z(c));return c},formatDate:function(a){return B.format(a,{datePattern:"yyyy-MM-dd",selector:"date"})+" "+B.format(a,{selector:"time",timePattern:"HH:mm:ss"})},isHostedService:function(a){if(!a)return!1;var b=-1!==a.indexOf(".arcgis.com/");a=-1!==a.indexOf("//services")||-1!==a.indexOf("//tiles")||-1!==a.indexOf("//features");return b&&a},isTimeEnabled:function(a){var b=10.2<=a.version&&a._useStandardizedQueries;return a.useMapTime&&a.timeInfo&&(b||10.2<=a.version)},isTimeInstantLayer:function(a){return h.isDefined(a.timeInfo)&&
h.isDefined(a.timeInfo.startTimeField)&&!h.isDefined(a.timeInfo.endTimeField)||h.isDefined(a.time)&&h.isDefined(a.time.timeType)&&"instant"===a.time.timeType},buildReport:function(a,b){var c="";b||(b={},g.mixin(b,r.analysisMsgCodes));p.forEach(a,function(a,e){var f,v,m;"string"===typeof a.message?(f=h.isDefined(b[a.messageCode])?b[a.messageCode]:a.message,c+=a.style.substring(0,a.style.indexOf("\x3c/"))+(!this._isEmptyObject(a.params)?k.substitute(f,a.params):f)+a.style.substring(a.style.indexOf("\x3c/"))):
g.isArray(a.message)&&(m=[],v=g.clone(a.style),p.forEach(a.message,function(c,e){v=v.replace(/<\//,"${"+e+"}");f=h.isDefined(b[a.messageCode+"_"+e])?b[a.messageCode+"_"+e]:c;f=!this._isEmptyObject(a.params)?k.substitute(f,a.params):f;m.push(f+"\x3c/")},this),v=k.substitute(v,m),c+=v)},this);return c},getLayerFeatureCount:function(a,b){var c=new V;c.geometry=b.geometry||"";c.where=b.where||"1\x3d1";c.geometryType=b.geometryType||"esriGeometryEnvelope";return a.queryCount(c)},createPolygonFeatureCollection:function(a){var b;
b={layerDefinition:null,featureSet:{features:[],geometryType:"esriGeometryPolygon"}};b.layerDefinition={currentVersion:10.2,copyrightText:"",defaultVisibility:!0,relationships:[],isDataVersioned:!1,supportsRollbackOnFailureParameter:!0,supportsStatistics:!0,supportsAdvancedQueries:!0,geometryType:"esriGeometryPolygon",minScale:0,maxScale:0,objectIdField:"OBJECTID",templates:[],type:"Feature Layer",displayField:"TITLE",visibilityField:"VISIBLE",name:a,hasAttachments:!1,typeIdField:"TYPEID",capabilities:"Query",
allowGeometryUpdates:!0,htmlPopupType:"",hasM:!1,hasZ:!1,globalIdField:"",supportedQueryFormats:"JSON",hasStaticData:!1,maxRecordCount:-1,indexes:[],types:[],drawingInfo:{renderer:{type:"simple",symbol:{color:[0,0,0,255],outline:{color:[0,0,0,255],width:3,type:"esriSLS",style:"esriSLSSolid"},type:"esriSFS",style:"esriSFSNull"},label:"",description:""},transparency:0,labelingInfo:null,fixedSymbols:!0},fields:[{alias:"OBJECTID",name:"OBJECTID",type:"esriFieldTypeOID",editable:!1},{alias:"Title",name:"TITLE",
length:50,type:"esriFieldTypeString",editable:!0},{alias:"Visible",name:"VISIBLE",type:"esriFieldTypeInteger",editable:!0},{alias:"Description",name:"DESCRIPTION",length:1073741822,type:"esriFieldTypeString",editable:!0},{alias:"Type ID",name:"TYPEID",type:"esriFieldTypeInteger",editable:!0}]};return b},createPointFeatureCollection:function(a){var b;b={layerDefinition:null,featureSet:{features:[],geometryType:"esriGeometryPoint"}};b.layerDefinition={objectIdField:"OBJECTID",templates:[],type:"Feature Layer",
drawingInfo:{renderer:{field1:"TYPEID",type:"simple",symbol:{height:24,xoffset:0,yoffset:12,width:24,contentType:"image/png",type:"esriPMS",url:"http://static.arcgis.com/images/Symbols/Basic/GreenStickpin.png"},description:"",value:"0",label:"Stickpin"}},displayField:"TITLE",visibilityField:"VISIBLE",name:a,hasAttachments:!1,typeIdField:"TYPEID",capabilities:"Query",types:[],geometryType:"esriGeometryPoint",fields:[{alias:"OBJECTID",name:"OBJECTID",type:"esriFieldTypeOID",editable:!1},{alias:"Title",
name:"TITLE",length:50,type:"esriFieldTypeString",editable:!0},{alias:"Visible",name:"VISIBLE",type:"esriFieldTypeInteger",editable:!0},{alias:"Description",name:"DESCRIPTION",length:1073741822,type:"esriFieldTypeString",editable:!0},{alias:"Type ID",name:"TYPEID",type:"esriFieldTypeInteger",editable:!0}]};return b},createFolderStore:function(a,b){var c=new P({data:{identifier:"id",label:"name",items:[]}});c.newItem({name:b,id:""});p.forEach(a,function(a){c.newItem({name:a.title,id:a.id})});return c},
setupFoldersUI:function(a){a.folderSelect.set("store",a.folderStore);a.folderSelect.set("required",!0);a.folderSelect.set("searchAttr","name");h.isDefined(a.folderId)?a.folderStore.get(a.folderId).then(g.hitch(this,function(b){h.isDefined(b)?a.folderSelect.set("item",b):a.folderStore.get("").then(function(b){a.folderSelect.set("item",b)},this)})):a.folderName?a.folderStore.fetch({query:{name:a.folderName},onComplete:g.hitch(this,function(b){h.isDefined(b)&&0<b.length?a.folderSelect.set("item",b[0]):
a.folderStore.get("").then(function(b){a.folderSelect.set("item",b)},this)})}):a.username?a.folderSelect.set("displayedValue",a.username):a.folderStore.get("").then(function(b){a.folderSelect.set("item",b)},this)},_isEmptyObject:function(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0},validateServiceName:function(a,b){var c=/(:|&|<|>|%|#|\?|\\|\"|\/|\+)/.test(a),d=!0,e,f;h.isDefined(b)&&b.textInput&&(f=b.textInput);this.initI18n();0===a.length||0===k.trim(a).length?(e=this.i18n.requiredValue,
d=!1):c?(e=this.i18n.invalidServiceName,d=!1):98<a.length?(e=this.i18n.invalidServiceNameLength,d=!1):170<encodeURIComponent(a).length&&(e=this.i18n.invalidEncodedServiceNameLength,d=!1);f&&!d&&f.set("invalidMessage",e);return d},getStepNumber:function(a){s(".esriAnalysisNumberLabel",a).forEach(function(a,c){var d=this._getNumberLabel(c);A.set(a,"innerHTML",d)},this)},_getNumberLabel:function(a){var b="";this.initI18n();switch(a){case 0:b=this.i18n.oneLabel;break;case 1:b=this.i18n.twoLabel;break;
case 2:b=this.i18n.threeLabel;break;case 3:b=this.i18n.fourLabel;break;case 4:b=this.i18n.fiveLabel;break;case 5:b=this.i18n.sixLabel;break;case 6:b=this.i18n.sevenLabel;break;case 7:b=this.i18n.eightLabel;break;case 8:b=this.i18n.nineLabel}return b},populateAnalysisLayers:function(a,b,c,d){if(a){var e=[],f=a.get(b);a._titleRow&&t.set(a._titleRow,"display","none");a._analysisLabelRow&&t.set(a._analysisLabelRow,"display","table-row");a._selectAnalysisRow&&(t.set(a._selectAnalysisRow,"display","table-row"),
N.add(a._analysisSelect.domNode,"esriTrailingMargin3"),t.set(a._analysisSelect.domNode.parentNode,"padding-bottom","1em"));a.domNode&&this.getStepNumber(a.domNode);h.isDefined(d)&&d.chooseLabel&&e.push({value:-1,label:this.i18n.chooseLabel});if(!h.isDefined(d)||!h.isDefined(d.posIncrement))h.isDefined(d)||(d={}),d.posIncrement=0;p.forEach(a.get(c),function(a,b){b+=d.posIncrement;var c={value:h.isDefined(d)&&d.chooseLabel?b+1:b,label:a.name};f&&a.name===f.name&&(c.selected=!0);e.push(c)},this);a._analysisSelect.addOption(e);
a._analysisSelect.set("required",!0)}},isValidAnalysisLayer:function(a){var b,c,d,e,f,g,m,l="",n=!0;b={isValid:n,validationMessage:l};var w,u,z=0,G=0,q=0,r,s,t;if(!h.isDefined(a)||!h.isDefined(a.toolName))return b;this.initI18n();h.isDefined(this.i18n.cblPointMsg)||(this.i18n.cblPointMsg="You need to have at least one point feature layer to run ${toolName}.");b=a.toolName;c=a.featureLayers;d=a.analysisLayer;e=b.charAt(0).toLowerCase()+b.substring(1);m=this.i18n;a=a.showReadyToUseLayers||!1;p.forEach(c,
function(a){a instanceof $&&(r=!0);r&&1<a.bandCount&&(s=!0);r&&1===a.bandCount&&(t=!0);"esriGeometryPoint"===a.geometryType&&(g=!0,z++);if("esriGeometryPoint"===a.geometryType||"esriGeometryMultipoint"===a.geometryType)w=!0;"esriGeometryPolyline"===a.geometryType&&(u=!0,q++);"esriGeometryPolygon"===a.geometryType&&(f=!0,G++)},this);-1!==p.indexOf(["CreateDriveTimeAreas","PlanRoutes","ConnectOriginsToDestinations"],b)&&(!g||d&&"esriGeometryPoint"!==d.geometryType)?(l=k.substitute(this.i18n.selectPointLayer,
{toolName:m[e]}),n=!1):("AggregatePoints"===b||"InterpolatePoints"===b)&&(d&&!("esriGeometryPoint"===d.geometryType||"esriGeometryMultipoint"===d.geometryType)||!w)?(l=k.substitute(this.i18n.selectPointLayer,{toolName:m[e]}),n=!1):"CalculateDensity"===b&&(!w&&!u||d&&!("esriGeometryPoint"===d.geometryType||"esriGeometryMultipoint"===d.geometryType||"esriGeometryPolyline"===d.geometryType))?(l=k.substitute(this.i18n.areaFeatureInvalidMsg,{toolName:m[e]}),n=!1):"FindHotSpots"===b&&(!w&&!f||d&&!("esriGeometryPoint"===
d.geometryType||"esriGeometryMultipoint"===d.geometryType||"esriGeometryPolygon"===d.geometryType))?(l=k.substitute(this.i18n.hotspotsLineFeatureMsg,{toolName:m[e]}),n=!1):("OverlayLayers"===b||"AggregatePoints"===b||"SummarizeWithin"===b||"SummarizeNearby"===b||"FindNearest"===b||"MergeLayers"===b)&&!a&&(0===c.length||1===c.length&&(c[0]===d||!h.isDefined(d)))?(l=k.substitute(this.i18n.overlayValidationMsg,{toolName:m[e]}),n=!1):"ConnectOriginsToDestinations"===b&&!a&&(0===c.length||2>z)?(l=k.substitute(this.i18n.odPointMsg,
{toolName:m[e]}),n=!1):"ChooseBestFacilities"===b&&(0===c.length||0===z)?(l=k.substitute(this.i18n.cblPointMsg,{toolName:m[e]}),n=!1):"AggregatePoints"===b&&!a&&1<c.length?(f=p.some(c,function(a){return"esriGeometryPolygon"===a.geometryType}),f||(l=k.substitute(this.i18n.aggregatePolyMsg,{toolName:m[e]}),n=!1)):"MergeLayers"===b&&!a&&1<c.length?1<z||(1<q||1<G)||(l=this.i18n.mergeValidationMsg,n=!1):("SummarizeWithin"===b||"DissolveBoundaries"===b)&&(d&&"esriGeometryPolygon"!==d.geometryType||!f)?
(l=k.substitute(this.i18n.selectPolyLayer,{toolName:m[e]}),n=!1):"ExtractData"===b?(n=p.some(c,function(a){return-1!==a.capabilities.indexOf("Extract")}))||(l=k.substitute(this.i18n.extractValidationMsg)):("ConnectOriginsToDestinations"===b||"ChooseBestFacilities"===b)&&1<c.length?(g=p.some(c,function(a){var b=h.isDefined(d)&&d.id===a.id;return"esriGeometryPoint"===a.geometryType&&!b}),g||(l=k.substitute("ChooseBestFacilities"===b?this.i18n.cblPointMsg:this.i18n.odPointMsg,{toolName:m[e]}),n=!1)):
"CalculateSlope"===b||"DeriveAspect"===b||"RemapValues"===b?r?t||(n=!1,l=k.substitute(this.i18n.noSingleBandISMsg,{toolName:m[e]})):(n=!1,l=k.substitute(this.i18n.noImageServiceMsg,{toolName:m[e]})):"ExtractRaster"===b?r||(n=!1,l=k.substitute(this.i18n.noImageServiceMsg,{toolName:m[e]})):"MonitorVegetation"===b&&(r?s||(n=!1,l=k.substitute(this.i18n.noMultiBandISMsg,{toolName:m[e]})):(n=!1,l=k.substitute(this.i18n.noImageServiceMsg,{toolName:m[e]})));return b={isValid:n,validationMessage:l}},initI18n:function(){this.i18n||
(this.i18n={},g.mixin(this.i18n,r.common),g.mixin(this.i18n,r.analysisTools),g.mixin(this.i18n,r.analysisMsgCodes),g.mixin(this.i18n,r.browseLayersDlg),g.mixin(this.i18n,r.driveTimes))},addBrowseAnalysisDialog:function(a){if(a&&a.widget){this.i18n||this.initI18n();var b="esri/dijit/analysis/PluginAnalysisLayers",c=function(a){return"\x3cimg class\x3d'grid-item galleryThumbnail' width\x3d'120px' height\x3d'80px' alt\x3d'' src\x3d'"+(a.thumbnailUrl||this._portal.staticImagesUrl+"/desktopapp.png")+"'\x3e"},
d=function(a){return'\x3cdiv class\x3d"galleryLabelContainer"\x3e\x3cspan alt\x3d\''+(a.title||a.name||"\x3cNo Title\x3e")+"'\x3e"+(a.title.replace(/_/g," ")||a.name.replace(/_/g," ")||"\x3cNo Title\x3e")+"\x3c/span\x3e\x3c/div\x3e"},e=function(a){return"\x3cimg class\x3d'grid-item-thumb' width\x3d'16px' height\x3d'16px' alt\x3d'' src\x3d'"+a.iconUrl+"'/\x3e"},f=function(a){return"\x3cimg class\x3d'grid-item-thumb' width\x3d'16px' height\x3d'16px' alt\x3d'' src\x3d'"+a.iconUrl+"'/\x3e"},h=O.doc.createDocumentFragment(),
h=q.create("div",{style:"width:100%;height:100%;"},h),m=q.create("div",{style:"width:100%;height:10%;","class":""}),l=q.create("div",{style:"width:100%"},h),n,w,u,k=this._isCustomAnalysisQuery(a.widget);1===a.browseType?(b="esri/dijit/analysis/PluginLayers",b={portalUrl:a.widget.get("portalUrl"),message:"",plugin:b,sortDescending:!0,sort:"title",self:a.widget.get("portalSelf"),pagingLinks:3,itemsPerPage:15,extent:a.widget.get("map").extent,useExtent:!1,fetchTimeout:600,galleryTemplate:"\x3cdiv class\x3d'listServiceTitle'\x3e\x3ctable cellpadding\x3d'0' cellspacing\x3d'0' width\x3d'100%'\x3e\x3ctr width\x3d'100%'\x3e\x3ctd nowrap\x3d'nowrap'\x3e  \x3cdiv  style\x3d\"position:absolute;left:80px; top:10px; width:1px; height:1px; background: transparent;\"\x3e\x3c/div\x3e\x3cdiv style\x3d'overflow:hidden;'\x3e\x3ca style\x3d\"height:16px;\"\x3e${item.title}\x3c/a\x3e\x3c/div\x3e\x3c/td\x3e\x3c/tr\x3e\x3c/table\x3e\x3ctable cellpadding\x3d'0' cellspacing\x3d'0' width\x3d'100%'\x3e\x3ctr width\x3d'100%' class\x3d'bottomRowTable'\x3e\x3ctd width\x3d'20'\x3e  \x3cspan class\x3d'esriAlignLeading'\x3e${item:_formatThumbnail}\x3c/span\x3e\x3c/td\x3e\x3ctd nowrap\x3d'nowrap'\x3e  \x3cspan class\x3d'esriAlignLeading' style\x3d'color:#656565;'\x3e${item.owner}\x3c/span\x3e\x3c/td\x3e\x3ctd style\x3d'padding-right:5px;padding-left:3px;'\x3e\x3c/td\x3e\x3c/tr\x3e\x3c/table\x3e\x3c/div\x3e",
showInfoPanel:!0,isAutoClose:!1,formatThumbnail:f,formatInfoPanelImage:e,"class":"esriAnalysisLayersItems"}):b={portalUrl:a.widget.get("portalUrl"),message:"",plugin:b,sortDescending:!0,sort:"title",self:a.widget.get("portalSelf"),pagingLinks:3,rowsPerPage:6,"class":"esriBrowseAnalysisLayers itemsGallery esriFloatLeading",extent:a.widget.get("map").extent,useExtent:!k,fetchTimeout:600,galleryTemplate:'\x3cdiv style\x3d\'opacity:1;\' class\x3d\'grid-item gallery-view galleryNode\'\x3e${item:_formatItemTitle}${item:_formatThumbnail}\x3cdiv class\x3d"linksDiv" style\x3d\'display:none;\'\x3e\x3cdiv class\x3d"esriItemLinks"\x3e\x3cdiv class\x3d"esriFloatLeading"\x3e\x3ca style\x3d"text-decoration: none;"\x3e\x3cspan\x3eAdd layer to analysis\x3c/span\x3e\x3cdiv class\x3d"dijitReset dijitInline esriArrows"\x3e\x3c/div\x3e\x3c/a\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e',
formatItemTitle:d,showInfoPanel:!1,showTooltip:!0,formatThumbnail:c,style:"width:48em;height:100%;clear:both;"};d=q.toDom('\x3cdiv class\x3d"esriBrowseOptions"\x3e');q.place(d,m);c=q.create("div",{"class":"esriBrowseOption"},d);if(!a.browseType||1!==a.browseType)d=q.create("div",{"class":"esriBrowseOption"},d),w=new E({name:"addlayer",id:a.widget.id+(a.browseType?a.browseType:"")+"_addlayercheck","class":"",value:!1,checked:!1},q.create("input",{},d)),q.create("label",{"for":a.widget.id+"_addlayercheck",
"class":"esriBrowseOption_label",innerHTML:this.i18n.addLayer},d);d=!0;a.browseType&&1===a.browseType?d=!1:k&&(d=!1);d=new E({name:"extentcheck",id:a.widget.id+(a.browseType?a.browseType:"")+"_addextentcheck","class":"",value:d,checked:d},q.create("input",{},c));q.create("label",{"for":a.widget.id+(a.browseType?a.browseType:"")+"_addextentcheck","class":"esriBrowseOption_label",innerHTML:this.i18n.withinMapArea},c);b.messageRight=m;n=new W(b,l);d.on("change",g.hitch(this,function(a){n.set("useExtent",
a)}));u=new S({title:1===a.browseType?this.i18n.browseLayers:k?this.i18n.browseAnalysisLayers:this.i18n.browseAnalysisTitle,content:h,doLayout:a.browseType&&1===a.browseType,browseItems:n,addlayerCheckBox:w,style:"padding:.75em 0;background-color: #fff;width:50em;"});a.widget.own(a.widget.get("map").on("extent-change",g.hitch(a.widget,function(b){n.set("extent",a.widget.get("map").extent)})),u.on("hide",g.hitch(u,function(a){u.browseItems.reset()})));return u}},addAnalysisReadyLayer:function(a){function b(b){var d,
e,f=new X(c.url,{outFields:["*"]});g.mixin(c,f);g.mixin(c,b);c.id=c.title+"_"+b.id;a.item.selectedLayer?(c.title=c.title+"-"+b.name,b.name=c.title):(c.title=c.title.replace(/_/g," "),c.name=c.title);c.version=c.currentVersion;d=a.layersSelect.getOptions();if(a.widget.showBrowseLayers&&a.widget.showReadyToUseLayers)e=3;else if(a.widget.showBrowseLayers||a.widget.showReadyToUseLayers)e=2;d=d.splice(d.length-e,e);a.layersSelect.removeOption(d);e=a.layers.length;a.posIncrement&&(e+=a.posIncrement);d.unshift({value:e,
label:c.title,selected:!0});a.layersSelect.addOption(d);a.layersSelect.set("value",e);c.lyr=f;c.linfo=b;a.layers.push(c);f.name=c.name;var h;s(".js-add-layer-checkbox",a.browseDialog.browseItems.infoPanel).forEach(function(a){h=a.checked});if(a.browseDialog.addlayerCheckBox&&a.browseDialog.addlayerCheckBox.get("checked")||h)this._addLayerHandle&&this._addLayerHandle.remove(),this._addLayerHandle=a.widget.map.on("layer-add",g.hitch(this,function(d){this._addLayerHandle.remove();a.widget.emit("add-ready-to-use-layer",
{layer:d.layer,layerInfo:b,item:c})})),a.widget.map.addLayer(f);a.browseDialog.browseItems.clear()}if(h.isDefined(a)&&h.isDefined(a.item)&&h.isDefined(a.layersSelect)&&h.isDefined(a.layers)&&h.isDefined(a.browseDialog)){a.browseDialog.hide();var c={url:a.item.url&&-1!==window.location.protocol.indexOf("https:")?a.item.url.replace("http:","https:")+"/0":a.item.url+"/0",itemId:a.item.id,title:a.item.title,analysisReady:!0},d,e=p.some(a.layers,function(a,b){var e=a.analysisReady&&c.analysisReady&&a.itemId===
c.itemId;e&&(d=b);return e}),f=new C,k,m="sync";if(e){a.posIncrement&&(d+=a.posIncrement);var l;s(".js-add-layer-checkbox",a.browseDialog.browseItems.infoPanel).forEach(function(a){l=a.checked});if(a.browseDialog.addlayerCheckBox&&a.browseDialog.addlayerCheckBox.get("checked")||l)a.posIncrement||(a.posIncrement=0),k=a.layers[d-a.posIncrement],a.widget.map.getLayer(k.lyr.id)||(this._addLayerHandle&&this._addLayerHandle.remove(),this._addLayerHandle=a.widget.map.on("layer-add",g.hitch(this,function(b){this._addLayerHandle.remove();
a.widget.emit("add-ready-to-use-layer",{layer:b.layer,layerInfo:k.linfo,item:k})})),a.widget.map.addLayer(k.lyr));a.layersSelect.set("value",d);a.browseDialog.browseItems.clear();f.resolve()}else a.item.selectedLayer?(c.url=a.item.selectedLayer.url,f.then(g.hitch(this,b)),setTimeout(f.resolve(a.item.selectedLayer),500)):(m=a.item.itemDataUrl?F({url:a.item.itemDataUrl,content:{f:"json"}}):"sync",D(m,g.hitch(this,function(a){a&&(a.layers&&a.layers[0].id)&&(c.url=c.url.replace("/0","/"+a.layers[0].id));
f=F({url:c.url,content:{f:"json"}});f.then(g.hitch(this,b))})));return f.promise}},addReadyToUseLayerOption:function(a,b){if(a&&(a.showReadyToUseLayers||a.showBrowseLayers))b||(b=[]),a.signInPromise.then(g.hitch(this,function(){p.forEach(b,function(b){(a.showReadyToUseLayers||a.showBrowseLayers)&&b.addOption({type:"separator",value:""});if(a.showReadyToUseLayers){var d=a.i18n.browseAnalysisTitle;this._isCustomAnalysisQuery(a)&&(d=this.i18n.browseAnalysisLayers);b.addOption({value:"browse",label:d})}a.showBrowseLayers&&
b.addOption({value:"browselayers",label:a.i18n.browseLayers})},this);a.showReadyToUseLayers&&!h.isDefined(a._browsedlg)&&(a._browsedlg=this.addBrowseAnalysisDialog({widget:a}),a.own(a._browsedlg.browseItems.on("select-change",g.hitch(a,a._handleBrowseItemsSelect)),a._browsedlg.on("hide",g.hitch(a,function(){p.forEach(b,function(a){"browse"===a.get("value")&&a.reset()})}))));a.showBrowseLayers&&!h.isDefined(a._browseLyrsdlg)&&(a._browseLyrsdlg=this.addBrowseAnalysisDialog({widget:a,browseType:1}),
a.own(Q.subscribe("/esri/browseitems/close",g.hitch(this,function(b,d){"add-layer"===b&&(console.log(b,d),a._browseLyrsdlg.browseItems.plugIn._grid&&(d.selectedLayer=a._browseLyrsdlg.browseItems.plugIn._selectedLayer,a._handleBrowseItemsSelect({dialog:a._browseLyrsdlg,selection:d})),a._browseLyrsdlg.browseItems.closeInfoPanel())})),a._browseLyrsdlg.on("hide",g.hitch(a,function(){p.forEach(b,function(a){"browselayers"===a.get("value")&&a.reset()})}))))}))},_isCustomAnalysisQuery:function(a){var b=
!1;a.portalSelf&&a.portalSelf.analysisLayersGroupQuery&&'title:"Living Atlas Analysis Layers" AND owner:esri'!==a.portalSelf.analysisLayersGroupQuery?b=!0:a._portal&&(a._portal.analysisLayersGroupQuery&&'title:"Living Atlas Analysis Layers" AND owner:esri'!==a._portal.analysisLayersGroupQuery)&&(b=!0);return b},getMaxInputByMode:function(a){var b;if(a&&a.units&&a.type){if("StraightLine"===a.type)"Miles"===a.units?b=1E3:"Yards"===a.units?b=176E4:"Kilometers"===a.units?b=y.format(1609.34,{places:2}):
"Meters"===a.units?b=y.format(1609340,{places:2}):"Feet"===a.units&&(b=528E4);else if("DrivingDistance"===a.type||"TruckingDistance"===a.type||"WalkingDistance"===a.type)"Miles"===a.units?b=300:"Yards"===a.units?b=528E3:"Kilometers"===a.units?b=y.format(482.802,{places:2}):"Meters"===a.units?b=y.format(482802,{places:2}):"Feet"===a.units&&(b=1584E3);else if("DrivingTime"===a.type||"TruckingTime"===a.type||"WalkingTime"===a.type)"Minutes"===a.units?b=300:"Seconds"===a.units?b=18E3:"Hours"===a.units&&
(b=5);return b}},updateModeConstraints:function(a){var b;a&&(a.validateWidget&&a.units&&a.type)&&(b=a.validateWidget.get("constraints"),b.max=this.getMaxInputByMode(a),a.validateWidget.set(b))},getTravelModes:function(a){var b=new C,c,d,e,f;h.isDefined(this.travelModes)&&0<this.travelModes.length?b.resolve(this.travelModes):!a||!a.widget?b.reject(Error("Missing parameter: params.widget required parameter")):a.widget.signInPromise.then(g.hitch(this,function(k){(f=a.widget.get("helperServices"))&&f.routingUtilities?
(e=f.routingUtilities.url,c="sync"):c=a.widget._getSelf(a.widget.portalUrl);D(c,g.hitch(this,function(a){var c={};a&&(a.helperServices&&a.helperServices.routingUtilities)&&(e=a.helperServices.routingUtilities.url);h.isDefined(e)?(d=new Y(e+"/GetTravelModes"),d.execute(c).then(g.hitch(this,function(a){this.travelModes=p.map(a[0].value&&a[0].value.features,function(a){return J.fromJson(a.attributes.TravelMode)});a[1]&&(a[1].paramName&&"defaultTravelMode"===a[1].paramName)&&(this.defaultTravelModeId=
a[1].value);b.resolve(this.travelModes)}),g.hitch(this,function(a){b.reject(a)}))):b.reject(Error("Missing Routing Utility Service to get Travel Modes"))}),function(a){b.reject(a)})}));return b.promise},populateTravelModes:function(a){if(a&&a.selectWidget&&a.widget){var b=[],c=a.allowmode||"all";this.initI18n();a.addStraightLine&&b.push({value:"StraightLine",label:'\x3cdiv class\x3d"esriFloatLeading bufferIcon esriStraightLineDistanceIcon"\x3e\x3c/div\x3e\x3cdiv class\x3d"esriLeadingMargin4" style\x3d"height:20px;margin-top:10px;"\x3e'+
this.i18n.straightLineDistance+"\x3c/div\x3e"});this.getTravelModes({widget:a.widget}).then(g.hitch(this,function(d){p.forEach(d,function(d,f){var g=d.name,k=g.replace(/\s/g,a.separator||""),l="AUTOMOBILE"===d.type?"Driving":"TRUCK"===d.type?"Trucking":"WALK"===d.type?"Walking":"Other",n=l.toLowerCase(),p=d.units||g.split(/\s/)[1],q=h.isDefined(a.enableTravelModes)&&!a.enableTravelModes,p=d.impedanceAttributeName===d.timeAttributeName?"Time":d.impedanceAttributeName===d.distanceAttributeName?"Distance":
"Other",g={label:'\x3cdiv class\x3d"esriFloatLeading bufferIcon esri'+l+p+'Icon"\x3e\x3c/div\x3e\x3cdiv class\x3d"esriLeadingMargin4" style\x3d"height:20px;margin-top:10px;"\x3e'+g+"\x3c/div\x3e",value:k,travelMode:d,disabled:q,modei18nKey:n,units:p};if("all"===c||c===p.toLowerCase())"all"!==c&&(g.value=g.value.replace(p,"")),a.selectDefaultMode&&(this.defaultTravelModeId&&this.defaultTravelModeId===d.id)&&(g.selected=!0),b.push(g)},this);a.selectWidget.removeOption();a.selectWidget.addOption(b);
a.selectWidget.set("value",a.value);a.widget.emit("travelmodes-added",{travelOptions:b})}),g.hitch(this,function(c){b&&0<b.length&&(a.selectWidget.removeOption(),a.selectWidget.addOption(b),a.selectWidget.set("value",a.value),a.widget.emit("travelmodes-added",{travelOptions:b}))}))}},updateDisplay:function(a,b,c){(new s.NodeList(a)).style("display",b?c?c:"block":"none")}});K("extend-esri")&&g.setObject("dijit.analysis.utils",x,T);return x});