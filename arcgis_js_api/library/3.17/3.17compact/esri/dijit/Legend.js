// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.17/esri/copyright.txt for details.
//>>built
require({cache:{"dojo/debounce":function(){define([],function(){return function(h,n){var g;return function(){g&&clearTimeout(g);var e=this,l=arguments;g=setTimeout(function(){h.apply(e,l)},n)}}})},"dojo/DeferredList":function(){define(["./_base/kernel","./_base/Deferred","./_base/array"],function(h,n,g){h.DeferredList=function(e,l,f,m,d){var b=[];n.call(this);var h=this;0===e.length&&!l&&this.resolve([0,[]]);var y=0;g.forEach(e,function(d,g){function a(a,d){b[g]=[a,d];y++;y===e.length&&h.resolve(b)}
d.then(function(b){l?h.resolve([g,b]):a(!0,b)},function(b){f?h.reject(b):a(!1,b);if(m)return null;throw b;})})};h.DeferredList.prototype=new n;h.DeferredList.prototype.gatherResults=function(e){e=new h.DeferredList(e,!1,!0,!1);e.addCallback(function(e){var f=[];g.forEach(e,function(e){f.push(e[1])});return f});return e};return h.DeferredList})},"dijit/_Widget":function(){define("dojo/aspect dojo/_base/config dojo/_base/connect dojo/_base/declare dojo/has dojo/_base/kernel dojo/_base/lang dojo/query dojo/ready ./registry ./_WidgetBase ./_OnDijitClickMixin ./_FocusMixin dojo/uacss ./hccss".split(" "),
function(h,n,g,e,l,f,m,d,b,J,y,u,r){function a(){}function s(b){return function(d,q,t,e){return d&&"string"==typeof q&&d[q]==a?d.on(q.substring(2).toLowerCase(),m.hitch(t,e)):b.apply(g,arguments)}}h.around(g,"connect",s);f.connect&&h.around(f,"connect",s);h=e("dijit._Widget",[y,u,r],{onClick:a,onDblClick:a,onKeyDown:a,onKeyPress:a,onKeyUp:a,onMouseDown:a,onMouseMove:a,onMouseOut:a,onMouseOver:a,onMouseLeave:a,onMouseEnter:a,onMouseUp:a,constructor:function(b){this._toConnect={};for(var d in b)this[d]===
a&&(this._toConnect[d.replace(/^on/,"").toLowerCase()]=b[d],delete b[d])},postCreate:function(){this.inherited(arguments);for(var a in this._toConnect)this.on(a,this._toConnect[a]);delete this._toConnect},on:function(b,d){return this[this._onMap(b)]===a?g.connect(this.domNode,b.toLowerCase(),this,d):this.inherited(arguments)},_setFocusedAttr:function(a){this._focused=a;this._set("focused",a)},setAttribute:function(a,b){f.deprecated(this.declaredClass+"::setAttribute(attr, value) is deprecated. Use set() instead.",
"","2.0");this.set(a,b)},attr:function(a,b){return 2<=arguments.length||"object"===typeof a?this.set.apply(this,arguments):this.get(a)},getDescendants:function(){f.deprecated(this.declaredClass+"::getDescendants() is deprecated. Use getChildren() instead.","","2.0");return this.containerNode?d("[widgetId]",this.containerNode).map(J.byNode):[]},_onShow:function(){this.onShow()},onShow:function(){},onHide:function(){},onClose:function(){return!0}});l("dijit-legacy-requires")&&b(0,function(){require(["dijit/_base"])});
return h})},"dijit/_WidgetBase":function(){define("require dojo/_base/array dojo/aspect dojo/_base/config dojo/_base/connect dojo/_base/declare dojo/dom dojo/dom-attr dojo/dom-class dojo/dom-construct dojo/dom-geometry dojo/dom-style dojo/has dojo/_base/kernel dojo/_base/lang dojo/on dojo/ready dojo/Stateful dojo/topic dojo/_base/window ./Destroyable dojo/has!dojo-bidi?./_BidiMixin ./registry".split(" "),function(h,n,g,e,l,f,m,d,b,J,y,u,r,a,s,B,F,q,t,v,L,P,G){function H(a){return function(b){d[b?
"set":"remove"](this.domNode,a,b);this._set(a,b)}}r.add("dijit-legacy-requires",!a.isAsync);r.add("dojo-bidi",!1);r("dijit-legacy-requires")&&F(0,function(){h(["dijit/_base/manager"])});var D={};e=f("dijit._WidgetBase",[q,L],{id:"",_setIdAttr:"domNode",lang:"",_setLangAttr:H("lang"),dir:"",_setDirAttr:H("dir"),"class":"",_setClassAttr:{node:"domNode",type:"class"},_setTypeAttr:null,style:"",title:"",tooltip:"",baseClass:"",srcNodeRef:null,domNode:null,containerNode:null,ownerDocument:null,_setOwnerDocumentAttr:function(a){this._set("ownerDocument",
a)},attributeMap:{},_blankGif:e.blankGif||h.toUrl("dojo/resources/blank.gif"),textDir:"",_introspect:function(){var a=this.constructor;if(!a._setterAttrs){var b=a.prototype,d=a._setterAttrs=[],a=a._onMap={},q;for(q in b.attributeMap)d.push(q);for(q in b)/^on/.test(q)&&(a[q.substring(2).toLowerCase()]=q),/^_set[A-Z](.*)Attr$/.test(q)&&(q=q.charAt(4).toLowerCase()+q.substr(5,q.length-9),(!b.attributeMap||!(q in b.attributeMap))&&d.push(q))}},postscript:function(a,b){this.create(a,b)},create:function(a,
b){this._introspect();this.srcNodeRef=m.byId(b);this._connects=[];this._supportingWidgets=[];this.srcNodeRef&&(this.srcNodeRef.id&&"string"==typeof this.srcNodeRef.id)&&(this.id=this.srcNodeRef.id);a&&(this.params=a,s.mixin(this,a));this.postMixInProperties();this.id||(this.id=G.getUniqueId(this.declaredClass.replace(/\./g,"_")),this.params&&delete this.params.id);this.ownerDocument=this.ownerDocument||(this.srcNodeRef?this.srcNodeRef.ownerDocument:document);this.ownerDocumentBody=v.body(this.ownerDocument);
G.add(this);this.buildRendering();var q;if(this.domNode){this._applyAttributes();var d=this.srcNodeRef;d&&(d.parentNode&&this.domNode!==d)&&(d.parentNode.replaceChild(this.domNode,d),q=!0);this.domNode.setAttribute("widgetId",this.id)}this.postCreate();q&&delete this.srcNodeRef;this._created=!0},_applyAttributes:function(){var a={},b;for(b in this.params||{})a[b]=this._get(b);n.forEach(this.constructor._setterAttrs,function(b){if(!(b in a)){var d=this._get(b);d&&this.set(b,d)}},this);for(b in a)this.set(b,
a[b])},postMixInProperties:function(){},buildRendering:function(){this.domNode||(this.domNode=this.srcNodeRef||this.ownerDocument.createElement("div"));if(this.baseClass){var a=this.baseClass.split(" ");this.isLeftToRight()||(a=a.concat(n.map(a,function(a){return a+"Rtl"})));b.add(this.domNode,a)}},postCreate:function(){},startup:function(){this._started||(this._started=!0,n.forEach(this.getChildren(),function(a){!a._started&&(!a._destroyed&&s.isFunction(a.startup))&&(a.startup(),a._started=!0)}))},
destroyRecursive:function(a){this._beingDestroyed=!0;this.destroyDescendants(a);this.destroy(a)},destroy:function(a){function b(d){d.destroyRecursive?d.destroyRecursive(a):d.destroy&&d.destroy(a)}this._beingDestroyed=!0;this.uninitialize();n.forEach(this._connects,s.hitch(this,"disconnect"));n.forEach(this._supportingWidgets,b);this.domNode&&n.forEach(G.findWidgets(this.domNode,this.containerNode),b);this.destroyRendering(a);G.remove(this.id);this._destroyed=!0},destroyRendering:function(a){this.bgIframe&&
(this.bgIframe.destroy(a),delete this.bgIframe);this.domNode&&(a?d.remove(this.domNode,"widgetId"):J.destroy(this.domNode),delete this.domNode);this.srcNodeRef&&(a||J.destroy(this.srcNodeRef),delete this.srcNodeRef)},destroyDescendants:function(a){n.forEach(this.getChildren(),function(b){b.destroyRecursive&&b.destroyRecursive(a)})},uninitialize:function(){return!1},_setStyleAttr:function(a){var b=this.domNode;s.isObject(a)?u.set(b,a):b.style.cssText=b.style.cssText?b.style.cssText+("; "+a):a;this._set("style",
a)},_attrToDom:function(a,q,t){t=3<=arguments.length?t:this.attributeMap[a];n.forEach(s.isArray(t)?t:[t],function(t){var e=this[t.node||t||"domNode"];switch(t.type||"attribute"){case "attribute":s.isFunction(q)&&(q=s.hitch(this,q));t=t.attribute?t.attribute:/^on[A-Z][a-zA-Z]*$/.test(a)?a.toLowerCase():a;e.tagName?d.set(e,t,q):e.set(t,q);break;case "innerText":e.innerHTML="";e.appendChild(this.ownerDocument.createTextNode(q));break;case "innerHTML":e.innerHTML=q;break;case "class":b.replace(e,q,this[a]);
break;case "toggleClass":b.toggle(e,t.className||a,q)}},this)},get:function(a){var b=this._getAttrNames(a);return this[b.g]?this[b.g]():this._get(a)},set:function(a,b){if("object"===typeof a){for(var d in a)this.set(d,a[d]);return this}d=this._getAttrNames(a);var q=this[d.s];if(s.isFunction(q))var t=q.apply(this,Array.prototype.slice.call(arguments,1));else{var q=this.focusNode&&!s.isFunction(this.focusNode)?"focusNode":"domNode",e=this[q]&&this[q].tagName,m;if(m=e)if(!(m=D[e])){m=this[q];var l={},
f;for(f in m)l[f.toLowerCase()]=!0;m=D[e]=l}f=m;d=a in this.attributeMap?this.attributeMap[a]:d.s in this?this[d.s]:f&&d.l in f&&"function"!=typeof b||/^aria-|^data-|^role$/.test(a)?q:null;null!=d&&this._attrToDom(a,b,d);this._set(a,b)}return t||this},_attrPairNames:{},_getAttrNames:function(a){var b=this._attrPairNames;if(b[a])return b[a];var d=a.replace(/^[a-z]|-[a-zA-Z]/g,function(a){return a.charAt(a.length-1).toUpperCase()});return b[a]={n:a+"Node",s:"_set"+d+"Attr",g:"_get"+d+"Attr",l:d.toLowerCase()}},
_set:function(a,b){var d=this[a];this[a]=b;if(this._created&&!(d===b||d!==d&&b!==b))this._watchCallbacks&&this._watchCallbacks(a,d,b),this.emit("attrmodified-"+a,{detail:{prevValue:d,newValue:b}})},_get:function(a){return this[a]},emit:function(a,b,d){b=b||{};void 0===b.bubbles&&(b.bubbles=!0);void 0===b.cancelable&&(b.cancelable=!0);b.detail||(b.detail={});b.detail.widget=this;var q,t=this["on"+a];t&&(q=t.apply(this,d?d:[b]));this._started&&!this._beingDestroyed&&B.emit(this.domNode,a.toLowerCase(),
b);return q},on:function(a,b){var d=this._onMap(a);return d?g.after(this,d,b,!0):this.own(B(this.domNode,a,b))[0]},_onMap:function(a){var b=this.constructor,d=b._onMap;if(!d){var d=b._onMap={},q;for(q in b.prototype)/^on/.test(q)&&(d[q.replace(/^on/,"").toLowerCase()]=q)}return d["string"==typeof a&&a.toLowerCase()]},toString:function(){return"[Widget "+this.declaredClass+", "+(this.id||"NO ID")+"]"},getChildren:function(){return this.containerNode?G.findWidgets(this.containerNode):[]},getParent:function(){return G.getEnclosingWidget(this.domNode.parentNode)},
connect:function(a,b,d){return this.own(l.connect(a,b,this,d))[0]},disconnect:function(a){a.remove()},subscribe:function(a,b){return this.own(t.subscribe(a,s.hitch(this,b)))[0]},unsubscribe:function(a){a.remove()},isLeftToRight:function(){return this.dir?"ltr"==this.dir.toLowerCase():y.isBodyLtr(this.ownerDocument)},isFocusable:function(){return this.focus&&"none"!=u.get(this.domNode,"display")},placeAt:function(a,b){var d=!a.tagName&&G.byId(a);d&&d.addChild&&(!b||"number"===typeof b)?d.addChild(this,
b):(d=d&&"domNode"in d?d.containerNode&&!/after|before|replace/.test(b||"")?d.containerNode:d.domNode:m.byId(a,this.ownerDocument),J.place(this.domNode,d,b),!this._started&&(this.getParent()||{})._started&&this.startup());return this},defer:function(a,b){var d=setTimeout(s.hitch(this,function(){d&&(d=null,this._destroyed||s.hitch(this,a)())}),b||0);return{remove:function(){d&&(clearTimeout(d),d=null);return null}}}});r("dojo-bidi")&&e.extend(P);return e})},"dijit/Destroyable":function(){define(["dojo/_base/array",
"dojo/aspect","dojo/_base/declare"],function(h,n,g){return g("dijit.Destroyable",null,{destroy:function(e){this._destroyed=!0},own:function(){var e=["destroyRecursive","destroy","remove"];h.forEach(arguments,function(l){function f(){d.remove();h.forEach(b,function(b){b.remove()})}var m,d=n.before(this,"destroy",function(b){l[m](b)}),b=[];l.then?(m="cancel",l.then(f,f)):h.forEach(e,function(d){"function"===typeof l[d]&&(m||(m=d),b.push(n.after(l,d,f,!0)))})},this);return arguments}})})},"dijit/_OnDijitClickMixin":function(){define("dojo/on dojo/_base/array dojo/keys dojo/_base/declare dojo/has ./a11yclick".split(" "),
function(h,n,g,e,l,f){h=e("dijit._OnDijitClickMixin",null,{connect:function(e,d,b){return this.inherited(arguments,[e,"ondijitclick"==d?f:d,b])}});h.a11yclick=f;return h})},"dijit/_FocusMixin":function(){define(["./focus","./_WidgetBase","dojo/_base/declare","dojo/_base/lang"],function(h,n,g,e){e.extend(n,{focused:!1,onFocus:function(){},onBlur:function(){},_onFocus:function(){this.onFocus()},_onBlur:function(){this.onBlur()}});return g("dijit._FocusMixin",null,{_focusManager:h})})},"dijit/hccss":function(){define(["dojo/dom-class",
"dojo/hccss","dojo/domReady","dojo/_base/window"],function(h,n,g,e){g(function(){n("highcontrast")&&h.add(e.body(),"dijit_a11y")});return n})},"dojo/hccss":function(){define("require ./_base/config ./dom-class ./dom-style ./has ./domReady ./_base/window".split(" "),function(h,n,g,e,l,f,m){l.add("highcontrast",function(){var d=m.doc.createElement("div");try{d.style.cssText='border: 1px solid; border-color:red green; position: absolute; height: 5px; top: -999px;background-image: url("'+(n.blankGif||
h.toUrl("./resources/blank.gif"))+'");';m.body().appendChild(d);var b=e.getComputedStyle(d),f=b.backgroundImage;return b.borderTopColor==b.borderRightColor||f&&("none"==f||"url(invalid-url:)"==f)}catch(g){return console.warn("hccss: exception detecting high-contrast mode, document is likely hidden: "+g.toString()),!1}finally{8>=l("ie")?d.outerHTML="":m.body().removeChild(d)}});f(function(){l("highcontrast")&&g.add(m.body(),"dj_a11y")});return l})},"dojox/html/entities":function(){define(["dojo/_base/lang"],
function(h){var n=h.getObject("dojox.html.entities",!0),g=function(e,f){var m,d;if(f._encCache&&f._encCache.regexp&&f._encCache.mapper&&f.length==f._encCache.length)m=f._encCache.mapper,d=f._encCache.regexp;else{m={};d=["["];var b;for(b=0;b<f.length;b++)m[f[b][0]]="\x26"+f[b][1]+";",d.push(f[b][0]);d.push("]");d=RegExp(d.join(""),"g");f._encCache={mapper:m,regexp:d,length:f.length}}return e=e.replace(d,function(b){return m[b]})},e=function(e,f){var m,d;if(f._decCache&&f._decCache.regexp&&f._decCache.mapper&&
f.length==f._decCache.length)m=f._decCache.mapper,d=f._decCache.regexp;else{m={};d=["("];var b;for(b=0;b<f.length;b++){var g="\x26"+f[b][1]+";";b&&d.push("|");m[g]=f[b][0];d.push(g)}d.push(")");d=RegExp(d.join(""),"g");f._decCache={mapper:m,regexp:d,length:f.length}}return e=e.replace(d,function(b){return m[b]})};n.html=[["\x26","amp"],['"',"quot"],["\x3c","lt"],["\x3e","gt"],["\u00a0","nbsp"]];n.latin=[["\u00a1","iexcl"],["\u00a2","cent"],["\u00a3","pound"],["\u20ac","euro"],["\u00a4","curren"],
["\u00a5","yen"],["\u00a6","brvbar"],["\u00a7","sect"],["\u00a8","uml"],["\u00a9","copy"],["\u00aa","ordf"],["\u00ab","laquo"],["\u00ac","not"],["\u00ad","shy"],["\u00ae","reg"],["\u00af","macr"],["\u00b0","deg"],["\u00b1","plusmn"],["\u00b2","sup2"],["\u00b3","sup3"],["\u00b4","acute"],["\u00b5","micro"],["\u00b6","para"],["\u00b7","middot"],["\u00b8","cedil"],["\u00b9","sup1"],["\u00ba","ordm"],["\u00bb","raquo"],["\u00bc","frac14"],["\u00bd","frac12"],["\u00be","frac34"],["\u00bf","iquest"],["\u00c0",
"Agrave"],["\u00c1","Aacute"],["\u00c2","Acirc"],["\u00c3","Atilde"],["\u00c4","Auml"],["\u00c5","Aring"],["\u00c6","AElig"],["\u00c7","Ccedil"],["\u00c8","Egrave"],["\u00c9","Eacute"],["\u00ca","Ecirc"],["\u00cb","Euml"],["\u00cc","Igrave"],["\u00cd","Iacute"],["\u00ce","Icirc"],["\u00cf","Iuml"],["\u00d0","ETH"],["\u00d1","Ntilde"],["\u00d2","Ograve"],["\u00d3","Oacute"],["\u00d4","Ocirc"],["\u00d5","Otilde"],["\u00d6","Ouml"],["\u00d7","times"],["\u00d8","Oslash"],["\u00d9","Ugrave"],["\u00da",
"Uacute"],["\u00db","Ucirc"],["\u00dc","Uuml"],["\u00dd","Yacute"],["\u00de","THORN"],["\u00df","szlig"],["\u00e0","agrave"],["\u00e1","aacute"],["\u00e2","acirc"],["\u00e3","atilde"],["\u00e4","auml"],["\u00e5","aring"],["\u00e6","aelig"],["\u00e7","ccedil"],["\u00e8","egrave"],["\u00e9","eacute"],["\u00ea","ecirc"],["\u00eb","euml"],["\u00ec","igrave"],["\u00ed","iacute"],["\u00ee","icirc"],["\u00ef","iuml"],["\u00f0","eth"],["\u00f1","ntilde"],["\u00f2","ograve"],["\u00f3","oacute"],["\u00f4",
"ocirc"],["\u00f5","otilde"],["\u00f6","ouml"],["\u00f7","divide"],["\u00f8","oslash"],["\u00f9","ugrave"],["\u00fa","uacute"],["\u00fb","ucirc"],["\u00fc","uuml"],["\u00fd","yacute"],["\u00fe","thorn"],["\u00ff","yuml"],["\u0192","fnof"],["\u0391","Alpha"],["\u0392","Beta"],["\u0393","Gamma"],["\u0394","Delta"],["\u0395","Epsilon"],["\u0396","Zeta"],["\u0397","Eta"],["\u0398","Theta"],["\u0399","Iota"],["\u039a","Kappa"],["\u039b","Lambda"],["\u039c","Mu"],["\u039d","Nu"],["\u039e","Xi"],["\u039f",
"Omicron"],["\u03a0","Pi"],["\u03a1","Rho"],["\u03a3","Sigma"],["\u03a4","Tau"],["\u03a5","Upsilon"],["\u03a6","Phi"],["\u03a7","Chi"],["\u03a8","Psi"],["\u03a9","Omega"],["\u03b1","alpha"],["\u03b2","beta"],["\u03b3","gamma"],["\u03b4","delta"],["\u03b5","epsilon"],["\u03b6","zeta"],["\u03b7","eta"],["\u03b8","theta"],["\u03b9","iota"],["\u03ba","kappa"],["\u03bb","lambda"],["\u03bc","mu"],["\u03bd","nu"],["\u03be","xi"],["\u03bf","omicron"],["\u03c0","pi"],["\u03c1","rho"],["\u03c2","sigmaf"],["\u03c3",
"sigma"],["\u03c4","tau"],["\u03c5","upsilon"],["\u03c6","phi"],["\u03c7","chi"],["\u03c8","psi"],["\u03c9","omega"],["\u03d1","thetasym"],["\u03d2","upsih"],["\u03d6","piv"],["\u2022","bull"],["\u2026","hellip"],["\u2032","prime"],["\u2033","Prime"],["\u203e","oline"],["\u2044","frasl"],["\u2118","weierp"],["\u2111","image"],["\u211c","real"],["\u2122","trade"],["\u2135","alefsym"],["\u2190","larr"],["\u2191","uarr"],["\u2192","rarr"],["\u2193","darr"],["\u2194","harr"],["\u21b5","crarr"],["\u21d0",
"lArr"],["\u21d1","uArr"],["\u21d2","rArr"],["\u21d3","dArr"],["\u21d4","hArr"],["\u2200","forall"],["\u2202","part"],["\u2203","exist"],["\u2205","empty"],["\u2207","nabla"],["\u2208","isin"],["\u2209","notin"],["\u220b","ni"],["\u220f","prod"],["\u2211","sum"],["\u2212","minus"],["\u2217","lowast"],["\u221a","radic"],["\u221d","prop"],["\u221e","infin"],["\u2220","ang"],["\u2227","and"],["\u2228","or"],["\u2229","cap"],["\u222a","cup"],["\u222b","int"],["\u2234","there4"],["\u223c","sim"],["\u2245",
"cong"],["\u2248","asymp"],["\u2260","ne"],["\u2261","equiv"],["\u2264","le"],["\u2265","ge"],["\u2282","sub"],["\u2283","sup"],["\u2284","nsub"],["\u2286","sube"],["\u2287","supe"],["\u2295","oplus"],["\u2297","otimes"],["\u22a5","perp"],["\u22c5","sdot"],["\u2308","lceil"],["\u2309","rceil"],["\u230a","lfloor"],["\u230b","rfloor"],["\u2329","lang"],["\u232a","rang"],["\u25ca","loz"],["\u2660","spades"],["\u2663","clubs"],["\u2665","hearts"],["\u2666","diams"],["\u0152","OElig"],["\u0153","oelig"],
["\u0160","Scaron"],["\u0161","scaron"],["\u0178","Yuml"],["\u02c6","circ"],["\u02dc","tilde"],["\u2002","ensp"],["\u2003","emsp"],["\u2009","thinsp"],["\u200c","zwnj"],["\u200d","zwj"],["\u200e","lrm"],["\u200f","rlm"],["\u2013","ndash"],["\u2014","mdash"],["\u2018","lsquo"],["\u2019","rsquo"],["\u201a","sbquo"],["\u201c","ldquo"],["\u201d","rdquo"],["\u201e","bdquo"],["\u2020","dagger"],["\u2021","Dagger"],["\u2030","permil"],["\u2039","lsaquo"],["\u203a","rsaquo"]];n.encode=function(e,f){e&&(f?
e=g(e,f):(e=g(e,n.html),e=g(e,n.latin)));return e};n.decode=function(g,f){g&&(f?g=e(g,f):(g=e(g,n.html),g=e(g,n.latin)));return g};return n})},"esri/numberUtils":function(){define(["dojo/has","dojo/number","dojo/i18n!dojo/cldr/nls/number","./kernel"],function(h,n,g,e){var l=function(e,d){return e-d},f={_reNumber:/^-?(\d+)(\.(\d+))?$/i,getDigits:function(e){var d=String(e),b=d.match(f._reNumber);e={integer:0,fractional:0};b&&b[1]?(e.integer=b[1].split("").length,e.fractional=b[3]?b[3].split("").length:
0):-1<d.toLowerCase().indexOf("e")&&(b=d.split("e"),d=b[0],b=b[1],d&&b&&(d=Number(d),b=Number(b),(e=0<b)||(b=Math.abs(b)),d=f.getDigits(d),e?(d.integer+=b,d.fractional=b>d.fractional?0:d.fractional-b):(d.fractional+=b,d.integer=b>d.integer?1:d.integer-b),e=d));return e},getFixedNumbers:function(e,d){var b,f;b=Number(e.toFixed(d));b<e?f=b+1/Math.pow(10,d):(f=b,b-=1/Math.pow(10,d));b=Number(b.toFixed(d));f=Number(f.toFixed(d));return[b,f]},getPctChange:function(e,d,b,f){var g={prev:null,next:null},
h;null!=b&&(h=e-b,b=d-b-h,g.prev=Math.floor(Math.abs(100*b/h)));null!=f&&(h=f-e,b=f-d-h,g.next=Math.floor(Math.abs(100*b/h)));return g},round:function(e,d){var b=e.slice(0),g,h,n,r,a,s,B,F,q,t=!d||null==d.tolerance?2:d.tolerance,v=d&&d.indexes,L=!d||null==d.strictBounds?!1:d.strictBounds;if(v)v.sort(l);else{v=[];for(s=0;s<b.length;s++)v.push(s)}for(s=0;s<v.length;s++)if(q=v[s],g=b[q],h=0===q?null:b[q-1],n=q===b.length-1?null:b[q+1],r=f.getDigits(g),r=r.fractional){B=0;for(F=!1;B<=r&&!F;)a=f.getFixedNumbers(g,
B),a=L&&0===s?a[1]:a[0],F=f.hasMinimalChange(g,a,h,n,t),B++;F&&(b[q]=a)}return b},hasMinimalChange:function(e,d,b,g,h){e=f.getPctChange(e,d,b,g);d=null==e.prev||e.prev<=h;b=null==e.next||e.next<=h;return d&&b||e.prev+e.next<=2*h},_reAllZeros:RegExp("\\"+g.decimal+"0+$","g"),_reSomeZeros:RegExp("(\\d)0*$","g"),format:function(e,d){d=d||{places:20,round:-1};var b=n.format(e,d);b&&(b=b.replace(f._reSomeZeros,"$1").replace(f._reAllZeros,""));return b}};h("extend-esri")&&(e.numberUtils=f);return f})},
"esri/renderers/utils":function(){define("dojo/_base/lang dojo/_base/array dojo/has dojo/date/locale ../kernel ../numberUtils ../Color dojo/i18n!../nls/jsapi dojo/i18n!dojo/cldr/nls/gregorian".split(" "),function(h,n,g,e,l,f,m,d,b){function J(a){return a&&n.map(a,function(a){return new m(a)})}function y(a,b,d){var e="";0===b?e=r.lt+" ":b===d&&(e=r.gt+" ");return e+a}var u={},r={lte:"\x3c\x3d",gte:"\x3e\x3d",lt:"\x3c",gt:"\x3e",pct:"%"},a={millisecond:0,second:1,minute:2,hour:3,day:4,month:5,year:6},
s={millisecond:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"medium"}},second:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"medium"}},minute:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"short"}},hour:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"short"}},day:{selector:"date",dateOptions:{formatLength:"long"}},month:{selector:"date",dateOptions:{formatLength:"long"}},year:{selector:"date",dateOptions:{selector:"year"}}},B={formatLength:"short",
fullYear:!0},F={formatLength:"short"};h.mixin(u,{timelineDateFormatOptions:{selector:"date",dateOptions:{formatLength:"short",fullYear:!0}},formatDate:function(a,d){var f,g=[];null!=a&&!(a instanceof Date)&&(a=new Date(a));d=d||{};d=h.mixin({},d);var m=d.selector?d.selector.toLowerCase():null;f=!m||-1<m.indexOf("time");m=!m||-1<m.indexOf("date");f&&(d.timeOptions=d.timeOptions||F,d.timeOptions&&(d.timeOptions=h.mixin({},d.timeOptions),d.timeOptions.selector=d.timeOptions.selector||"time",g.push(d.timeOptions)));
m&&(d.dateOptions=d.dateOptions||B,d.dateOptions&&(d.dateOptions=h.mixin({},d.dateOptions),d.dateOptions.selector=d.dateOptions.selector||"date",g.push(d.dateOptions)));g&&g.length?(g=n.map(g,function(b){return e.format(a,b)}),f=1==g.length?g[0]:b["dateTimeFormat-medium"].replace(/\'/g,"").replace(/\{(\d+)\}/g,function(a,b){return g[b]})):f=e.format(a);return f},createColorStops:function(a){var b=a.values,d=a.colors,e=a.labelIndexes,g=a.isDate,h=a.dateFormatOptions;a=[];return a=n.map(b,function(a,
q){var m=null;if(!e||-1<n.indexOf(e,q)){var l;(l=g?u.formatDate(a,h):f.format(a))&&(m=y(l,q,b.length-1))}return{value:a,color:d[q],label:m}})},updateColorStops:function(a){var b=a.stops,d=a.changes,e=a.isDate,g=a.dateFormatOptions,h=[],m,l=n.map(b,function(a){return a.value});n.forEach(d,function(a){h.push(a.index);l[a.index]=a.value});m=f.round(l,{indexes:h});n.forEach(b,function(a,d){a.value=l[d];if(null!=a.label){var q,h=null;(q=e?u.formatDate(m[d],g):f.format(m[d]))&&(h=y(q,d,b.length-1));a.label=
h}})},createClassBreakLabel:function(a){var b=a.minValue,e=a.maxValue,g=a.isFirstBreak?"":r.gt+" ";a="percent-of-total"===a.normalizationType?r.pct:"";b=null==b?"":f.format(b);e=null==e?"":f.format(e);return g+b+a+" "+d.smartMapping.minToMax+" "+e+a},setLabelsForClassBreaks:function(a){var b=a.classBreaks,d=a.classificationMethod,e=a.normalizationType,g=[];b&&b.length&&("standard-deviation"===d?console.log("setLabelsForClassBreaks: cannot set labels for class breaks generated using 'standard-deviation' method."):
a.round?(g.push(b[0].minValue),n.forEach(b,function(a){g.push(a.maxValue)}),g=f.round(g),n.forEach(b,function(a,b){a.label=u.createClassBreakLabel({minValue:0===b?g[0]:g[b],maxValue:g[b+1],isFirstBreak:0===b,normalizationType:e})})):n.forEach(b,function(a,b){a.label=u.createClassBreakLabel({minValue:a.minValue,maxValue:a.maxValue,isFirstBreak:0===b,normalizationType:e})}))},updateClassBreak:function(a){var b=a.classBreaks,d=a.normalizationType,e=a.change,g=e.index,e=e.value,f=-1,h=-1,m=b.length;"standard-deviation"===
a.classificationMethod?console.log("updateClassBreak: cannot update labels for class breaks generated using 'standard-deviation' method."):(0===g?f=g:g===m?h=g-1:(h=g-1,f=g),-1<f&&f<m&&(a=b[f],a.minValue=e,a.label=u.createClassBreakLabel({minValue:a.minValue,maxValue:a.maxValue,isFirstBreak:0===f,normalizationType:d})),-1<h&&h<m&&(a=b[h],a.maxValue=e,a.label=u.createClassBreakLabel({minValue:a.minValue,maxValue:a.maxValue,isFirstBreak:0===h,normalizationType:d})))},calculateDateFormatInterval:function(b){var d,
e,g=b.length,f,h,m,l,s,r,u=Infinity,y;b=n.map(b,function(a){return new Date(a)});for(d=0;d<g-1;d++){f=b[d];m=[];s=Infinity;r="";for(e=d+1;e<g;e++)h=b[e],h=f.getFullYear()!==h.getFullYear()&&"year"||f.getMonth()!==h.getMonth()&&"month"||f.getDate()!==h.getDate()&&"day"||f.getHours()!==h.getHours()&&"hour"||f.getMinutes()!==h.getMinutes()&&"minute"||f.getSeconds()!==h.getSeconds()&&"second"||"millisecond",l=a[h],l<s&&(s=l,r=h),m.push(h);s<u&&(u=s,y=r)}return y},createUniqueValueLabel:function(a){var b=
a.value,d=a.fieldInfo,e=a.domain;a=a.dateFormatInterval;var g=String(b);(e=e&&e.codedValues?e.getName(b):null)?g=e:"number"===typeof b&&(g=d&&"esriFieldTypeDate"===d.type?u.formatDate(b,a&&s[a]):f.format(b));return g},cloneColorInfo:function(a){var b;a&&(b=h.mixin({},a),b.colors=J(b.colors),b.stops=b.stops&&n.map(b.stops,function(a){a=h.mixin({},a);a.color&&(a.color=new m(a.color));return a}),b.legendOptions&&(b.legendOptions=h.mixin({},b.legendOptions)));return b},cloneOpacityInfo:function(a){var b;
if(a){b=h.mixin({},a);if(a=b.opacityValues)b.opacityValues=a.slice(0);if(a=b.stops)b.stops=n.map(a,function(a){return h.mixin({},a)});if(a=b.legendOptions)b.legendOptions=h.mixin({},a)}return b},cloneSizeInfo:function(a){var b;if(a){b=h.mixin({},a);b.stops&&(b.stops=n.map(b.stops,function(a){return h.mixin({},a)}));if((a=b.minSize)&&"object"===typeof a)b.minSize=u.cloneSizeInfo(a);if((a=b.maxSize)&&"object"===typeof a)b.maxSize=u.cloneSizeInfo(a);if(a=b.legendOptions)if(b.legendOptions=h.mixin({},
a),a=a.customValues)b.legendOptions.customValues=a.slice(0)}return b}});g("extend-esri")&&h.setObject("renderer.utils",u,l);return u})},"esri/dijit/_EventedWidget":function(){define("dojo/_base/declare dojo/_base/lang dojo/aspect dojo/on ../Evented dijit/_WidgetBase".split(" "),function(h,n,g,e,l,f){return h([f,l],{_onMap:function(e){var d=this.constructor._onMap,b;if(!d||!d.FINAL)delete this.constructor._onMap,d=this.registerConnectEvents(),d.FINAL=!0;e=e.toLowerCase();d[e]?b=this[d[e].method]:(e=
this._onCamelCase(e),this[e]&&(b=e));return b},on:function(g,d){var b=this._onMap(g),f=g.replace(/\-/g,""),h="on"+f in this.domNode;return b||!h?this.inherited(arguments):this.own(e(this.domNode,f,d))[0]},emit:function(e,d,b){var g,f,h,l=e.toLowerCase(),a=this.constructor._onMap||this.registerConnectEvents();f=this[this._onMap(l)];d=d||{};d.target||(d.target=this);f&&(a&&a[l])&&(this._onObj2Arr(function(){g=Array.prototype.slice.call(arguments)},a[l].argKeys)(d),h=n.mixin({},arguments),h[2]=g,h[0]=
a[l].name.replace(/^on/,""));return this.inherited(h||arguments)}})})},"*noref":1}});
define("esri/dijit/Legend","dojo/_base/kernel dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/connect dojo/_base/json dojo/_base/Color dojo/debounce dojo/has dojo/sniff dojo/DeferredList dojo/json dojo/dom dojo/dom-construct dojo/dom-style dojo/dom-class dijit/_Widget dojox/gfx dojox/gfx/matrix dojox/html/entities ../kernel ../config ../request ../lang ../numberUtils ../renderers/utils ../renderers/SimpleRenderer ../renderers/UniqueValueRenderer ../renderers/ClassBreaksRenderer ../renderers/ScaleDependentRenderer ../renderers/DotDensityRenderer ../renderers/TemporalRenderer ../renderers/VectorFieldRenderer ../renderers/HeatmapRenderer ../symbols/PictureFillSymbol ../symbols/SimpleLineSymbol ../symbols/jsonUtils ./_EventedWidget dojo/i18n!../nls/jsapi".split(" "),function(h,
n,g,e,l,f,m,d,b,J,y,u,r,a,s,B,F,q,t,v,L,P,G,H,D,Q,M,R,N,W,X,Y,T,Z,$,aa,S,ba,U){var K=n([ba,F],{declaredClass:"esri.dijit.Legend",widgetsInTemplate:!1,layers:null,alignRight:!1,hoverLabelShowing:!1,dotDensitySwatchSize:26,dotCoverage:75,gradientHeight:30,transparencyRampColor:new m([64,64,64]),defaultText:"Aa",sizeRampLightColor:new m([255,255,255]),sizeRampDarkColor:new m([128,128,128]),layerConnects:[],gradientWidth:34,colorRampBorder:"1px solid",_specialChars:{lt:"\x3c",gt:"\x3e"},_ieTimer:100,
_isRightToLeft:!1,_align:null,_legendAlign:null,constructor:function(c,a){g.mixin(this,U.widgets.legend);this._i18n=U.widgets.legend;c=c||{};c.map?a?(this.map=c.map,this.layerInfos=c.layerInfos,this._respectCurrentMapScale=!1===c.respectCurrentMapScale?!1:!0,this._respectVisibility=!1===c.respectVisibility?!1:!0,this.arrangement=c.arrangement===K.ALIGN_RIGHT?K.ALIGN_RIGHT:K.ALIGN_LEFT,this.arrangement===K.ALIGN_RIGHT&&(this.alignRight=!0),this.autoUpdate=!1===c.autoUpdate?!1:!0,this._surfaceItems=
[],this.hideLayersInLegend={},this.refresh=d(this.refresh,0)):console.error("esri.dijit.Legend: must specify a container for the legend"):console.error("esri.dijit.Legend: unable to find the 'map' property in parameters")},postMixInProperties:function(){this.inherited(arguments);var c=["ar","he"],a,b;for(a=0;a<c.length;a+=1)b=c[a],h.locale&&-1!==h.locale.indexOf(b)&&(-1!==h.locale.indexOf("-")?-1!==h.locale.indexOf(b+"-")&&(this._isRightToLeft=!0):this._isRightToLeft=!0);this._isRightToLeft?(this._align=
this.alignRight?"left":"right",this._legendAlign=this.alignRight?"esriLegendLeft":"esriLegendRight"):(this._align=this.alignRight?"right":"left",this._legendAlign=this.alignRight?"esriLegendRight":"esriLegendLeft")},startup:function(){this.inherited(arguments);this._initialize();9>b("ie")&&(this._repaintItems=g.hitch(this,this._repaintItems),setTimeout(this._repaintItems,this._ieTimer))},destroy:function(){this._deactivate();this._removeHoverHandlers();this.inherited(arguments)},refresh:function(c){if(this.domNode){c?
(this.layerInfos=c,this.layers=[],e.forEach(this.layerInfos,function(c){this._isSupportedLayerType(c.layer)&&(c.title&&(c.layer._titleForLegend=c.title),c.layer._hideDefaultSymbol=!1===c.defaultSymbol?!0:!1,c.hideLayers?(this.hideLayersInLegend[c.layer.id]=c.hideLayers,this._addSubLayersToHide(c)):this.hideLayersInLegend[c.layer.id]=[],c.hoverLabel&&(c.layer._hoverLabel=c.hoverLabel),c.hoverLabels&&(c.layer._hoverLabels=c.hoverLabels),this.layers.push(c.layer))},this)):this.useAllMapLayers&&(this.layers=
this.layerInfos=null);for(c=this.domNode.children.length-1;0<=c;c--)a.destroy(this.domNode.children[c]);this._removeHoverHandlers();this.startup()}},_legendUrl:"http://utility.arcgis.com/sharing/tools/legend",_initialize:function(){this.layerInfos&&(this.layers=[],e.forEach(this.layerInfos,function(c){this._isSupportedLayerType(c.layer)&&(c.title&&(c.layer._titleForLegend=c.title),c.layer._hideDefaultSymbol=!1===c.defaultSymbol?!0:!1,c.hideLayers?(this.hideLayersInLegend[c.layer.id]=c.hideLayers,
this._addSubLayersToHide(c)):this.hideLayersInLegend[c.layer.id]=[],c.hoverLabel&&(c.layer._hoverLabel=c.hoverLabel),c.hoverLabels&&(c.layer._hoverLabels=c.hoverLabels),this.layers.push(c.layer))},this));this.useAllMapLayers=!1;if(!this.layers){this.useAllMapLayers=!0;this.layers=[];var c=[],a=[];e.forEach(this.map.layerIds,function(b){b=this.map.getLayer(b);var d;this._isSupportedLayerType(b)&&(b.arcgisProps&&b.arcgisProps.title&&(b._titleForLegend=b.arcgisProps.title),this.layers.push(b));"esri.layers.KMLLayer"==
b.declaredClass&&(d=b.getLayers(),e.forEach(d,function(a){c.push(a.id)},this));"esri.layers.GeoRSSLayer"==b.declaredClass&&(d=b.getFeatureLayers(),e.forEach(d,function(c){a.push(c.id)},this))},this);e.forEach(this.map.graphicsLayerIds,function(b){var d=this.map.getLayer(b);-1==e.indexOf(c,b)&&-1==e.indexOf(a,b)&&(this._isSupportedLayerType(d)&&d._params&&d._params.drawMode)&&(d.arcgisProps&&d.arcgisProps.title&&(d._titleForLegend=d.arcgisProps.title),this.layers.push(d))},this)}this._createLegend()},
_activate:function(){this._deactivate();this.autoUpdate&&(this._respectCurrentMapScale&&(this._ozeConnect=l.connect(this.map,"onZoomEnd",this,"_refreshLayers")),this.useAllMapLayers&&(this._olaConnect=l.connect(this.map,"onLayerAdd",this,"_updateAllMapLayers"),this._olrConnect=l.connect(this.map,"onLayerRemove",this,"_updateAllMapLayers"),this._olroConnect=l.connect(this.map,"onLayersReordered",this,"_updateAllMapLayers")),e.forEach(this.layers,function(c){var a={};a.ovcConnect=l.connect(c,"onVisibilityChange",
this,"_refreshLayers");a.oocConnect=l.connect(c,"onOpacityChange",this,"_refreshLayers");a.oscConnect=l.connect(c,"onScaleRangeChange",this,"_refreshLayers");"esri.layers.ArcGISDynamicMapServiceLayer"===c.declaredClass&&c.supportsDynamicLayers&&(a.odcConnect=l.connect(c,"_onDynamicLayersChange",g.hitch(this,"_updateDynamicLayers",c)));"esri.layers.ArcGISImageServiceLayer"===c.declaredClass&&(a.oirConnect=l.connect(c,"onRenderingChange",g.partial(this._updateImageServiceLayers,this,c)));"esri.layers.ArcGISImageServiceVectorLayer"===
c.declaredClass&&(a.oivrConnect=l.connect(c,"onRendererChange",g.hitch(this,"_refreshLayers")));this.layerConnects[c.id]=a},this))},_deactivate:function(){this._ozeConnect&&l.disconnect(this._ozeConnect);this._olaConnect&&l.disconnect(this._olaConnect);this._olroConnect&&l.disconnect(this._olroConnect);this._olrConnect&&l.disconnect(this._olrConnect);e.forEach(this.layers,function(c){c=this.layerConnects[c.id]||{};c.ovcConnect&&l.disconnect(c.ovcConnect);c.oocConnect&&l.disconnect(c.oocConnect);c.oscConnect&&
l.disconnect(c.oscConnect);c.odcConnect&&l.disconnect(c.odcConnect);c.oirConnect&&l.disconnect(c.oirConnect);c.oivrConnect&&l.disconnect(c.oivrConnect)},this);this.layerConnects=[]},_updateDynamicLayers:function(c){delete c.legendResponse;this._refreshLayers()},_updateImageServiceLayers:function(c,a){delete a.legendResponse;c._refreshLayers()},_refreshLayers:function(){this.refresh()},_updateAllMapLayers:function(){this.layers=[];e.forEach(this.map.layerIds,function(c){c=this.map.getLayer(c);this._isSupportedLayerType(c)&&
this.layers.push(c)},this);e.forEach(this.map.graphicsLayerIds,function(c){c=this.map.getLayer(c);this._isSupportedLayerType(c)&&(c._params&&c._params.drawMode)&&this.layers.push(c)},this);this.refresh()},_createLegend:function(){var c=!1,b=!1;s.set(this.domNode,"position","relative");a.create("div",{id:this.id+"_msg",className:"esriLegendMsg",innerHTML:this.NLS_creatingLegend+"..."},this.domNode);var d=[];e.forEach(this.layers,function(k){if("esri.layers.KMLLayer"==k.declaredClass||"esri.layers.GeoRSSLayer"==
k.declaredClass){var x;k.loaded?("esri.layers.KMLLayer"==k.declaredClass?x=k.getLayers():"esri.layers.GeoRSSLayer"==k.declaredClass&&(x=k.getFeatureLayers(),this.hideLayersInLegend[k.id]&&(x=e.filter(x,function(c){return-1==e.indexOf(this.hideLayersInLegend[k.id],c.id)},this))),e.forEach(x,function(c){"esri.layers.FeatureLayer"==c.declaredClass&&k._titleForLegend&&(c._titleForLegend=k._titleForLegend+" - ","esriGeometryPoint"==c.geometryType?c._titleForLegend+=this.NLS_points:"esriGeometryPolyline"==
c.geometryType?c._titleForLegend+=this.NLS_lines:"esriGeometryPolygon"==c.geometryType&&(c._titleForLegend+=this.NLS_polygons),d.push(c))},this)):l.connect(k,"onLoad",g.hitch(this,function(){this.refresh(this.layerInfos)}))}else if("esri.layers.WMSLayer"===k.declaredClass)if(k.loaded){if((!this._respectVisibility||this._respectVisibility&&k.visible)&&0<k.layerInfos.length&&e.some(k.layerInfos,function(c){return c.legendURL})){var f=!1;e.forEach(k.layerInfos,function(b){b.legendURL&&-1<e.indexOf(k.visibleLayers,
b.name)&&(f||(a.create("div",{innerHTML:"\x3cspan class\x3d'esriLegendServiceLabel'\x3e"+(k._titleForLegend||k.name||k.id)+"\x3c/span\x3e"},this.domNode),f=!0),a.create("div",{innerHTML:"\x3cimg src\x3d'"+b.legendURL+"'/\x3e"},this.domNode),c=!0)},this)}}else l.connect(k,"onLoad",g.hitch(this,function(){this.refresh(this.layerInfos)}));else"esri.layers.WFSLayer"===k.declaredClass&&!k.renderer?(x=a.create("div",{id:this.id+"_"+k.id,"class":"esriLegendService"}),a.create("span",{innerHTML:this._getServiceTitle(k),
"class":"esriLegendServiceLabel"},a.create("td",{align:this._align},a.create("tr",{},a.create("tbody",{},a.create("table",{width:"95%"},x))))),a.place(x,this.id,"first"),tableNode=a.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},x),tableBody=a.create("tbody",{},tableNode),"esriGeometryComplex"===k.geometryType?(this._buildRow_Renderer(k,k._pointSymbol,null,this.NLS_points,null,tableBody),this._buildRow_Renderer(k,k._lineSymbol,null,this.NLS_lines,null,tableBody),
this._buildRow_Renderer(k,k._polygonSymbol,null,this.NLS_areas,null,tableBody)):"esriGeometryPoint"===k.geometryType?this._buildRow_Renderer(k,k._pointSymbol,null,"",null,tableBody):"esriGeometryPolyline"===k.geometryType?this._buildRow_Renderer(k,k._lineSymbol,null,"",null,tableBody):"esriGeometryPolygon"===k.geometryType&&this._buildRow_Renderer(k,k._polygonSymbol,null,"",null,tableBody),b=!0):d.push(k)},this);var x=[];e.forEach(d,function(c){if(c.loaded){if((!this._respectVisibility||this._respectVisibility&&
c.visible)&&(c.layerInfos||c.renderer||"esri.layers.ArcGISImageServiceLayer"==c.declaredClass)){var b=a.create("div",{id:this.id+"_"+c.id,style:{display:"none"},"class":"esriLegendService"});a.create("span",{innerHTML:this._getServiceTitle(c),"class":"esriLegendServiceLabel"},a.create("td",{align:this._align},a.create("tr",{},a.create("tbody",{},a.create("table",{width:"95%"},b)))));a.place(b,this.id,"first");c.legendResponse||c.renderer?this._createLegendForLayer(c):x.push(this._legendRequest(c))}}else var V=
l.connect(c,"onLoad",this,function(c){l.disconnect(V);V=null;this.refresh()})},this);0===x.length&&!c&&!b?(r.byId(this.id+"_msg").innerHTML=this.NLS_noLegend,this._activate()):(new y(x)).addCallback(g.hitch(this,function(a){!c&&!b?r.byId(this.id+"_msg").innerHTML=this.NLS_noLegend:r.byId(this.id+"_msg").innerHTML="";this._activate()}))},_createLegendForLayer:function(c){if(c.legendResponse||c.renderer){var a=!1;if(c.legendResponse){var b=c.dynamicLayerInfos||c.layerInfos;b&&b.length?e.forEach(b,function(b,
d){if(!this.hideLayersInLegend[c.id]||-1==e.indexOf(this.hideLayersInLegend[c.id],b.id)){var I=this._buildLegendItems(c,b,d);a=a||I}},this):"esri.layers.ArcGISImageServiceLayer"==c.declaredClass&&(a=this._buildLegendItems(c,{id:0,name:null,title:c.name,subLayerIds:null,parentLayerId:-1},0))}else c.renderer&&(b=c.url?c.url.substring(c.url.lastIndexOf("/")+1,c.url.length):"fc_"+c.id,a=this._buildLegendItems(c,{id:b,name:null,subLayerIds:null,parentLayerId:-1},0));a&&(s.set(r.byId(this.id+"_"+c.id),
"display","block"),s.set(r.byId(this.id+"_msg"),"display","none"))}},_legendRequest:function(c){if(c.loaded)return 10.01<=c.version?this._legendRequestServer(c):this._legendRequestTools(c);l.connect(c,"onLoad",g.hitch(this,"_legendRequest"))},_legendRequestServer:function(c){var a=c.url,b=a.indexOf("?"),a=-1<b?a.substring(0,b)+"/legend"+a.substring(b):a+"/legend";(b=c._getToken())&&(a+="?token\x3d"+b);var d=g.hitch(this,"_processLegendResponse"),k={f:"json"};c._params.dynamicLayers&&(k.dynamicLayers=
u.stringify(this._createDynamicLayers(c)),"[{}]"===k.dynamicLayers&&(k.dynamicLayers="[]"));c._params.bandIds&&(k.bandIds=c._params.bandIds);c._params.renderingRule?k.renderingRule=c._params.renderingRule:c.rasterFunctionInfos&&0<c.rasterFunctionInfos.length&&e.forEach(c.rasterFunctionInfos,function(c){c&&(c.name&&"none"===c.name.toLowerCase())&&(k.renderingRule=u.stringify({rasterFunction:c.name}))});return G({url:a,content:k,callbackParamName:"callback",load:function(a,b){d(c,a,b)},error:P.defaults.io.errorHandler})},
_legendRequestTools:function(c){var a=c.url.toLowerCase().indexOf("/rest/"),a=c.url.substring(0,a)+c.url.substring(a+5,c.url.length),a=this._legendUrl+"?soapUrl\x3d"+window.escape(a);if(!b("ie")||8<b("ie"))a+="\x26returnbytes\x3dtrue";var d=g.hitch(this,"_processLegendResponse");return G({url:a,content:{f:"json"},callbackParamName:"callback",load:function(a,b){d(c,a,b)},error:P.defaults.io.errorHandler})},_processLegendResponse:function(c,b){b&&b.layers?(c.legendResponse=b,r.byId(this.id+"_"+c.id)&&
a.empty(r.byId(this.id+"_"+c.id)),a.create("span",{innerHTML:this._getServiceTitle(c),"class":"esriLegendServiceLabel"},a.create("td",{align:this._align},a.create("tr",{},a.create("tbody",{},a.create("table",{width:"95%"},r.byId(this.id+"_"+c.id)))))),this._createLegendForLayer(c)):console.log("Legend could not get generated for "+c.url+": "+f.toJson(b))},_buildLegendItems:function(c,b,d){var x=!1,k=r.byId(this.id+"_"+c.id),e=b.parentLayerId;if(b.subLayerIds)c=a.create("div",{id:this.id+"_"+c.id+
"_"+b.id+"_group",style:{display:"none"},"class":-1==e?0<d?"esriLegendGroupLayer":"":this._legendAlign},-1==e?k:r.byId(this.id+"_"+c.id+"_"+e+"_group")),a.create("td",{innerHTML:v.encode(b.name),align:this._align},a.create("tr",{},a.create("tbody",{},a.create("table",{width:"95%","class":"esriLegendLayerLabel"},c))));else{if(this._respectVisibility&&c.visibleLayers&&-1==(","+c.visibleLayers+",").indexOf(","+b.id+","))return x;d=a.create("div",{id:this.id+"_"+c.id+"_"+b.id,style:{display:"none"},"class":-1<
e?this._legendAlign:""},-1==e?k:r.byId(this.id+"_"+c.id+"_"+e+"_group"));a.create("td",{innerHTML:v.encode(b.name)||"",align:this._align},a.create("tr",{},a.create("tbody",{},a.create("table",{width:"95%","class":"esriLegendLayerLabel"},d))));c.legendResponse?x=x||this._buildLegendItems_Tools(c,b,d):c.renderer&&(x=x||this._buildLegendItems_Renderer(c,b,d))}return x},_buildLegendItems_Tools:function(c,b,d){var x=b.parentLayerId,k=this.map.getScale(),C=!1,g=function(c,a){var b,d;for(b=0;b<c.length;b++)if(a.dynamicLayerInfos)for(d=
0;d<a.dynamicLayerInfos[d].length;d++){if(a.dynamicLayerInfos[d].mapLayerId==c[b].layerId)return c[b]}else if(a.id==c[b].layerId)return c[b];return{}};if(!this._respectCurrentMapScale||this._respectCurrentMapScale&&this._isLayerInScale(c,b,k)){var f=!0;if(this._respectCurrentMapScale&&("esri.layers.ArcGISDynamicMapServiceLayer"===c.declaredClass||"esri.layers.ArcGISMapServiceLayer"===c.declaredClass)){var h=this._getEffectiveScale(c,b);if(h.minScale&&h.minScale<k||h.maxScale&&h.maxScale>k)f=!1}if(f){var k=
g(c.legendResponse.layers,b),w=k.legendType,p=k.layerType,l=k.legend;if(l){"esri.layers.ArcGISImageServiceLayer"!==c.declaredClass&&this._sanitizeLegendResponse(c,k,b);d=a.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},d);var m=a.create("tbody",{},d);(c._hoverLabel||c._hoverLabels)&&this._createHoverAction(d,c,b);e.forEach(l,function(a){if(!(10.1<=c.version&&!a.values&&1<l.length&&(c._hideDefaultSymbol||"\x3call other values\x3e"===a.label||!a.label&&!("esri.layers.ArcGISImageServiceLayer"===
c.declaredClass&&10.3<=c.version||"Raster Layer"===p))))if(a.url&&0===a.url.indexOf("http")||a.imageData&&0<a.imageData.length)C=!0,this._buildRow_Tools(a,m,c,b.id,w)},this)}}}C&&(s.set(r.byId(this.id+"_"+c.id+"_"+b.id),"display","block"),-1<x&&(s.set(r.byId(this.id+"_"+c.id+"_"+x+"_group"),"display","block"),this._findParentGroup(c.id,c,x)));return C},_sanitizeLegendResponse:function(c,a,b){var d=a.legend;if(10.1<=c.version&&1<d.length&&!a._sanitized){c=g.getObject("layerDefinition.drawingInfo.renderer",
!1,b);var k,C;c||(c=g.getObject("drawingInfo.renderer",!1,b));e.some(d,function(c){if(c.values)return!0})&&e.some(d,function(c,a){c.values||(C=a,k=c);return!!k});c?"uniqueValue"===c.type?k&&(d.splice(C,1),d.push(k)):"classBreaks"===c.type&&(k&&d.splice(C,1),d.reverse(),k&&d.push(k)):k&&(d.splice(C,1),d.push(k));a._sanitized=!0}},_buildRow_Tools:function(c,d,I,e,k){var C=a.create("tr",{},d),g;this.alignRight?(d=a.create("td",{align:this._isRightToLeft?"left":"right"},C),g=a.create("td",{align:this._isRightToLeft?
"left":"right",width:35},C)):(g=a.create("td",{width:35,align:"center"},C),d=a.create("td",{},C));C=c.url;(!b("ie")||9<=b("ie")||9>b("ie")&&"esri.layers.ArcGISImageServiceLayer"===I.declaredClass)&&c.imageData&&0<c.imageData.length?C="data:image/png;base64,"+c.imageData:0!==c.url.indexOf("http")&&(C=I.url+"/"+e+"/images/"+c.url,(e=I._getToken())&&(C+="?token\x3d"+e));e=a.create("img",{src:C,border:0,style:"opacity:"+I.opacity},g);c=a.create("td",{innerHTML:v.encode(c.label),align:this._align},a.create("tr",
{},a.create("tbody",{},a.create("table",{width:"95%",dir:"ltr"},d))));k&&("Stretched"===k&&10.3<=I.version&&"esri.layers.ArcGISImageServiceLayer"===I.declaredClass)&&(c.style.verticalAlign="top",c.style.lineHeight="1",e.style.marginBottom="-1px",e.style.display="block",d.style.verticalAlign="top");9>b("ie")&&(e.style.filter="alpha(opacity\x3d"+100*I.opacity+")")},_getVariable:function(c,a,b){var d;c&&(d=(c=c.getVisualVariablesForType(a,b))&&c[0]);return d},_getVariables:function(c,a,b){c=[this._getVariable(c,
"colorInfo",!1),this._getVariable(c,"opacityInfo",!1),this._getVariable(c,"sizeInfo",!1)];return a?e.filter(c,function(c){return!(!c||!(c.field===a&&c.normalizationField==b))}):c},_getFieldAlias:function(c,a){var b=a.infoTemplate,b=b&&b.getFieldInfo&&b.getFieldInfo(c),d=g.isFunction(c)?null:a.getField(c),k=b||d,e="";k&&(e=b&&b.label||d&&d.alias||k.name||k.fieldName);return e},_getRampTitle:function(c,a){var b,d=c.field,k=c.normalizationField,e=!1,f=!1,h=!1,A,d=g.isFunction(d)?null:d,k=g.isFunction(k)?
null:k;if(c.legendOptions&&c.legendOptions.title)b=c.legendOptions.title;else{if(a.renderer.authoringInfo&&a.renderer.authoringInfo.visualVariables){var w=a.renderer.authoringInfo.visualVariables;for(A=0;A<w.length;A++){var p=w[A];if("colorInfo"===p.type&&"ratio"===p.style){e=!0;break}else if("colorInfo"===p.type&&"percent"===p.style){f=!0;break}else if("colorInfo"===p.type&&"percentTotal"===p.style){h=!0;break}}}(e=h&&"showRatioPercentTotal"||f&&"showRatioPercent"||e&&"showRatio"||k&&"showNormField"||
d&&"showField"||null)&&(b=H.substitute({field:d&&this._getFieldAlias(d,a),normField:k&&this._getFieldAlias(k,a)},this._i18n[e]))}return b},_getRendererTitle:function(c,a){var b;if(c){var d,k,e;c instanceof N&&(d=c.attributeField,k=c.normalizationField,e="percent-of-total"===c.normalizationType);d=g.isFunction(d)?null:d;(e=(k=g.isFunction(k)?null:k)&&"showNormField"||(e?"showNormPct":null)||d&&"showField"||null)&&(b=H.substitute({field:d&&this._getFieldAlias(d,a),normField:k&&this._getFieldAlias(k,
a)},this._i18n[e]))}return b},_buildLegendItems_Renderer:function(c,b,d){var x=b.parentLayerId,k=this.map,f=k.getScale(),h,z=!1;if(!this._respectCurrentMapScale||this._isLayerInScale(c,b,f)){var A,w,p="esri.layers.ArcGISImageServiceVectorLayer"===c.declaredClass?c.renderer.renderer:c.renderer,l,m,q,n,t;if(p instanceof W&&(p=(p="zoom"===p.rangeType?p.getRendererInfoByZoom(k.getZoom()):p.getRendererInfoByScale(f))&&p.renderer,!p))return!1;var E=this._getVariables(p),u=e.filter(E,function(c){return!!c}).length,
f=E[0],k=E[1],E=E[2],y,D;f&&(l=this._getMedianColor(p,f),f.field&&(q=g.isFunction(f.field)?null:c.getField(f.field)));k&&k.field&&(t=g.isFunction(k.field)?null:c.getField(k.field));E&&E.field&&(n=g.isFunction(E.field)?null:c.getField(E.field));if(p instanceof Z)h=z=!0,this._showHeatRamp(c,b,p,d);else if(p instanceof X)h=z=!0,this._showDotDensityLegend(c,b,p,d);else if(p instanceof Y)h=z=!0,w=a.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},d),A=a.create("tbody",
{},w),(c._hoverLabel||c._hoverLabels)&&this._createHoverAction(w,c,b),p.latestObservationRenderer&&p.latestObservationRenderer instanceof M&&this._buildRow_Renderer(c,p.latestObservationRenderer.symbol,l,v.encode(p.latestObservationRenderer.label)||this.NLS_currentObservations,null,A),p.observationRenderer&&p.observationRenderer instanceof M&&this._buildRow_Renderer(c,p.observationRenderer.symbol,l,v.encode(p.observationRenderer.label)||this.NLS_previousObservations,null,A);else if(p instanceof R){if(p.infos&&
0<p.infos.length){h=z=!0;w=a.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},d);A=a.create("tbody",{},w);(c._hoverLabel||c._hoverLabels)&&this._createHoverAction(w,c,b);p.attributeField&&E&&this._addSubHeader(A,this._getFieldAlias(p.attributeField,c));var B=[];e.forEach(p.infos,function(a){var b=null;c._editable&&c.types&&(b=this._getTemplateFromTypes(c.types,a.value));var d=a.label;null==d&&(d=a.value);-1===e.indexOf(B,d)&&(B.push(d),this._buildRow_Renderer(c,a.symbol,
l,v.encode(d),b,A))},this)}D=this._displayDefaultSymbol(c,p,d)}else if(p instanceof N){if(p.infos&&0<p.infos.length||"esri.layers.ArcGISImageServiceVectorLayer"===c.declaredClass){h=z=!0;y=this._isUnclassedRenderer(p);!f&&1===p.infos.length&&(m=(m=p.infos[0])&&m.symbol);y||(w=a.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},d),A=a.create("tbody",{},w),u=this._getRendererTitle(p,c),this._buildRow_Renderer(c,null,l,v.encode(u),null,A));w=a.create("table",{cellpadding:0,
cellspacing:0,width:"95%","class":"esriLegendLayer"},d);A=a.create("tbody",{},w);(c._hoverLabel||c._hoverLabels)&&this._createHoverAction(w,c,b);if(!y||!E)u=p.infos.slice(0).reverse(),e.forEach(u,function(a){var b=a.label;null==b&&!y&&(b=a.minValue+" - "+a.maxValue);this._buildRow_Renderer(c,a.symbol,l,v.encode(b),null,A)},this);if("esri.layers.ArcGISImageServiceVectorLayer"===c.declaredClass&&(c.renderer.style===T.STYLE_SCALAR||c.renderer.style===T.STYLE_SINGLE_ARROW))this._buildRow_Renderer(c,p.defaultSymbol,
null,"",null,A),c._hideDefaultSymbol=!0}y||(D=this._displayDefaultSymbol(c,p,d))}else p instanceof M&&(h=z=!0,w=a.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},d),A=a.create("tbody",{},w),(c._hoverLabel||c._hoverLabels)&&this._createHoverAction(w,c,b),m=null,c._editable&&(c.templates&&0<c.templates.length)&&(m=c.templates[0]),w=1<u?null:q||t||n,this._buildRow_Renderer(c,p.symbol,l,v.encode(w?this._getRampTitle(1<u?null:f||k||E,c):p.label),m,A),m=f?null:p.symbol,
w&&(q=t=n=null));if(h){if(f&&(f.field||f.valueExpression))this._showGradientRamp(c,b,p,null,d,f,q,null,E?!0:!1);if(E&&(E.field||E.valueExpression))h=f||p instanceof R?!1:!0,this._showSizeLegend(c,b,p,E,l,d,n,null,h);if(k&&(k.field||k.valueExpression))n=m&&!m.url&&m.color?m.color:this.transparencyRampColor,this._showGradientRamp(c,b,p,n,d,k,t,null,!1)}D||(D=this._displayDefaultSymbol(c,p,d));z=z||D}z&&(s.set(r.byId(this.id+"_"+c.id+"_"+b.id),"display","block"),-1<x&&(s.set(r.byId(this.id+"_"+c.id+
"_"+x+"_group"),"display","block"),this._findParentGroup(c.id,x)));return z},_isUnclassedRenderer:function(c,a){var b;if(c instanceof N&&c.infos&&1===c.infos.length){b=c.attributeField;var d=c.normalizationField;b=a?b===a:!!this._getVariables(c,b,d).length}return b},_displayDefaultSymbol:function(c,b,d){var e;!c._hideDefaultSymbol&&b.defaultSymbol&&(e=!0,d=a.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},d),d=a.create("tbody",{},d),this._buildRow_Renderer(c,b.defaultSymbol,
null,v.encode(b.defaultLabel)||"others",null,d));return e},_showGradientRamp:function(c,b,d,e,k,f,h,z,l){l=a.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"+(!l?" esriLegendSubFragment":"")},k);k=a.create("tbody",{},l);(c._hoverLabel||c._hoverLabels||z)&&this._createHoverAction(l,c,b,z);(h||f.valueExpression)&&this._addSubHeader(k,this._getRampTitle(f,c));b=f.field;var m;b&&(m=g.isFunction(b)?null:c.getField(b));(f=this._getRampStops(d,f,e,m&&"esriFieldTypeDate"===
m.type))&&f.length&&this._drawGradientRamp(k,f,!0,c,this._getRampBorderColor(d),!!e)},_getMedianColor:function(c,a){var b,d;a.colors?(b=a.minDataValue,d=a.maxDataValue):a.stops&&(b=a.stops[0].value,d=a.stops[a.stops.length-1].value);return c.getColor(b+(d-b)/2,{colorInfo:a})},_getRampStops:function(c,a,b,d){var k,f,g,h,l=!1;a.colors||a.opacityValues?(f=a.maxDataValue-a.minDataValue,k=e.map([0,0.25,0.5,0.75,1],function(c){g=a.minDataValue+c*f;return Number(g.toFixed(6))}),this._checkPrecision(0,4,
k)):a.stops&&(k=e.map(a.stops,function(c){return c.value}),(l=e.some(a.stops,function(c){return!!c.label}))&&(h=e.map(a.stops,function(c){return c.label})));var w=k[0],p,q;f=k[k.length-1]-w;return e.map(k,function(e,g){b?(p=new m(b.toRgba()),q=c.getOpacity(e,{opacityInfo:a}),null!=q&&(p.a=q)):p=c.getColor(e,{colorInfo:a});var O="";if(l)O=h[g];else{var O=d?Q.formatDate(e,Q.timelineDateFormatOptions):D.format(e),n="";0===g?n=this._specialChars.lt+" ":g===k.length-1&&(n=this._specialChars.gt+" ");O=
n+O}return{value:e,color:p,offset:1-(e-w)/f,label:O}},this).reverse()},_checkPrecision:function(c,a,b){var d=c+(a-c)/2,e=b[c],f=b[d],g=b[a],h=Math.floor(e),l=Math.floor(f),m=Math.floor(g);h===e&&(m===g&&l!==f&&h!==l&&m!==l)&&(b[d]=l);c+1!==d&&this._checkPrecision(c,d,b);d+1!==a&&this._checkPrecision(d,a,b)},_getRampBorderColor:function(c){var a;if(c instanceof M)a=c.symbol;else if(c instanceof R||c instanceof N)a=c.infos[0].symbol;return(c=a&&-1===a.type.indexOf("linesymbol")?a.getStroke():null)&&
c.color},_drawGradientRamp:function(c,d,f,g,k,h){var l=a.create("tr",{},c),z,A,w,p,n,r=d.length-1,t;p=0;this.alignRight?(c=a.create("td",{align:this._isRightToLeft?"left":"right"},l),z=a.create("td",{align:this._isRightToLeft?"left":"right",width:this.gradientWidth},l)):(z=a.create("td",{width:this.gradientWidth,align:"center"},l),c=a.create("td",{},l));l=k&&0<k.a&&!(240<=k.r&&240<=k.g&&240<=k.b);A=a.create("div",{"class":l?"":"esriLegendBorderLessColorRamp",style:"position: relative; width:"+this.gradientWidth+
"px;"},z);z=a.create("div",{"class":"esriLegendColorRamp"+(h?" esriLegendTransparencyRamp":"")},A);h=s.get(z,"width");l&&(k=9>b("ie")?k.toHex():"rgba("+k.toRgba().join(",")+")",s.set(z,"border",this.colorRampBorder+" "+k));f?(k=this.gradientHeight*r,s.set(z,"height",k+"px")):k=s.get(z,"height");s.set(A,"height",k+"px");l=q.createSurface(z,h,k);9>b("ie")&&(p=l.getEventSource(),s.set(p,"position","relative"),s.set(p.parentNode,"position","relative"),p=1);try{f&&e.forEach(d,function(c,a){c.offset=a/
r}),n=l.createRect({x:-p,y:-p,width:h+p,height:k+p}),n.setFill({type:"linear",x1:0,y1:0,x2:0,y2:k,colors:d}).setStroke(null),l.createRect({width:h,height:k}).setFill(new m([255,255,255,1-g.opacity])).setStroke(null),this._surfaceItems.push(l)}catch(u){l.clear(),l.destroy()}e.forEach(d,function(c,b){if(c.label){t="top:"+100*c.offset+"%;";var e="";0===b&&(e+=" esriLegendColorRampTickFirst");b===d.length-1&&(e+=" esriLegendColorRampTickLast");a.create("div",{"class":"esriLegendColorRampTick"+e,innerHTML:"\x26nbsp;",
style:t},A)}});w=a.create("div",{"class":"esriLegendColorRampLabels",style:{height:k+this.gradientHeight+"px"}},c);f?e.forEach(d,function(c){a.create("div",{"class":"esriLegendColorRampLabel",innerHTML:v.encode(c.label)||"\x26nbsp;"},w)}):(a.create("div",{"class":"esriLegendColorRampLabel",innerHTML:this._i18n.high},w),a.create("div",{"class":"esriLegendColorRampLabel",innerHTML:this._i18n.low,style:"top: "+(k+this.gradientHeight-2*this.gradientHeight)+"px;"},w))},_showHeatRamp:function(c,b,d,e,k){var f,
g=d.field;f=a.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},e);e=a.create("tbody",{},f);(c._hoverLabel||c._hoverLabels||k)&&this._createHoverAction(f,c,b,k);(g=g&&c.getField(g))&&this._addSubHeader(e,this._getFieldAlias(g.name,c));b=this._getHeatmapStops(d);b.length&&this._drawGradientRamp(e,b,!1,c)},_getHeatmapStops:function(c){var a=c.colorStops;c=c.colors;var b,d,k,f;if(a&&a[0])if(b=a.length-1,c=a[0]&&null!=a[0].ratio){if((c=a[b])&&1!==c.ratio)a=a.slice(0),
a.push({ratio:1,color:c.color}),b++}else d=a[0].value,k=a[b].value-d,a=e.map(a,function(c){return{color:c.color,ratio:(c.value-d)/k}});else c&&c[0]&&(b=c.length-1,f=1/(c.length-1),a=e.map(c,function(c,a){return{color:c,ratio:a*f}}));a=e.map(a,function(c,a){var d="";0===a?d="Low":a===b&&(d="High");return{color:c.color,label:d,offset:1-c.ratio}});return a.reverse()},_showDotDensityLegend:function(c,b,d,f){var k=d.legendOptions,h,l,m,q,n,p,s,r=this.dotDensitySwatchSize,t=Math.round(r/2);k&&(l=k.backgroundColor,
m=k.outline,q=k.valueUnit,n=k.dotCoverage);n=(n||this.dotCoverage)/100;s=Math.round(r*r/Math.pow(d.dotSize,2)*n);f=a.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},f);p=a.create("tbody",{},f);(c._hoverLabel||c._hoverLabels)&&this._createHoverAction(f,c,b);this._addSubHeader(p,H.substitute({value:d.dotValue,unit:q||""},this.NLS_dotValue));e.forEach(d.fields,function(a){a=g.mixin({},a);a.numPoints=s;h=new $(d._generateImageSrc(r,r,[a],{x:0,y:0},{x:r,y:r},l),m||d.outline,
r,r);a=c.getField(a.name)||a;this._buildRow_Renderer(c,h,null,v.encode(this._getFieldAlias(a.name,c)),null,p,{type:"path",path:"M "+-t+","+-t+" L "+t+","+-t+" L "+t+","+t+" L "+-t+","+t+" L "+-t+","+-t+" E"})},this)},_showSizeLegend:function(c,b,d,e,k,f,h,l,m){var n=e.legendOptions,n=n&&n.customValues;k=this._getSizeSymbol(d,k);if(!(e.valueUnit&&"unknown"!==e.valueUnit||!k||!n&&(null==e.minSize||null==e.maxSize))){m=a.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"+
(!m?" esriLegendSubFragment":"")},f);f=a.create("tbody",{},m);(c._hoverLabel||c._hoverLabels||l)&&this._createHoverAction(m,c,b,l);(h||e.valueExpression)&&this._addSubHeader(f,this._getRampTitle(e,c));b=e.field;var p;b&&(p=g.isFunction(b)?null:c.getField(b));p=p&&"esriFieldTypeDate"===p.type;n=n||this._getDataValues(d,k,e,p);for(b=m=n.length-1;0<=b;b--)h=n[b],k=S.fromJson(k.toJson()),this._applySize(k,d,e,h),h=p?Q.formatDate(h,Q.timelineDateFormatOptions):D.format(h),l="",b===m?l=this._specialChars.gt+
" ":0===b&&(l=this._specialChars.lt+" "),l="\x3cspan class\x3d'esriLegendSizeRampLabel'\x3e"+v.encode(l+h)+"\x3c/span\x3e",this._buildRow_Renderer(c,k,null,l,null,f)}},_getSizeSymbol:function(c,a){var b,d;if(c instanceof M)b=c.symbol;else if(c instanceof T)b=c.defaultSymbol;else if(c instanceof R||c instanceof N)b=c.infos[0].symbol,d=1<c.infos.length;if(b=b&&-1!==b.type.indexOf("fillsymbol")?null:b)if(b=S.fromJson(b.toJson()),a||d)-1!==b.type.indexOf("linesymbol")?b.setColor(new m(this.sizeRampDarkColor)):
(b.setColor(new m(this.sizeRampLightColor)),b.setOutline&&(d=new aa,d.setColor(new m(this.sizeRampDarkColor)),d.setWidth(1.5),b.setOutline(d)));return b},_getDataValues:function(c,a,b,d,k,f){k=null==k?5:k;f=null==f?20:f;var g=c.getSizeRangeAtScale(b,this.map.getScale());k=this._interpolateSizeRange(g,k);var h=e.map(k,function(c){return this._getDataValueFromSize(c,b,g)},this);if(!d){var l,h=D.round(h);for(d=1;d<h.length-1;d++)if(l=this._roundDataValue(c,a,b,h[d],h[d-1],f))h[d]=l[0],k[d]=l[1]}return h},
_interpolateSizeRange:function(c,a){var b=c.minSize,d=(c.maxSize-b)/(a-1),e,f=[];for(e=0;e<a;e++)f.push(b+d*e);return f},_getDataValueFromSize:function(c,a,b){var d=b.minSize;b=b.maxSize;var e=a.minDataValue;a=a.maxDataValue;return c=c<=d?e:c>=b?a:(c-d)/(b-d)*(a-e)+e},_roundDataValue:function(c,a,b,d,e,f){var g=this._getSize(a,c,b,d);e=this._getSize(a,c,b,e);var h,l=D.getDigits(d),m=l.integer,l=l.fractional,p,n,q,s,r,t,u,v,y,B,F;0<d&&1>d&&(h=Math.pow(10,l),d*=h,m=D.getDigits(d).integer);for(m-=1;0<=
m&&!(p=Math.pow(10,m),l=Math.floor(d/p)*p,p*=Math.ceil(d/p),null!=h&&(l/=h,p/=h),n=(l+p)/2,n=D.round([l,n,p],{indexes:[1]})[1],q=this._getSize(a,c,b,l),s=this._getSize(a,c,b,p),r=this._getSize(a,c,b,n),t=D.getPctChange(g,q,e,null),u=D.getPctChange(g,s,e,null),v=D.getPctChange(g,r,e,null),y=t.prev<=f,B=u.prev<=f,y&&B&&(t.prev<=u.prev?(y=!0,B=!1):(B=!0,y=!1)),y?F=[l,q]:B?F=[p,s]:v.prev<=f&&(F=[n,r]),F);m--);return F},_applySize:function(c,a,b,d){var e=c.type;a=this._getSize(c,a,b,d);switch(e){case "simplemarkersymbol":c.setSize(a);
break;case "picturemarkersymbol":e=c.width;b=c.height;c.setHeight(a);c.setWidth(a*(e/b));break;case "simplelinesymbol":case "cartographiclinesymbol":c.setWidth(a);break;case "textsymbol":c.font&&c.font.setSize(a)}},_getSize:function(c,a,b,d){return a.getSize(d,{sizeInfo:b,scale:this.map.getScale(),shape:-1!==c.type.indexOf("markersymbol")?c.style:null})},_buildRow_Renderer:function(c,b,d,e,k,f,h){var g=a.create("tr",{},f),l;this.alignRight?(f=a.create("td",{align:this._isRightToLeft?"left":"right"},
g),b&&(l=a.create("td",{align:this._isRightToLeft?"left":"right",width:35},g))):(b&&(l=a.create("td",{width:35,align:"center"},g)),f=a.create("td",{},g));var m=g=30,p;if(b){if("simplemarkersymbol"==b.type)g=Math.min(Math.max(g,b.size+12),125),m=Math.min(Math.max(m,b.size+12),125);else if("picturemarkersymbol"==b.type)g=Math.min(Math.max(g,b.width),125),m=Math.min(b.height||m,125);else if("textsymbol"==b.type){var n,q;b.text||(n=b.text,q=!0,b.setText(this.defaultText));g=Math.min(Math.max(g,b.getWidth()+
12),125);m=Math.min(Math.max(m,b.getHeight()+12),125);q&&b.setText(n)}p=a.create("div",{style:"width:"+g+"px;height:"+m+"px;"},l)}H.isDefined(e)&&"number"===typeof e&&(e=""+e);a.create("td",{innerHTML:e||"",align:this._align},a.create("tr",{},a.create("tbody",{},a.create("table",{width:"95%"},f))));b&&(c=this._drawSymbol(p,b,d,g,m,k,c,h),this._surfaceItems.push(c))},_addSubHeader:function(c,b){var d=a.create("tr",{},c),d=a.create("td",{align:this._align,colspan:2},d);a.create("td",{innerHTML:v.encode(b)||
"",align:this._align},a.create("tr",{},a.create("tbody",{},a.create("table",{width:"95%"},d))))},_drawSymbol:function(c,a,d,e,k,f,h,l){a=S.fromJson(a.toJson());var n=h.opacity;d&&a.setColor(new m(d.toRgba()));if("simplelinesymbol"===a.type||"cartographiclinesymbol"===a.type||"textsymbol"===a.type){if(!a.color)return;d=a.color.toRgba();d[3]*=n;a.color.setColor(d)}else"simplemarkersymbol"===a.type||"simplefillsymbol"===a.type?(a.color&&(d=a.color.toRgba(),d[3]*=n,a.color.setColor(d)),a.outline&&a.outline.color&&
(d=a.outline.color.toRgba(),d[3]*=n,a.outline.color.setColor(d))):"picturemarkersymbol"===a.type&&(c.style.opacity=n,c.style.filter="alpha(opacity\x3d("+100*n+"))");c=q.createSurface(c,e,k);9>b("ie")&&(d=c.getEventSource(),s.set(d,"position","relative"),s.set(d.parentNode,"position","relative"));f=this._getDrawingToolShape(a,f)||S.getShapeDescriptors(a);var r,n=(d=f.defaultShape)&&"text"===d.type;try{n&&!d.text&&(d.text=this.defaultText),r=c.createShape(l||d).setFill(f.fill).setStroke(f.stroke),n&&
r.setFont(f.font)}catch(p){c.clear();c.destroy();return}var u=r.getBoundingBox();l=u.width;f=u.height;var n=-(u.x+l/2),v=-(u.y+f/2);d=c.getDimensions();n={dx:n+d.width/2,dy:v+d.height/2};if("simplemarkersymbol"===a.type&&"path"===a.style)e=h._getScaleMatrix(u,a.size),r.applyTransform(t.scaleAt(e.xx,e.yy,{x:d.width/2,y:d.height/2}));else if(l>e||f>k)h=l/e>f/k,e=((h?e:k)-5)/(h?l:f),g.mixin(n,{xx:e,yy:e});r.applyTransform(n);return c},_getDrawingToolShape:function(c,a){var b;switch(a?a.drawingTool||
null:null){case "esriFeatureEditToolArrow":b={type:"path",path:"M 10,1 L 3,8 L 3,5 L -15,5 L -15,-2 L 3,-2 L 3,-5 L 10,1 E"};break;case "esriFeatureEditToolTriangle":b={type:"path",path:"M -10,14 L 2,-10 L 14,14 L -10,14 E"};break;case "esriFeatureEditToolRectangle":b={type:"path",path:"M -10,-10 L 10,-10 L 10,10 L -10,10 L -10,-10 E"};break;case "esriFeatureEditToolCircle":b={type:"circle",cx:0,cy:0,r:10};break;case "esriFeatureEditToolEllipse":b={type:"ellipse",cx:0,cy:0,rx:10,ry:5};break;default:return null}return{defaultShape:b,
fill:c.getFill(),stroke:c.getStroke()}},_repaintItems:function(){e.forEach(this._surfaceItems,function(c){this._repaint(c)},this)},_repaint:function(c){if(c){c.getStroke&&c.setStroke&&c.setStroke(c.getStroke());try{c.getFill&&c.setFill&&c.setFill(c.getFill())}catch(a){}c.children&&g.isArray(c.children)&&e.forEach(c.children,this._repaint,this)}},_createHoverAction:function(c,b,d,e){if(e=b._hoverLabel||b._hoverLabels&&b._hoverLabels[d.id]||e)e=v.encode(e),b.mouseMoveHandler=b.mouseMoveHandler||{},
b.mouseMoveHandler[d.id]=l.connect(c,"onmousemove",g.hitch(this,function(c,b){this.mouseX=b.clientX;this.mouseY=b.clientY;this.hoverLabelShowing&&(this.hoverLabelShowing=!1,s.set(r.byId(this.id+"_hoverLabel"),"display","none"));setTimeout(g.hitch(this,function(c,b,d){if(c==this.mouseX&&b==this.mouseY&&!this.hoverLabelShowing)if(this.hoverLabelShowing=!0,r.byId(this.id+"_hoverLabel")){var e=r.byId(this.id+"_hoverLabel");e.innerHTML="\x3cspan\x3e"+d+"\x3c/span\x3e";s.set(e,"top",b+"px");s.set(e,"left",
c+15+"px");s.set(e,"display","")}else a.create("div",{innerHTML:"\x3cspan\x3e"+d+"\x3c/span\x3e",id:this.id+"_hoverLabel","class":"esriLegendHoverLabel",style:{top:b+"px",left:c+15+"px"}},document.body)},b.clientX,b.clientY,c),500)},e)),b.mouseOutHandler=b.mouseOutHandler||{},b.mouseOutHandler[d.id]=l.connect(c,"onmouseout",g.hitch(this,function(c){this.mouseY=this.mouseX=-1;this.hoverLabelShowing&&(this.hoverLabelShowing=!1,s.set(r.byId(this.id+"_hoverLabel"),"display","none"))}))},_removeHoverHandlers:function(){var c;
e.forEach(this.layers,function(a){if(a.mouseMoveHandler)for(c in a.mouseMoveHandler)l.disconnect(a.mouseMoveHandler[c]);if(a.mouseOutHandler)for(c in a.mouseOutHandler)l.disconnect(a.mouseOutHandler[c])})},_createDynamicLayers:function(c){var a=[],b;e.forEach(c.dynamicLayerInfos||c.layerInfos,function(d){b={id:d.id};b.source=d.source&&d.source.toJson();var e;c.layerDefinitions&&c.layerDefinitions[d.id]&&(e=c.layerDefinitions[d.id]);e&&(b.definitionExpression=e);var f;c.layerDrawingOptions&&c.layerDrawingOptions[d.id]&&
(f=c.layerDrawingOptions[d.id]);f&&(b.drawingInfo=f.toJson());b.minScale=d.minScale||0;b.maxScale=d.maxScale||0;a.push(b)});return a},_getTemplateFromTypes:function(c,a){var b;for(b=0;b<c.length;b++)if(c[b].id==a&&c[b].templates&&0<c[b].templates.length)return c[b].templates[0];return null},_findParentGroup:function(c,a,b){var d,e=a.dynamicLayerInfos||a.layerInfos;for(d=0;d<e.length;d++)if(b==e[d].id){-1<e[d].parentLayerId&&(s.set(r.byId(this.id+"_"+c+"_"+e[d].parentLayerId+"_group"),"display","block"),
this._findParentGroup(c,a,e[d].parentLayerId));break}},_addSubLayersToHide:function(c){function a(b,d){var f=c.layer.dynamicLayerInfos||c.layer.layerInfos,g,h;for(g=0;g<f.length;g++)if(f[g].id===b&&f[g].subLayerIds)for(h=0;h<f[g].subLayerIds.length;h++){var l=f[g].subLayerIds[h];-1===e.indexOf(d,l)&&(d.push(l),a(l,d))}}c.layer.layerInfos&&e.forEach(this.hideLayersInLegend[c.layer.id],function(b){a(b,this.hideLayersInLegend[c.layer.id])},this)},_isLayerInScale:function(a,b,d){var e,f=!0;if(a.legendResponse&&
a.legendResponse.layers)for(e=0;e<a.legendResponse.layers.length;e++){var g=a.legendResponse.layers[e];if(b.id==g.layerId){var h,l;!a.minScale&&0!==a.minScale||!a.maxScale&&0!==a.maxScale?(0==g.minScale&&a.tileInfo&&(h=a.tileInfo.lods[0].scale),0==g.maxScale&&a.tileInfo&&(l=a.tileInfo.lods[a.tileInfo.lods.length-1].scale)):(h=Math.min(a.minScale,g.minScale)||a.minScale||g.minScale,l=Math.max(a.maxScale,g.maxScale));if(0<h&&h<d||l>d)f=!1;break}}else if(a.minScale||a.maxScale)if(a.minScale&&a.minScale<
d||a.maxScale&&a.maxScale>d)f=!1;return f},_getServiceTitle:function(a){var b=a._titleForLegend;b||((b=a.url)?-1<a.url.indexOf("/MapServer")?(b=a.url.substring(0,a.url.indexOf("/MapServer")),b=b.substring(b.lastIndexOf("/")+1,b.length)):-1<a.url.indexOf("/ImageServer")?(b=a.url.substring(0,a.url.indexOf("/ImageServer")),b=b.substring(b.lastIndexOf("/")+1,b.length)):-1<a.url.indexOf("/FeatureServer")&&(b=a.url.substring(0,a.url.indexOf("/FeatureServer")),b=b.substring(b.lastIndexOf("/")+1,b.length)):
b="",a.name&&(b=0<b.length?b+(" - "+a.name):a.name));"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass&&a.vectorFieldPixelFilter&&(a=a.vectorFieldPixelFilter.outputUnit?this["NLS_"+a.vectorFieldPixelFilter.outputUnit]:this["NLS_"+a.vectorFieldPixelFilter.inputUnit],H.isDefined(a)&&(b+=" ("+a+")"));return v.encode(b)},_getEffectiveScale:function(a,b){var d=b.minScale,e=b.maxScale;if(H.isDefined(b.parentLayerId)){var f=a.layerInfos,g=b.parentLayerId,h;for(h=f.length-1;0<=h;h--)if(f[h].id==
g)if(0==d&&0<f[h].minScale?d=f[h].minScale:0<d&&0==f[h].minScale||0<d&&0<f[h].minScale&&(d=Math.min(d,f[h].minScale)),e=Math.max(e||0,f[h].maxScale||0),-1<f[h].parentLayerId)g=f[h].parentLayerId;else break}return{minScale:d,maxScale:e}},_isSupportedLayerType:function(a){return a&&("esri.layers.ArcGISDynamicMapServiceLayer"===a.declaredClass||"esri.layers.ArcGISImageServiceLayer"===a.declaredClass&&10.2<=a.version||"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass||"esri.layers.ArcGISTiledMapServiceLayer"===
a.declaredClass||"esri.layers.FeatureLayer"===a.declaredClass||"esri.layers.StreamLayer"===a.declaredClass||"esri.layers.KMLLayer"===a.declaredClass||"esri.layers.GeoRSSLayer"===a.declaredClass||"esri.layers.WMSLayer"===a.declaredClass||"esri.layers.WFSLayer"===a.declaredClass||"esri.layers.CSVLayer"===a.declaredClass)?!0:!1}});g.mixin(K,{ALIGN_LEFT:0,ALIGN_RIGHT:1});b("extend-esri")&&g.setObject("dijit.Legend",K,L);return K});